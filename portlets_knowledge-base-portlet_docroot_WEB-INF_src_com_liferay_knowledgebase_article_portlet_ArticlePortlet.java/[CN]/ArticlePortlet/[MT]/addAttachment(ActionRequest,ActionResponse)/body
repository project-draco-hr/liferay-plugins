{
  UploadException uploadException=(UploadException)actionRequest.getAttribute(WebKeys.UPLOAD_EXCEPTION);
  if (uploadException != null) {
    if (uploadException.isExceededSizeLimit()) {
      throw new FileSizeException(uploadException.getCause());
    }
    throw new PortalException(uploadException.getCause());
  }
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  String portletId=PortalUtil.getPortletId(actionRequest);
  long resourcePrimKey=ParamUtil.getLong(uploadPortletRequest,"resourcePrimKey");
  String dirName=ParamUtil.getString(uploadPortletRequest,"dirName");
  String fileName=uploadPortletRequest.getFileName("file");
  InputStream inputStream=null;
  try {
    inputStream=uploadPortletRequest.getFileAsStream("file");
    ServiceContext serviceContext=ServiceContextFactory.getInstance(KBArticle.class.getName(),actionRequest);
    KBArticleServiceUtil.addAttachment(portletId,resourcePrimKey,dirName,fileName,inputStream,serviceContext);
  }
  finally {
    StreamUtil.cleanUp(inputStream);
  }
}
