{
  boolean directory=ParamUtil.getBoolean(resourceRequest,"directory");
  String keywords=DAOParamUtil.getLike(resourceRequest,"keywords");
  boolean userGroups=ParamUtil.getBoolean(resourceRequest,"userGroups");
  int start=ParamUtil.getInteger(resourceRequest,"start");
  int end=ParamUtil.getInteger(resourceRequest,"end");
  JSONObject jsonObject=JSONFactoryUtil.createJSONObject();
  JSONObject optionsJSONObject=JSONFactoryUtil.createJSONObject();
  optionsJSONObject.put("directory",directory);
  optionsJSONObject.put("keywords",keywords);
  optionsJSONObject.put("userGroups",userGroups);
  optionsJSONObject.put("start",start);
  optionsJSONObject.put("end",end);
  jsonObject.put("options",optionsJSONObject);
  ThemeDisplay themeDisplay=(ThemeDisplay)resourceRequest.getAttribute(WebKeys.THEME_DISPLAY);
  List<Group> groups=null;
  int count=0;
  if (directory) {
    LinkedHashMap<String,Object> params=new LinkedHashMap<String,Object>();
    if (userGroups) {
      params.put("usersGroups",themeDisplay.getUserId());
    }
 else {
      List<Integer> types=new ArrayList<Integer>();
      types.add(GroupConstants.TYPE_SITE_OPEN);
      types.add(GroupConstants.TYPE_SITE_RESTRICTED);
      params.put("types",types);
    }
    groups=GroupLocalServiceUtil.search(themeDisplay.getCompanyId(),keywords,null,params,start,end,new GroupNameComparator(true));
    count=GroupLocalServiceUtil.searchCount(themeDisplay.getCompanyId(),keywords,null,params);
  }
 else {
    groups=SitesUtil.getVisibleSites(themeDisplay.getCompanyId(),themeDisplay.getUserId(),keywords);
    count=SitesUtil.getVisibleSitesCount(themeDisplay.getCompanyId(),themeDisplay.getUserId(),keywords);
  }
  jsonObject.put("count",count);
  JSONArray jsonArray=JSONFactoryUtil.createJSONArray();
  for (  Group group : groups) {
    JSONObject groupJSONObject=JSONFactoryUtil.createJSONObject();
    groupJSONObject.put("name",group.getDescriptiveName());
    groupJSONObject.put("description",group.getDescription());
    if (group.hasPrivateLayouts() || group.hasPublicLayouts()) {
      PortletURL portletURL=PortletURLFactoryUtil.create(PortalUtil.getHttpServletRequest(resourceRequest),PortletKeys.MY_PLACES,themeDisplay.getLayout().getPlid(),PortletRequest.ACTION_PHASE);
      portletURL.setWindowState(WindowState.NORMAL);
      portletURL.setParameter("struts_action","/my_places/view");
      portletURL.setParameter("groupId",String.valueOf(group.getGroupId()));
      portletURL.setParameter("privateLayout",String.valueOf(!group.hasPublicLayouts()));
      groupJSONObject.put("url",portletURL.toString());
    }
    boolean socialOfficeEnabled=GetterUtil.getBoolean(group.getExpandoBridge().getAttribute("socialOfficeEnabled"));
    groupJSONObject.put("socialOfficeEnabled",socialOfficeEnabled);
    if (!GroupLocalServiceUtil.hasUserGroup(themeDisplay.getUserId(),group.getGroupId()) && GroupPermissionUtil.contains(themeDisplay.getPermissionChecker(),group.getGroupId(),ActionKeys.ASSIGN_MEMBERS)) {
      PortletURL portletURL=PortletURLFactoryUtil.create(PortalUtil.getHttpServletRequest(resourceRequest),PortletKeys.SITES_ADMIN,themeDisplay.getLayout().getPlid(),PortletRequest.ACTION_PHASE);
      portletURL.setWindowState(WindowState.NORMAL);
      portletURL.setParameter("struts_action","/sites_admin/edit_site_assignments");
      portletURL.setParameter(Constants.CMD,"group_users");
      portletURL.setParameter("redirect",themeDisplay.getURLCurrent());
      portletURL.setParameter("groupId",String.valueOf(group.getGroupId()));
      portletURL.setParameter("addUserIds",String.valueOf(themeDisplay.getUserId()));
      groupJSONObject.put("joinUrl",portletURL.toString());
    }
    jsonArray.put(groupJSONObject);
  }
  jsonObject.put("sites",jsonArray);
  HttpServletResponse response=PortalUtil.getHttpServletResponse(resourceResponse);
  ServletResponseUtil.write(response,jsonObject.toString());
}
