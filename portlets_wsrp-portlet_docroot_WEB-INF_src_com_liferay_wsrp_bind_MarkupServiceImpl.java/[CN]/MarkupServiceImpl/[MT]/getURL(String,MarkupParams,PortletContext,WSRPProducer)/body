{
  HttpServletRequest request=ServletUtil.getRequest();
  String portalURL=PortalUtil.getPortalURL(request);
  StringBuilder sb=new StringBuilder();
  sb.append(portalURL);
  sb.append(PortalUtil.getPathContext());
  sb.append(_PATH_WIDGET);
  Layout layout=getLayout(portletContext,wsrpProducer);
  sb.append("p_l_id=");
  sb.append(layout.getPlid());
  String portletId=getPortletId(portletContext);
  NavigationalContext navigationalContext=markupParams.getNavigationalContext();
  String opaqueValue=null;
  if (navigationalContext != null) {
    opaqueValue=navigationalContext.getOpaqueValue();
    Map<String,String[]> parameterMap=HttpUtil.parameterMapFromString(opaqueValue);
    if (parameterMap.containsKey(_STRUTS_ACTION_PORTLET_CONFIGURATION)) {
      portletId=PortletKeys.PORTLET_CONFIGURATION;
    }
  }
  sb.append("&p_p_id=");
  sb.append(HttpUtil.encodeURL(portletId));
  sb.append("&p_p_lifecycle=");
  sb.append(lifecycle);
  String windowState=getWindowState(markupParams);
  sb.append("&p_p_state=");
  sb.append(HttpUtil.encodeURL(windowState));
  String portletMode=getPortletMode(markupParams);
  sb.append("&p_p_mode=");
  sb.append(HttpUtil.encodeURL(portletMode));
  sb.append("&wsrp=1");
  if (Validator.isNotNull(opaqueValue)) {
    sb.append(StringPool.AMPERSAND);
    sb.append(opaqueValue);
  }
  if (_log.isInfoEnabled()) {
    _log.info("URL " + sb.toString());
  }
  return sb.toString();
}
