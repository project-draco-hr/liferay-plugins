{
  User user=userPersistence.findByPrimaryKey(userId);
  long groupId=serviceContext.getScopeGroupId();
  Date now=new Date();
  validate(title,content);
  long templateId=counterLocalService.increment();
  Template template=templatePersistence.create(templateId);
  template.setUuid(uuid);
  template.setGroupId(groupId);
  template.setCompanyId(user.getCompanyId());
  template.setUserId(user.getUserId());
  template.setUserName(user.getFullName());
  template.setCreateDate(serviceContext.getCreateDate(now));
  template.setModifiedDate(serviceContext.getModifiedDate(now));
  template.setTitle(title);
  template.setContent(content);
  template.setDescription(description);
  templatePersistence.update(template,false);
  if (serviceContext.getAddCommunityPermissions() || serviceContext.getAddGuestPermissions()) {
    addTemplateResources(template,serviceContext.getAddCommunityPermissions(),serviceContext.getAddGuestPermissions());
  }
 else {
    addTemplateResources(template,serviceContext.getCommunityPermissions(),serviceContext.getGuestPermissions());
  }
  mbMessageLocalService.addDiscussionMessage(userId,template.getUserName(),groupId,Template.class.getName(),templateId,WorkflowConstants.ACTION_PUBLISH);
  socialActivityLocalService.addActivity(userId,groupId,Template.class.getName(),templateId,AdminActivityKeys.ADD_TEMPLATE,StringPool.BLANK,0);
  return template;
}
