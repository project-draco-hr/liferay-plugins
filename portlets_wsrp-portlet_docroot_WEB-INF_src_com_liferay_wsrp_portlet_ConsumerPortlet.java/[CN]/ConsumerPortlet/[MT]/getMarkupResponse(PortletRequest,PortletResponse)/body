{
  PortletSession portletSession=portletRequest.getPortletSession();
  WSRPConsumerPortlet wsrpConsumerPortlet=getWSRPConsumerPortlet();
  WSRPConsumer wsrpConsumer=WSRPConsumerLocalServiceUtil.getWSRPConsumer(wsrpConsumerPortlet.getWsrpConsumerId());
  WSRPConsumerManager wsrpConsumerManager=WSRPConsumerManagerFactory.getWSRPConsumerManager(wsrpConsumer);
  MarkupParams markupParams=new MarkupParams();
  PortletContext portletContext=new PortletContext();
  RuntimeContext runtimeContext=new RuntimeContext();
  UserContext userContext=new UserContext();
  initContexts(portletRequest,portletResponse,wsrpConsumerPortlet,wsrpConsumerManager,markupParams,portletContext,runtimeContext,userContext);
  GetMarkup getMarkup=new GetMarkup();
  getMarkup.setMarkupParams(markupParams);
  PortletContext existingPortletContext=(PortletContext)portletSession.getAttribute(WebKeys.PORTLET_CONTEXT);
  if (existingPortletContext != null) {
    getMarkup.setPortletContext(existingPortletContext);
  }
 else {
    getMarkup.setPortletContext(portletContext);
  }
  getMarkup.setRegistrationContext(wsrpConsumer.getRegistrationContext());
  getMarkup.setRuntimeContext(runtimeContext);
  getMarkup.setUserContext(userContext);
  WSRP_v2_Markup_PortType markupService=getMarkupService(portletRequest,wsrpConsumerManager,wsrpConsumer);
  MarkupResponse markupResponse=markupService.getMarkup(getMarkup);
  processMarkupResponse(portletRequest,portletResponse,markupResponse);
  return markupResponse;
}
