{
  PortletSession portletSession=resourceRequest.getPortletSession();
  PortletContext portletContext=wsrpResourceResponse.getPortletContext();
  if (portletContext != null) {
    portletSession.setAttribute(WebKeys.PORTLET_CONTEXT,portletContext);
  }
  SessionContext sessionContext=wsrpResourceResponse.getSessionContext();
  if (sessionContext != null) {
    portletSession.setAttribute(WebKeys.SESSION_CONTEXT,sessionContext);
  }
  ResourceContext resourceContext=wsrpResourceResponse.getResourceContext();
  String charSet=StringPool.UTF8;
  String contentType=resourceContext.getMimeType();
  if (Validator.isNotNull(contentType)) {
    resourceResponse.setContentType(contentType);
    int x=contentType.indexOf("charset=");
    if (x >= 0) {
      charSet=contentType.substring(x + 8).trim();
    }
  }
  String itemString=resourceContext.getItemString();
  byte[] itemBinary=resourceContext.getItemBinary();
  if (ParamUtil.getBoolean(resourceRequest,"wsrp-requiresRewrite") || resourceContext.getRequiresRewriting()) {
    if (itemBinary != null) {
      itemString=new String(itemBinary,charSet);
    }
    itemString=rewriteURLs(resourceResponse,itemString);
  }
  if (Validator.isNotNull(itemString)) {
    resourceResponse.setContentLength(itemString.length());
    PortletResponseUtil.write(resourceResponse,itemString);
  }
 else   if (itemBinary != null) {
    resourceResponse.setContentLength(itemBinary.length);
    PortletResponseUtil.write(resourceResponse,itemBinary);
  }
}
