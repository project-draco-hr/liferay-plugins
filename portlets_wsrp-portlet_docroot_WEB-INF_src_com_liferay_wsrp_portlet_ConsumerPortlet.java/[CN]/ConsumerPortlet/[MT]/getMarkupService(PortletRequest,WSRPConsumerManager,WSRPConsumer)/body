{
  PortletSession portletSession=portletRequest.getPortletSession();
  TransientValue<WSRP_v2_Markup_PortType> markupServiceTransientValue=(TransientValue<WSRP_v2_Markup_PortType>)portletSession.getAttribute(WebKeys.MARKUP_SERVICE,PortletSession.APPLICATION_SCOPE);
  if ((markupServiceTransientValue == null) || (markupServiceTransientValue.isNull())) {
    WSRP_v2_Markup_PortType markupService=wsrpConsumerManager.getMarkupService();
    markupServiceTransientValue=new TransientValue<WSRP_v2_Markup_PortType>(markupService);
    ServiceDescription serviceDescription=wsrpConsumerManager.getServiceDescription();
    String cookie=(String)portletSession.getAttribute(WebKeys.COOKIE);
    CookieProtocol cookieProtocol=serviceDescription.getRequiresInitCookie();
    if ((cookie == null) && (cookieProtocol != null)) {
      String cookieProtocolValue=cookieProtocol.getValue();
      if (cookieProtocolValue.equals(CookieProtocol._perGroup) || cookieProtocolValue.equals(CookieProtocol._perUser)) {
        InitCookie initCookie=new InitCookie();
        initCookie.setRegistrationContext(wsrpConsumer.getRegistrationContext());
        markupService.initCookie(initCookie);
        cookie=SimpleHTTPSender.getCurrentCookie();
        portletSession.setAttribute(WebKeys.COOKIE,cookie,PortletSession.APPLICATION_SCOPE);
      }
    }
    portletSession.setAttribute(WebKeys.MARKUP_SERVICE,markupServiceTransientValue,PortletSession.APPLICATION_SCOPE);
  }
  return markupServiceTransientValue.getValue();
}
