{
  ThemeDisplay themeDisplay=(ThemeDisplay)renderRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String portletName=getPortletConfig().getPortletName();
  long wsrpConsumerPortletId=GetterUtil.getLong(portletName.substring(PORTLET_NAME_PREFIX.length()));
  WSRPConsumerPortlet wsrpConsumerPortlet=WSRPConsumerPortletLocalServiceUtil.getWSRPConsumerPortlet(wsrpConsumerPortletId);
  WSRPConsumer wsrpConsumer=WSRPConsumerLocalServiceUtil.getWSRPConsumer(wsrpConsumerPortlet.getWsrpConsumerId());
  WSRPConsumerManager wsrpConsumerManager=WSRPConsumerManagerFactory.getWSRPConsumerManager(wsrpConsumer);
  GetMarkup getMarkup=new GetMarkup();
  MarkupParams markupParams=new MarkupParams();
  List<Locale> locales=Collections.list(renderRequest.getLocales());
  String[] localesArray=new String[locales.size()];
  for (int i=0; i < locales.size(); i++) {
    Locale locale=locales.get(i);
    localesArray[i]=locale.toString();
  }
  markupParams.setLocales(localesArray);
  markupParams.setMarkupCharacterSets(new String[]{StringPool.UTF8});
  markupParams.setMimeTypes(new String[]{ContentTypes.TEXT_HTML});
  markupParams.setMode("wsrp:view");
  markupParams.setValidNewModes(new String[]{"wsrp:view"});
  markupParams.setValidNewWindowStates(new String[]{"wsrp:maximized","wsrp:minimized","wsrp:normal"});
  markupParams.setWindowState("wsrp:normal");
  getMarkup.setMarkupParams(markupParams);
  NavigationalContext navigationalContext=new NavigationalContext();
  String navigationalState=renderRequest.getParameter("wsrp-navigationalState");
  navigationalContext.setOpaqueValue(navigationalState);
  markupParams.setNavigationalContext(navigationalContext);
  PortletContext portletContext=new PortletContext();
  portletContext.setPortletHandle(wsrpConsumerPortlet.getPortletHandle());
  getMarkup.setPortletContext(portletContext);
  RuntimeContext runtimeContext=new RuntimeContext();
  runtimeContext.setNamespacePrefix(renderResponse.getNamespace());
  runtimeContext.setPortletInstanceKey(renderResponse.getNamespace());
  runtimeContext.setUserAuthentication("wsrp:user");
  getMarkup.setRuntimeContext(runtimeContext);
  UserContext userContext=new UserContext();
  userContext.setUserCategories(new String[]{RoleConstants.USER});
  userContext.setUserContextKey(String.valueOf(themeDisplay.getUserId()));
  getMarkup.setUserContext(userContext);
  WSRP_v2_Markup_PortType markupService=getMarkupService(renderRequest,wsrpConsumerManager);
  MarkupResponse markupResponse=markupService.getMarkup(getMarkup);
  return markupResponse;
}
