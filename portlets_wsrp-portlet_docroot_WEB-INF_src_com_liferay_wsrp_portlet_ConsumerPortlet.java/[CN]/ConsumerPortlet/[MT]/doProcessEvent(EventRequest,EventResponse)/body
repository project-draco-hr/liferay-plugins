{
  WSRPConsumerPortlet wsrpConsumerPortlet=getWSRPConsumerPortlet();
  WSRPConsumer wsrpConsumer=WSRPConsumerLocalServiceUtil.getWSRPConsumer(wsrpConsumerPortlet.getWsrpConsumerId());
  String userToken=WSRPConsumerManager.getUserToken(eventRequest);
  WSRPConsumerManager wsrpConsumerManager=WSRPConsumerManagerFactory.getWSRPConsumerManager(wsrpConsumer,userToken);
  EventParams eventParams=new EventParams();
  MarkupParams markupParams=new MarkupParams();
  PortletContext portletContext=new PortletContext();
  RuntimeContext runtimeContext=new RuntimeContext();
  UserContext userContext=new UserContext();
  initContexts(eventRequest,eventResponse,wsrpConsumerPortlet,wsrpConsumerManager,eventParams,markupParams,portletContext,runtimeContext,userContext);
  HandleEvents handleEvents=new HandleEvents();
  handleEvents.setEventParams(eventParams);
  handleEvents.setMarkupParams(markupParams);
  handleEvents.setPortletContext(portletContext);
  handleEvents.setRegistrationContext(wsrpConsumer.getRegistrationContext());
  handleEvents.setRuntimeContext(runtimeContext);
  handleEvents.setUserContext(userContext);
  WSRP_v2_Markup_PortType markupService=getMarkupService(eventRequest,wsrpConsumerManager,wsrpConsumer);
  HandleEventsResponse handleEventsResponse=markupService.handleEvents(handleEvents);
  processHandleEventsResponse(eventRequest,eventResponse,wsrpConsumerManager,handleEventsResponse);
}
