{
  PortletSession portletSession=renderRequest.getPortletSession();
  ThemeDisplay themeDisplay=(ThemeDisplay)renderRequest.getAttribute(WebKeys.THEME_DISPLAY);
  MarkupContext markupContext=(MarkupContext)portletSession.getAttribute(WebKeys.MARKUP_CONTEXT);
  if (markupContext != null) {
    portletSession.removeAttribute(WebKeys.MARKUP_CONTEXT);
  }
 else {
    MarkupResponse markupResponse=getMarkupResponse(renderRequest,renderResponse);
    markupContext=markupResponse.getMarkupContext();
  }
  MessageElement[] messageElements=ExtensionUtil.getMessageElements(markupContext.getExtensions());
  if ((messageElements != null) && (messageElements.length > 0)) {
    MessageElement messageElement=messageElements[0];
    if (messageElement.getName().equals("configurationURL")) {
      PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
      String configurationURL=messageElement.getValue();
      configurationURL=rewriteURLs(renderResponse,configurationURL);
      portletDisplay.setURLConfiguration(configurationURL);
    }
  }
  renderResponse.setContentType(ContentTypes.TEXT_HTML_UTF8);
  String content=rewriteURLs(renderResponse,markupContext.getItemString());
  PortletResponseUtil.write(renderResponse,content);
}
