{
  PortletSession portletSession=renderRequest.getPortletSession();
  MarkupContext markupContext=(MarkupContext)portletSession.getAttribute(WebKeys.MARKUP_CONTEXT);
  if (markupContext != null) {
    portletSession.removeAttribute(WebKeys.MARKUP_CONTEXT);
  }
 else {
    MarkupResponse markupResponse=getMarkupResponse(renderRequest,renderResponse);
    markupContext=markupResponse.getMarkupContext();
  }
  renderResponse.setContentType(ContentTypes.TEXT_HTML_UTF8);
  String content=rewriteURLs(renderResponse,markupContext.getItemString());
  PortletResponseUtil.write(renderResponse,content);
}
