{
  PortletSession portletSession=renderRequest.getPortletSession();
  MarkupContext markupContext=(MarkupContext)portletSession.getAttribute(_MARKUP_CONTEXT);
  if (markupContext != null) {
    portletSession.removeAttribute(_MARKUP_CONTEXT);
  }
 else {
    MarkupResponse markupResponse=getMarkupResponse(renderRequest,renderResponse);
    markupContext=markupResponse.getMarkupContext();
  }
  renderResponse.setContentType(ContentTypes.TEXT_HTML_UTF8);
  String content=rewriteURLs(markupContext.getItemString(),renderResponse);
  PortletResponseUtil.write(renderResponse,content);
}
