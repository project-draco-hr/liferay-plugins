{
  ResourceRetriever resourceRetriever=workflowDefinition.getJar();
  String name=workflowDefinition.getWorkflowDefinitionName();
  int version=workflowDefinition.getWorkflowDefinitionVersion();
  if (!autoIncrementVersionNumber && (version < 0)) {
    throw new WorkflowException("Workflow definition version number must be a positive number");
  }
  ProcessDefinition processDefinition=null;
  ZipInputStream processStream=new ZipInputStream(resourceRetriever.getInputStream());
  try {
    ProcessArchive processArchive=new ProcessArchive(processStream);
    processDefinition=processArchive.parseProcessDefinition();
  }
 catch (  IOException ioe) {
    throw new WorkflowException(ioe);
  }
 finally {
    try {
      processStream.close();
    }
 catch (    IOException ioe) {
    }
  }
  if (Validator.isNotNull(name)) {
    processDefinition.setName(name);
  }
  if (!autoIncrementVersionNumber) {
    processDefinition.setVersion(version);
  }
  JbpmContext jbpmContext=_jbpmConfiguration.createJbpmContext();
  try {
    if (!autoIncrementVersionNumber) {
      GraphSession graphSession=jbpmContext.getGraphSession();
      ProcessDefinition oldProcessDefinition=graphSession.findProcessDefinition(name,version);
      if (oldProcessDefinition != null) {
        graphSession.deleteProcessDefinition(oldProcessDefinition);
      }
      graphSession.saveProcessDefinition(processDefinition);
    }
 else {
      jbpmContext.deployProcessDefinition(processDefinition);
    }
  }
  finally {
    jbpmContext.close();
  }
}
