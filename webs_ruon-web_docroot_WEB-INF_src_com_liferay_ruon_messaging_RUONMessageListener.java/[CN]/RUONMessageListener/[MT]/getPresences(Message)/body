{
  long userId=message.getLong("userId");
  boolean online=true;
  Locale locale=(Locale)message.get("locale");
  List<Presence> presences=PresenceLocalServiceUtil.getPresences(userId,online);
  JSONObject payloadJSON=JSONFactoryUtil.createJSONObject();
  JSONArray presencesJSON=JSONFactoryUtil.createJSONArray();
  payloadJSON.put("presencesJSON",presencesJSON);
  for (  Presence presence : presences) {
    Converter converter=_converters.get(presence.getNetworkId());
    if (converter == null) {
      continue;
    }
    Map<String,Object> input=new HashMap<String,Object>();
    input.put("userId",userId);
    input.put("online",online);
    input.put("locale",locale);
    Object output=converter.convert(input);
    JSONObject presenceJSON=JSONFactoryUtil.createJSONObject();
    presenceJSON.put("userId",userId);
    presenceJSON.put("online",online);
    presenceJSON.put("output",String.valueOf(output));
    presencesJSON.put(presenceJSON);
  }
  message.setPayload(payloadJSON);
  MessageBusUtil.sendMessage(message.getResponseDestination(),message);
}
