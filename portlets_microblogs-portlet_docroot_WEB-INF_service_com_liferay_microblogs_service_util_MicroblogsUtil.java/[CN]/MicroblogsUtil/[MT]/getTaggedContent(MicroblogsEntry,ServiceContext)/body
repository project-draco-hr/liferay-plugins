{
  String content=HtmlUtil.escape(microblogsEntry.getContent());
  ThemeDisplay themeDisplay=serviceContext.getThemeDisplay();
  Pattern pattern=Pattern.compile("\\#\\S*");
  Matcher matcher=pattern.matcher(microblogsEntry.getContent());
  while (matcher.find()) {
    String result=matcher.group();
    String assetTagName=result.substring(1);
    PortletURL portletURL=null;
    long userId=themeDisplay.getUserId();
    Group group=GroupLocalServiceUtil.getUserGroup(themeDisplay.getCompanyId(),userId);
    long portletPlid=PortalUtil.getPlidFromPortletId(group.getGroupId(),true,"1_WAR_microblogsportlet");
    if (portletPlid != 0) {
      portletURL=PortletURLFactoryUtil.create(serviceContext.getLiferayPortletRequest(),"1_WAR_microblogsportlet",portletPlid,PortletRequest.RENDER_PHASE);
      try {
        portletURL.setWindowState(LiferayWindowState.NORMAL);
      }
 catch (      WindowStateException wse) {
      }
    }
 else {
      LiferayPortletResponse liferayPortletResponse=serviceContext.getLiferayPortletResponse();
      portletURL=liferayPortletResponse.createRenderURL("1_WAR_microblogsportlet");
      try {
        portletURL.setWindowState(WindowState.MAXIMIZED);
      }
 catch (      WindowStateException wse) {
      }
    }
    portletURL.setParameter("mvcPath","/microblogs/view.jsp");
    portletURL.setParameter("tabs1",assetTagName);
    portletURL.setParameter("assetTagName",assetTagName);
    StringBuilder sb=new StringBuilder(5);
    sb.append("<a href=\"");
    sb.append(portletURL);
    sb.append("\">");
    sb.append(assetTagName);
    sb.append("</a>");
    String tagLink=sb.toString();
    content=StringUtil.replace(content,result,tagLink);
  }
  pattern=Pattern.compile("\\[\\@\\S*\\]");
  matcher=pattern.matcher(content);
  while (matcher.find()) {
    String result=matcher.group();
    String assetTagName=result.replace("[@",StringPool.BLANK);
    assetTagName=assetTagName.replace("]",StringPool.BLANK);
    try {
      User taggedUser=UserLocalServiceUtil.getUserByScreenName(microblogsEntry.getCompanyId(),assetTagName);
      assetTagName=PortalUtil.getUserName(taggedUser.getUserId(),assetTagName);
      StringBuilder sb=new StringBuilder(5);
      sb.append("<a href=\"");
      sb.append(taggedUser.getDisplayURL(themeDisplay));
      sb.append("\">");
      sb.append(assetTagName);
      sb.append("</a>");
      String userLink=sb.toString();
      content=StringUtil.replace(content,result,userLink);
    }
 catch (    NoSuchUserException nsue) {
    }
  }
  return content;
}
