{
  if (_apnsService == null) {
    ApnsServiceBuilder appleServiceBuilder=APNS.newService();
    String path=PrefsPropsUtil.getString(PortletPropsKeys.APPLE_CERTIFICATE_PATH,PortletPropsValues.APPLE_CERTIFICATE_PATH);
    if (Validator.isNull(path)) {
      throw new PushNotificationsException("The property \"apple.certificate.path\" is not set in " + "portlet.properties");
    }
    InputStream is=null;
    try {
      is=new FileInputStream(path);
    }
 catch (    FileNotFoundException fnfe) {
      Class<?> clazz=getClass();
      ClassLoader classLoader=clazz.getClassLoader();
      is=classLoader.getResourceAsStream(path);
    }
    if (is == null) {
      throw new PushNotificationsException("Apple certificate does not exist at " + path);
    }
    String password=PrefsPropsUtil.getString(PortletPropsKeys.APPLE_CERTIFICATE_PASSWORD,PortletPropsValues.APPLE_CERTIFICATE_PASSWORD);
    if (Validator.isNull(password)) {
      throw new PushNotificationsException("The property \"apple.certificate.password\" is not set " + "in portlet.properties");
    }
    appleServiceBuilder.withCert(is,password);
    boolean sandbox=PrefsPropsUtil.getBoolean(PortletPropsKeys.APPLE_SANDBOX,PortletPropsValues.APPLE_SANDBOX);
    if (sandbox) {
      appleServiceBuilder.withSandboxDestination();
    }
 else {
      appleServiceBuilder.withProductionDestination();
    }
    _apnsService=appleServiceBuilder.build();
  }
  return _apnsService;
}
