{
  long userId=PrincipalThreadLocal.getUserId();
  User user=UserLocalServiceUtil.getUser(userId);
  if (user.isDefaultUser()) {
    throw new PrincipalException("User is not authenticated");
  }
  GoogleCredential.Builder builder=new GoogleCredential.Builder();
  String googleClientId=PrefsPropsUtil.getString(user.getCompanyId(),"google-client-id");
  String googleClientSecret=PrefsPropsUtil.getString(user.getCompanyId(),"google-client-secret");
  builder.setClientSecrets(googleClientId,googleClientSecret);
  JacksonFactory jsonFactory=new JacksonFactory();
  builder.setJsonFactory(jsonFactory);
  HttpTransport httpTransport=new NetHttpTransport();
  builder.setTransport(httpTransport);
  GoogleCredential googleCredential=builder.build();
  ExpandoBridge expandoBridge=user.getExpandoBridge();
  String googleAccessToken=GetterUtil.getString(expandoBridge.getAttribute("googleAccessToken",false));
  googleCredential.setAccessToken(googleAccessToken);
  String googleRefreshToken=GetterUtil.getString(expandoBridge.getAttribute("googleRefreshToken",false));
  googleCredential.setRefreshToken(googleRefreshToken);
  Drive.Builder driveBuilder=new Drive.Builder(httpTransport,jsonFactory,googleCredential);
  Drive drive=driveBuilder.build();
  Drive.About driveAbout=drive.about();
  Drive.About.Get driveAboutGet=driveAbout.get();
  About about=driveAboutGet.execute();
  return new GoogleDriveSession(drive,about.getRootFolderId());
}
