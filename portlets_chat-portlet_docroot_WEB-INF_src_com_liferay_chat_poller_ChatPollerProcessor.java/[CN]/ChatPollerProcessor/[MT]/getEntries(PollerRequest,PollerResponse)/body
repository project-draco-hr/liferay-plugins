{
  Status status=StatusLocalServiceUtil.getUserStatus(pollerRequest.getUserId());
  long createDate=-1;
  if (pollerRequest.isInitialRequest()) {
    createDate=status.getModifiedDate() - Time.DAY;
  }
  List<Entry> entries=EntryLocalServiceUtil.getNewEntries(pollerRequest.getUserId(),createDate,0,PortletPropsValues.BUDDY_LIST_MAX_BUDDIES);
  entries=ListUtil.copy(entries);
  Collections.reverse(entries);
  JSONArray entriesJSON=JSONFactoryUtil.createJSONArray();
  for (  Entry entry : entries) {
    JSONObject entryJSON=JSONFactoryUtil.createJSONObject();
    entryJSON.put("entryId",entry.getEntryId());
    entryJSON.put("createDate",entry.getCreateDate());
    entryJSON.put("fromUserId",entry.getFromUserId());
    if (entry.getFromUserId() != pollerRequest.getUserId()) {
      try {
        User fromUser=UserLocalServiceUtil.getUserById(entry.getFromUserId());
        entryJSON.put("fromFullName",fromUser.getFullName());
        entryJSON.put("fromPortraitId",fromUser.getPortraitId());
      }
 catch (      NoSuchUserException nsue) {
        continue;
      }
    }
    entryJSON.put("toUserId",entry.getToUserId());
    entryJSON.put("content",HtmlUtil.escape(entry.getContent()));
    entryJSON.put("flag",entry.getFlag());
    entriesJSON.put(entryJSON);
  }
  pollerResponse.setParameter("entries",entriesJSON);
  if (!entries.isEmpty()) {
    pollerResponse.setParameter(PollerResponse.POLLER_HINT_HIGH_CONNECTIVITY,Boolean.TRUE.toString());
  }
  boolean updatePresence=getBoolean(pollerRequest,"updatePresence");
  if (updatePresence) {
  }
 else   if (!entries.isEmpty()) {
    updatePresence=true;
  }
 else {
    long onlineTimestamp=status.getModifiedDate() + ChatConstants.ONLINE_DELTA - ChatConstants.MAX_POLL_LATENCY;
    if (onlineTimestamp < pollerRequest.getTimestamp()) {
      updatePresence=true;
    }
  }
  if (updatePresence) {
    StatusLocalServiceUtil.updateStatus(pollerRequest.getUserId(),pollerRequest.getTimestamp());
  }
}
