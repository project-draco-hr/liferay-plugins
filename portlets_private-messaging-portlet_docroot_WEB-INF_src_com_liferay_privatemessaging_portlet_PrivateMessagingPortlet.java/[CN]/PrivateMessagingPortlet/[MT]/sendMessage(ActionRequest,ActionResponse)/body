{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  UploadPortletRequest uploadRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  long userId=ParamUtil.getLong(uploadRequest,"userId");
  long mbThreadId=ParamUtil.getLong(uploadRequest,"mbThreadId");
  String to=ParamUtil.getString(uploadRequest,"to");
  String subject=ParamUtil.getString(uploadRequest,"subject");
  String body=ParamUtil.getString(uploadRequest,"body");
  List<ObjectValuePair<String,File>> files=new ArrayList<ObjectValuePair<String,File>>();
  for (int i=1; i <= 3; i++) {
    File file=uploadRequest.getFile("msgFile" + i);
    String fileName=uploadRequest.getFileName("msgFile" + i);
    try {
      if ((file != null) && (file.length() > 0)) {
        ObjectValuePair<String,File> ovp=new ObjectValuePair<String,File>(fileName,file);
        files.add(ovp);
      }
    }
 catch (    Exception e) {
      _log.error("unable to attach file " + fileName,e);
    }
  }
  UserThreadLocalServiceUtil.addPrivateMessage(userId,mbThreadId,to,subject,body,files,themeDisplay);
}
