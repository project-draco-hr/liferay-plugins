{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  long userId=ParamUtil.getLong(uploadPortletRequest,"userId");
  long mbThreadId=ParamUtil.getLong(uploadPortletRequest,"mbThreadId");
  String to=ParamUtil.getString(uploadPortletRequest,"to");
  String subject=ParamUtil.getString(uploadPortletRequest,"subject");
  String body=ParamUtil.getString(uploadPortletRequest,"body");
  List<ObjectValuePair<String,File>> files=new ArrayList<ObjectValuePair<String,File>>();
  for (int i=1; i <= 3; i++) {
    File file=uploadPortletRequest.getFile("msgFile" + i);
    String fileName=uploadPortletRequest.getFileName("msgFile" + i);
    try {
      if ((file != null) && (file.length() > 0)) {
        ObjectValuePair<String,File> ovp=new ObjectValuePair<String,File>(fileName,file);
        files.add(ovp);
      }
    }
 catch (    Exception e) {
      _log.error("unable to attach file " + fileName,e);
    }
  }
  UserThreadLocalServiceUtil.addPrivateMessage(userId,mbThreadId,to,subject,body,files,themeDisplay);
}
