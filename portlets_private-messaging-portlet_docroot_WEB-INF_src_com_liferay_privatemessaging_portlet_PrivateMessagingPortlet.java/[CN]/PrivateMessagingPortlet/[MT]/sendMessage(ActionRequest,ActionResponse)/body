{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  UploadPortletRequest uploadRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  long userId=ParamUtil.getLong(uploadRequest,"userId");
  long mbThreadId=ParamUtil.getLong(uploadRequest,"mbThreadId");
  String to=ParamUtil.getString(uploadRequest,"to");
  String subject=ParamUtil.getString(uploadRequest,"subject");
  String body=ParamUtil.getString(uploadRequest,"body");
  List<ObjectValuePair<String,byte[]>> files=new ArrayList<ObjectValuePair<String,byte[]>>();
  for (int i=1; i <= 3; i++) {
    File file=uploadRequest.getFile("msgFile" + i);
    String fileName=uploadRequest.getFileName("msgFile" + i);
    try {
      byte[] bytes=FileUtil.getBytes(file);
      if ((bytes != null) && (bytes.length > 0)) {
        ObjectValuePair<String,byte[]> ovp=new ObjectValuePair<String,byte[]>(fileName,bytes);
        files.add(ovp);
      }
    }
 catch (    IOException ioe) {
      _log.error("unable to attach file " + fileName,ioe);
    }
  }
  UserThreadLocalServiceUtil.addPrivateMessage(userId,mbThreadId,to,subject,body,files,themeDisplay);
}
