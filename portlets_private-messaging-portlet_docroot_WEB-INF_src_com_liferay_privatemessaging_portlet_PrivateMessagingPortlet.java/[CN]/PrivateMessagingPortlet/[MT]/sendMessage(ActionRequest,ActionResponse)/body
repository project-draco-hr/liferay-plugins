{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  long userId=ParamUtil.getLong(uploadPortletRequest,"userId");
  long mbThreadId=ParamUtil.getLong(uploadPortletRequest,"mbThreadId");
  String to=ParamUtil.getString(uploadPortletRequest,"to");
  String subject=ParamUtil.getString(uploadPortletRequest,"subject");
  String body=ParamUtil.getString(uploadPortletRequest,"body");
  List<ObjectValuePair<String,InputStream>> attachments=new ArrayList<ObjectValuePair<String,InputStream>>();
  try {
    for (int i=1; i <= 3; i++) {
      InputStream inputStream=uploadPortletRequest.getFileAsStream("msgFile" + i);
      String fileName=uploadPortletRequest.getFileName("msgFile" + i);
      try {
        if (inputStream != null) {
          ObjectValuePair<String,InputStream> ovp=new ObjectValuePair<String,InputStream>(fileName,inputStream);
          attachments.add(ovp);
        }
      }
 catch (      Exception e) {
        _log.error("unable to attach file " + fileName,e);
      }
    }
    UserThreadLocalServiceUtil.addPrivateMessage(userId,mbThreadId,to,subject,body,attachments,themeDisplay);
  }
 catch (  IOException ie) {
    throw new PortalException("Unable to process attachment",ie);
  }
 finally {
    for (    ObjectValuePair<String,InputStream> attachment : attachments) {
      InputStream inputStream=attachment.getValue();
      StreamUtil.cleanUp(inputStream);
    }
  }
}
