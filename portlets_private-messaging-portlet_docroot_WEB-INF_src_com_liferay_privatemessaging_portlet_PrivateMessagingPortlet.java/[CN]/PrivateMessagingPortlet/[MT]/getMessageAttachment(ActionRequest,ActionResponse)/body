{
  try {
    ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
    long messageId=ParamUtil.getLong(actionRequest,"messageId");
    String fileName=ParamUtil.getString(actionRequest,"attachment");
    MBMessage message=MBMessageLocalServiceUtil.getMessage(messageId);
    if (!PrivateMessagingUtil.isUserPartOfThread(themeDisplay.getUserId(),message.getThreadId())) {
      throw new PrincipalException();
    }
    HttpServletRequest request=PortalUtil.getHttpServletRequest(actionRequest);
    HttpServletResponse response=PortalUtil.getHttpServletResponse(actionResponse);
    FileEntry fileEntry=PortletFileRepositoryUtil.getPortletFileEntry(message.getGroupId(),message.getAttachmentsFolderId(),fileName);
    ServletResponseUtil.sendFile(request,response,fileName,fileEntry.getContentStream(),fileEntry.getSize(),fileEntry.getMimeType());
  }
 catch (  Exception e) {
    PortalUtil.sendError(e,actionRequest,actionResponse);
  }
}
