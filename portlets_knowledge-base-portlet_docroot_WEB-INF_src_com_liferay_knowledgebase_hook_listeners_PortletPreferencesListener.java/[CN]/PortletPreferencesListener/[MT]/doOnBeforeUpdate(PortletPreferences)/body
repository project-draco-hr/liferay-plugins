{
  String rootPortletId=PortletConstants.getRootPortletId(preferences.getPortletId());
  if (!rootPortletId.equals(PortletKeys.KNOWLEDGE_BASE_AGGREGATOR) && !rootPortletId.equals(PortletKeys.KNOWLEDGE_BASE_DISPLAY) && !rootPortletId.equals(PortletKeys.KNOWLEDGE_BASE_LIST)&& !rootPortletId.equals(PortletKeys.KNOWLEDGE_BASE_SEARCH)) {
    return;
  }
  Layout layout=LayoutLocalServiceUtil.getLayout(preferences.getPlid());
  List<ExpandoValue> expandoValues=ArticleLocalServiceUtil.getExpandoValues(layout.getCompanyId(),preferences.getPlid(),preferences.getPortletId());
  List<Long> validResourcePrimKeys=new ArrayList<Long>();
  List<AssetEntry> assetEntries=KnowledgeBaseUtil.getAssetEntries(preferences.getPlid(),preferences.getPortletId(),0,null);
  for (  ExpandoValue expandoValue : expandoValues) {
    String[] portletPrimKeys=expandoValue.getStringArray();
    String portletPrimKey=ArticleConstants.getPortletPrimKey(preferences.getPlid(),preferences.getPortletId());
    if (!ArrayUtil.contains(portletPrimKeys,portletPrimKey)) {
      continue;
    }
    Subscription subscription=SubscriptionLocalServiceUtil.getSubscription(expandoValue.getClassPK());
    try {
      ArticleLocalServiceUtil.getLatestArticle(subscription.getClassPK(),WorkflowConstants.STATUS_ANY);
    }
 catch (    NoSuchArticleException nsae) {
      continue;
    }
    if (validResourcePrimKeys.contains(subscription.getClassPK())) {
      continue;
    }
    if (hasArticle(subscription.getClassPK(),assetEntries,preferences)) {
      validResourcePrimKeys.add(subscription.getClassPK());
      continue;
    }
    ArticleLocalServiceUtil.unsubscribeArticle(subscription.getCompanyId(),subscription.getUserId(),subscription.getClassPK());
  }
}
