{
  Company company=PortalUtil.getCompany(request);
  CompanyThreadLocal.setCompanyId(company.getCompanyId());
  String imagePath=PortalUtil.getPathImage();
  String companyLogo=imagePath + "/company_logo?img_id=" + company.getLogoId()+ "&t="+ ImageServletTokenUtil.getToken(company.getLogoId());
  PrincipalThreadLocal.setName(String.valueOf(user.getUserId()));
  PermissionChecker permissionChecker=PermissionCheckerFactoryUtil.create(user,true);
  PermissionThreadLocal.setPermissionChecker(permissionChecker);
  Locale locale=request.getLocale();
  Group userGroup=user.getGroup();
  if (userGroup == null) {
    userGroup=GroupLocalServiceUtil.getGroup(company.getCompanyId(),"Guest");
  }
  List<Layout> layouts=LayoutLocalServiceUtil.getLayouts(userGroup.getGroupId(),true,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
  Layout layout=null;
  if (layouts.size() > 0) {
    layout=layouts.get(0);
  }
  if (layout == null) {
    String friendlyURL=_getFriendlyURL(PropsUtil.get(_DEFAULT_USER_PRIVATE_LAYOUT_FRIENDLY_URL));
    layout=LayoutLocalServiceUtil.addLayout(user.getUserId(),userGroup.getGroupId(),true,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID,PropsUtil.get(_DEFAULT_USER_PRIVATE_LAYOUT_NAME),StringPool.BLANK,StringPool.BLANK,LayoutConstants.TYPE_PORTLET,false,friendlyURL);
  }
  ThemeDisplay themeDisplay=new ThemeDisplay();
  themeDisplay.setCompany(company);
  themeDisplay.setCompanyLogo(companyLogo);
  themeDisplay.setUser(user);
  themeDisplay.setLayout(layout);
  themeDisplay.setScopeGroupId(layout.getGroupId());
  themeDisplay.setPermissionChecker(permissionChecker);
  themeDisplay.setLocale(locale);
  themeDisplay.setLanguageId(LocaleUtil.toLanguageId(locale));
  themeDisplay.setSecure(request.isSecure());
  themeDisplay.setPathImage(imagePath);
  request.setAttribute(WebKeys.CTX,ProducerThreadLocalizer.getContext());
  request.setAttribute(WebKeys.LAYOUT,layout);
  request.setAttribute(WebKeys.THEME_DISPLAY,themeDisplay);
}
