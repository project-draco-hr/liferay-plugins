{
  long parentMessageId=MBMessageConstants.DEFAULT_PARENT_MESSAGE_ID;
  if (mbThreadId != 0) {
    List<MBMessage> mbMessages=MBMessageLocalServiceUtil.getThreadMessages(mbThreadId,WorkflowConstants.STATUS_ANY);
    MBMessage lastMessage=mbMessages.get(mbMessages.size() - 1);
    parentMessageId=lastMessage.getMessageId();
  }
  User user=UserLocalServiceUtil.getUser(userId);
  List<User> recipients=parseRecipients(user.getCompanyId(),to);
  return addPrivateMessage(userId,mbThreadId,parentMessageId,recipients,subject,body,files);
}
