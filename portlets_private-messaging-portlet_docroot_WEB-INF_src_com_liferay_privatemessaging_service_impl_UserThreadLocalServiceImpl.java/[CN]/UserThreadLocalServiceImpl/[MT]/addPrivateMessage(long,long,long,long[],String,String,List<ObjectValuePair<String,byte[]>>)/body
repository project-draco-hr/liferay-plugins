{
  long groupId=0;
  long categoryId=PrivateMessagingConstants.PRIVATE_MESSAGING_CATEGORY_ID;
  if (Validator.isNull(subject)) {
    subject=StringUtil.shorten(body,50);
  }
  boolean anonymous=false;
  double priority=0.0;
  boolean allowPingbacks=false;
  ServiceContext serviceContext=new ServiceContext();
  serviceContext.setWorkflowAction(WorkflowConstants.ACTION_SAVE_DRAFT);
  User user=UserLocalServiceUtil.getUser(userId);
  MBMessage mbMessage=MBMessageLocalServiceUtil.addMessage(userId,user.getScreenName(),groupId,categoryId,mbThreadId,parentMessageId,subject,body,files,anonymous,priority,allowPingbacks,serviceContext);
  if (mbThreadId == 0) {
    for (    long recipientUserId : recipientUserIds) {
      if (recipientUserId != userId) {
        addUserThread(recipientUserId,mbMessage.getThreadId(),mbMessage.getMessageId(),false,false);
      }
    }
    addUserThread(userId,mbMessage.getThreadId(),mbMessage.getMessageId(),true,false);
  }
 else {
    List<UserThread> userThreads=userThreadPersistence.findByMBThreadId(mbMessage.getThreadId());
    for (    UserThread userThread : userThreads) {
      if (userThread.isDeleted()) {
        userThread.setDeleted(false);
        userThread.setTopMBMessageId(mbMessage.getMessageId());
      }
      if (userThread.getUserId() == userId) {
        userThread.setRead(true);
      }
 else {
        userThread.setRead(false);
      }
      userThread.setModifiedDate(new Date());
      userThreadPersistence.update(userThread,false);
    }
  }
  return mbMessage;
}
