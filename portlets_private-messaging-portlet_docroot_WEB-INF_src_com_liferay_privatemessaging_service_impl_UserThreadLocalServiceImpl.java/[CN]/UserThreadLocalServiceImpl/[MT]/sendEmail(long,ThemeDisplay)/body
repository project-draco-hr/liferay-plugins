{
  MBMessage mbMessage=MBMessageLocalServiceUtil.getMBMessage(mbMessageId);
  String layoutFullURL=PortalUtil.getLayoutFullURL(themeDisplay);
  if (Validator.isNull(layoutFullURL)) {
    return;
  }
  User sender=UserLocalServiceUtil.getUser(mbMessage.getUserId());
  Company company=CompanyLocalServiceUtil.getCompany(sender.getCompanyId());
  InternetAddress from=new InternetAddress(company.getEmailAddress());
  String subject=StringUtil.read(PrivateMessagingPortlet.class.getResourceAsStream("dependencies/notification_message_subject.tmpl"));
  subject=StringUtil.replace(subject,new String[]{"[$COMPANY_NAME$]","[$FROM_NAME$]"},new String[]{company.getName(),sender.getFullName()});
  String body=StringUtil.read(PrivateMessagingPortlet.class.getResourceAsStream("dependencies/notification_message_body.tmpl"));
  long portraitId=sender.getPortraitId();
  String tokenId=WebServerServletTokenUtil.getToken(sender.getPortraitId());
  String portraitURL=themeDisplay.getPortalURL() + themeDisplay.getPathImage() + "/user_"+ (sender.isFemale() ? "female" : "male")+ "_portrait?img_id="+ portraitId+ "&t="+ tokenId;
  String threadURL=layoutFullURL + "/-/private_messaging/thread/" + mbMessage.getThreadId();
  body=StringUtil.replace(body,new String[]{"[$BODY$]","[$COMPANY_NAME$]","[$FROM_AVATAR$]","[$FROM_NAME$]","[$FROM_PROFILE_URL$]","[$SUBJECT$]","[$THREAD_URL$]"},new String[]{mbMessage.getBody(),company.getName(),portraitURL,sender.getFullName(),sender.getDisplayURL(themeDisplay),mbMessage.getSubject(),threadURL});
  List<UserThread> userThreads=UserThreadLocalServiceUtil.getMBThreadUserThreads(mbMessage.getThreadId());
  for (  UserThread userThread : userThreads) {
    if (userThread.getUserId() == mbMessage.getUserId()) {
      continue;
    }
    User recipient=UserLocalServiceUtil.getUser(userThread.getUserId());
    InternetAddress to=new InternetAddress(recipient.getEmailAddress());
    Format dateFormatDateTime=FastDateFormatFactoryUtil.getSimpleDateFormat("MMMMM d 'at' h:mm a",recipient.getLocale(),recipient.getTimeZone());
    body=StringUtil.replace(body,"[$SENT_DATE$]",dateFormatDateTime.format(mbMessage.getCreateDate()));
    MailMessage mailMessage=new MailMessage(from,to,subject,body,true);
    MailServiceUtil.sendEmail(mailMessage);
  }
}
