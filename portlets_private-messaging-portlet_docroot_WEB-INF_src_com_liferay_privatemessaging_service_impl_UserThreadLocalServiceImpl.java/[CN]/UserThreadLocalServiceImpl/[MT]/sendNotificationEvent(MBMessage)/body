{
  JSONObject notificationEventJSONObject=JSONFactoryUtil.createJSONObject();
  notificationEventJSONObject.put("classPK",mbMessage.getMessageId());
  notificationEventJSONObject.put("userId",mbMessage.getUserId());
  List<UserThread> userThreads=UserThreadLocalServiceUtil.getMBThreadUserThreads(mbMessage.getThreadId());
  for (  UserThread userThread : userThreads) {
    if ((userThread.getUserId() == mbMessage.getUserId()) && UserNotificationManagerUtil.isDeliver(userThread.getUserId(),PortletKeys.PRIVATE_MESSAGING,PrivateMessagingConstants.NEW_MESSAGE,0,UserNotificationDeliveryConstants.TYPE_WEBSITE)) {
      continue;
    }
    NotificationEvent notificationEvent=NotificationEventFactoryUtil.createNotificationEvent(System.currentTimeMillis(),PortletKeys.PRIVATE_MESSAGING,notificationEventJSONObject);
    notificationEvent.setDeliveryRequired(0);
    UserNotificationEventLocalServiceUtil.addUserNotificationEvent(userThread.getUserId(),notificationEvent);
  }
}
