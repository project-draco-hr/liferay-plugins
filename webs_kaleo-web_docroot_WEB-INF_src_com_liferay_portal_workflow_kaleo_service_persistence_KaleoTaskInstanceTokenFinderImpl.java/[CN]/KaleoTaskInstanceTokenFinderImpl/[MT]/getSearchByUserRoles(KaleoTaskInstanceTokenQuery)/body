{
  Boolean searchByUserRoles=kaleoTaskInstanceTokenQuery.isSearchByUserRoles();
  if (searchByUserRoles == null) {
    return StringPool.BLANK;
  }
  if (searchByUserRoles) {
    List<Long> roleIds=RoleUtil.getRoleIds(kaleoTaskInstanceTokenQuery.getServiceContext());
    List<UserGroupRole> userGroupRoles=UserGroupRoleLocalServiceUtil.getUserGroupRoles(kaleoTaskInstanceTokenQuery.getUserId());
    List<Group> allGroups=new ArrayList<Group>();
    User user=UserLocalServiceUtil.getUserById(kaleoTaskInstanceTokenQuery.getUserId());
    allGroups.addAll(user.getGroups());
    allGroups.addAll(GroupLocalServiceUtil.getOrganizationsGroups(user.getOrganizations()));
    allGroups.addAll(GroupLocalServiceUtil.getOrganizationsRelatedGroups(user.getOrganizations()));
    allGroups.addAll(GroupLocalServiceUtil.getUserGroupsGroups(user.getUserGroups()));
    allGroups.addAll(GroupLocalServiceUtil.getUserGroupsRelatedGroups(user.getUserGroups()));
    for (    Group group : allGroups) {
      if (group.isUserGroup()) {
        List<UserGroupGroupRole> userGroupGroupRoles=UserGroupGroupRoleLocalServiceUtil.getUserGroupGroupRoles(group.getClassPK());
        for (        UserGroupGroupRole userGroupGroupRole : userGroupGroupRoles) {
          roleIds.add(userGroupGroupRole.getRoleId());
        }
      }
 else {
        List<Role> groupRoles=RoleLocalServiceUtil.getGroupRoles(group.getGroupId());
        for (        Role role : groupRoles) {
          roleIds.add(role.getRoleId());
        }
      }
    }
    if (roleIds.isEmpty() && userGroupRoles.isEmpty()) {
      return StringPool.BLANK;
    }
    StringBundler sb=new StringBundler();
    sb.append("AND ((");
    sb.append("KaleoTaskAssignmentInstance.assigneeClassName = ?) ");
    sb.append("AND (");
    for (int i=0; i < roleIds.size(); i++) {
      sb.append("(KaleoTaskAssignmentInstance.assigneeClassPK = ?)");
      if ((i + 1) < roleIds.size()) {
        sb.append(" OR ");
      }
    }
    if (!roleIds.isEmpty() && !userGroupRoles.isEmpty()) {
      sb.append(" OR ");
    }
    for (int i=0; i < userGroupRoles.size(); i++) {
      sb.append("((KaleoTaskAssignmentInstance.groupId = ?) AND ");
      sb.append("(KaleoTaskAssignmentInstance.assigneeClassPK = ?))");
      if ((i + 1) < userGroupRoles.size()) {
        sb.append(" OR ");
      }
    }
    sb.append("))");
    return sb.toString();
  }
 else {
    StringBundler sb=new StringBundler(4);
    sb.append("AND ((");
    sb.append("KaleoTaskAssignmentInstance.assigneeClassName = ?) ");
    sb.append("AND (KaleoTaskAssignmentInstance.assigneeClassPK = ?))");
    return sb.toString();
  }
}
