{
  IMAPFolder imapFolder=null;
  try {
    imapFolder=openFolder(folderId);
    int messageCount=imapFolder.getMessageCount();
    Folder folder=FolderLocalServiceUtil.getFolder(folderId);
    FolderLocalServiceUtil.updateFolder(folderId,folder.getFullName(),folder.getDisplayName(),messageCount);
    if (messageCount > 0) {
      StopWatch sw=null;
      if (_log.isDebugEnabled()) {
        sw=new StopWatch();
        sw.start();
      }
      javax.mail.Message oldestMessage=getStoredMessage(imapFolder,folderId,true);
      javax.mail.Message newestMessage=getStoredMessage(imapFolder,folderId,false);
      if (_log.isDebugEnabled()) {
        sw.stop();
        _log.debug("getStoredMessage (oldest and newest) completed in " + sw.getTime() + " ms");
        sw.reset();
        sw.start();
      }
      javax.mail.Message messages[]=new javax.mail.Message[0];
      if ((oldestMessage != null) && (newestMessage != null)) {
        _log.debug("downloading messages in folder for the first time");
        if ((messageCount - _MAX_MESSAGES_TO_STORE_PER_SYNC) < 0) {
          messages=imapFolder.getMessages(1,messageCount);
        }
 else {
          messages=imapFolder.getMessages(messageCount - _MAX_MESSAGES_TO_STORE_PER_SYNC,messageCount);
        }
        storeMessagesEnvelope(imapFolder,messages,folderId);
      }
 else {
        if (newestMessage != null) {
          _log.debug("downloading new messages in folder");
          int messageNumber=newestMessage.getMessageNumber();
          if (messageNumber != messageCount) {
            messages=imapFolder.getMessages(messageNumber,messageCount);
            storeMessagesEnvelope(imapFolder,messages,folderId);
          }
        }
        if ((oldestMessage != null) && (messageCount != 1)) {
          _log.debug("downloading old messages in folder");
          int messageNumber=oldestMessage.getMessageNumber();
          if ((messageNumber - _MAX_MESSAGES_TO_STORE_PER_SYNC) < 0) {
            messages=imapFolder.getMessages(1,messageNumber);
          }
 else {
            messages=imapFolder.getMessages(messageNumber - _MAX_MESSAGES_TO_STORE_PER_SYNC,messageNumber);
          }
          storeMessagesEnvelope(imapFolder,messages,folderId);
        }
      }
      if (_log.isDebugEnabled()) {
        sw.stop();
        _log.debug("determining start and end positions for downloading " + "messages completed in " + sw.getTime() + " ms");
      }
    }
  }
 catch (  MessagingException me) {
    throw new MailException(me);
  }
 finally {
    closeFolder(imapFolder,false);
  }
}
