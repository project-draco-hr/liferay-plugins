{
  IMAPFolder imapFolder=null;
  try {
    imapFolder=openFolder(folderId);
    int messageCount=imapFolder.getMessageCount();
    Folder folder=FolderLocalServiceUtil.getFolder(folderId);
    FolderLocalServiceUtil.updateFolder(folderId,folder.getFullName(),folder.getDisplayName(),messageCount);
    if (messageCount > 0) {
      StopWatch sw=null;
      if (_log.isDebugEnabled()) {
        sw=new StopWatch();
        sw.start();
      }
      javax.mail.Message oldestMessage=getStoredMessage(imapFolder,folderId,true);
      javax.mail.Message newestMessage=getStoredMessage(imapFolder,folderId,false);
      javax.mail.Message messages[]=new javax.mail.Message[0];
      if ((oldestMessage == null) && (newestMessage == null)) {
        _log.debug("downloading messages in folder for the first time");
        int startingMessageNumber=messageCount - _MAX_MESSAGES_TO_STORE_PER_SYNC;
        if (startingMessageNumber < 1) {
          startingMessageNumber=1;
        }
        messages=imapFolder.getMessages(startingMessageNumber,messageCount);
        storeMessagesEnvelope(imapFolder,messages,folderId);
      }
 else {
        int newestMessageNumber=newestMessage.getMessageNumber();
        if (newestMessageNumber != messageCount) {
          _log.debug("downloading new messages in folder");
          messages=imapFolder.getMessages(newestMessageNumber + 1,messageCount);
          storeMessagesEnvelope(imapFolder,messages,folderId);
        }
        int oldestMessageNumber=oldestMessage.getMessageNumber();
        if (oldestMessageNumber != 1) {
          _log.debug("downloading old messages in folder");
          int startingMessageNumber=oldestMessageNumber - _MAX_MESSAGES_TO_STORE_PER_SYNC;
          if (startingMessageNumber < 1) {
            startingMessageNumber=1;
          }
          messages=imapFolder.getMessages(startingMessageNumber,oldestMessageNumber - 1);
          storeMessagesEnvelope(imapFolder,messages,folderId);
        }
      }
      if (_log.isDebugEnabled()) {
        sw.stop();
        _log.debug("storeNewMessagesEnvelope completed in " + sw.getTime() + " ms");
      }
    }
  }
 catch (  MessagingException me) {
    throw new MailException(me);
  }
 finally {
    closeFolder(imapFolder,false);
  }
}
