{
  InputStream inputStream=null;
  try {
    SyncFile syncFile=(SyncFile)getParameterValue("syncFile");
    Path filePath=Paths.get(syncFile.getFilePathName());
    HttpEntity httpEntity=httpResponse.getEntity();
    inputStream=httpEntity.getContent();
    Path tempFilePath=Files.createTempFile(String.valueOf(filePath.getFileName()),".tmp");
    if (Files.exists(filePath)) {
      Files.copy(filePath,tempFilePath);
    }
    if ((Boolean)getParameterValue("patch")) {
      IODeltaUtil.patch(tempFilePath,inputStream);
      Files.move(tempFilePath,filePath,StandardCopyOption.ATOMIC_MOVE,StandardCopyOption.REPLACE_EXISTING);
    }
 else {
      Files.copy(inputStream,tempFilePath,StandardCopyOption.REPLACE_EXISTING);
      Files.move(tempFilePath,filePath,StandardCopyOption.ATOMIC_MOVE,StandardCopyOption.REPLACE_EXISTING);
    }
    syncFile.setFileKey(FileUtil.getFileKey(filePath));
    syncFile.setState(SyncFile.STATE_SYNCED);
    syncFile.setUiEvent(SyncFile.UI_EVENT_DOWNLOADED);
    SyncFileService.update(syncFile);
  }
  finally {
    StreamUtil.cleanUp(inputStream);
  }
}
