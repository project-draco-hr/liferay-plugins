{
  Store store=null;
  String storeKey=_mailAccount.getUser().getUserId() + "_STORE_" + _mailAccount.getEmailAddress();
  if (useOldStores) {
    store=(Store)_allStores.get(storeKey);
    if (Validator.isNotNull(store) && !store.isConnected()) {
      store.close();
      store=null;
    }
  }
  if (Validator.isNull(store)) {
    Session session=getSession();
    if (_mailAccount.isMailInSecure()) {
      store=session.getStore("imaps");
    }
 else {
      store=session.getStore("imap");
    }
    store.addConnectionListener(new ConnectionListener(storeKey));
    try {
      store.connect(_mailAccount.getMailInHostName(),_mailAccount.getMailInPort(),_mailAccount.getUsername(),_mailAccount.getPassword());
    }
 catch (    MessagingException me) {
      _log.error("Failed on connecting to " + storeKey);
      throw me;
    }
    if (useOldStores) {
      _allStores.put(storeKey,store);
    }
  }
  return store;
}
