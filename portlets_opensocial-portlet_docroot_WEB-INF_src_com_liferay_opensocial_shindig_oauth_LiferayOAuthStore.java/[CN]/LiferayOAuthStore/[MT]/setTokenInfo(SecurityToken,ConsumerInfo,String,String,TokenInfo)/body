{
  long userId=GetterUtil.getLong(securityToken.getViewerId());
  User user=null;
  try {
    user=UserLocalServiceUtil.getUser(userId);
  }
 catch (  Exception e) {
    throw new GadgetException(GadgetException.Code.INTERNAL_SERVER_ERROR,e);
  }
  Gadget gadget=null;
  try {
    gadget=GadgetLocalServiceUtil.getGadget(user.getCompanyId(),securityToken.getAppUrl());
  }
 catch (  Exception e) {
    throw new GadgetException(GadgetException.Code.INTERNAL_SERVER_ERROR,e);
  }
  try {
    OAuthTokenLocalServiceUtil.addOAuthToken(userId,gadget.getGadgetId(),serviceName,securityToken.getModuleId(),tokenInfo.getAccessToken(),tokenName,tokenInfo.getTokenSecret(),tokenInfo.getSessionHandle(),tokenInfo.getTokenExpireMillis());
  }
 catch (  Exception e) {
    throw new GadgetException(GadgetException.Code.INTERNAL_SERVER_ERROR,e);
  }
}
