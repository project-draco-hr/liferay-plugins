{
  long userId=GetterUtil.getLong(securityToken.getViewerId());
  User user=null;
  try {
    user=UserLocalServiceUtil.getUser(userId);
  }
 catch (  Exception e) {
    throw new GadgetException(GadgetException.Code.INTERNAL_SERVER_ERROR,e);
  }
  Gadget gadget=null;
  try {
    gadget=GadgetLocalServiceUtil.getGadget(user.getCompanyId(),securityToken.getAppUrl());
  }
 catch (  Exception e) {
    throw new GadgetException(GadgetException.Code.INTERNAL_SERVER_ERROR,e);
  }
  OAuthConsumer oAuthConsumer=null;
  try {
    oAuthConsumer=OAuthConsumerLocalServiceUtil.getOAuthConsumer(gadget.getGadgetId(),serviceName);
  }
 catch (  Exception e) {
    return _defaultOAuthConsumer;
  }
  if (oAuthConsumer.getKeyType().equals(OAuthConsumerConstants.KEY_TYPE_RSA_PRIVATE)) {
    if (_defaultOAuthConsumer == null) {
      throw new GadgetException(GadgetException.Code.INTERNAL_SERVER_ERROR,"No OAuth signing key specified.");
    }
    oAuthConsumer.setConsumerSecret(_defaultOAuthConsumer.getConsumerSecret());
  }
  return oAuthConsumer;
}
