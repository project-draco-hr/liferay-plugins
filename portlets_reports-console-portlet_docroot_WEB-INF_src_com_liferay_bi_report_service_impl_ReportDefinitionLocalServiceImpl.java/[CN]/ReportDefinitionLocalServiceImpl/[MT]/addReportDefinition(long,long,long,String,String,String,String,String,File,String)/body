{
  long definitionId=CounterLocalServiceUtil.increment();
  ReportDefinition definition=reportDefinitionPersistence.create(definitionId);
  definition.setCompanyId(companyId);
  definition.setGroupId(groupId);
  definition.setUserId(userId);
  definition.setDefinitionName(definitionName);
  definition.setDescription(description);
  definition.setDataSourceName(datasourceName);
  definition.setReportFormat(format);
  definition.setReportParameters(reportParameters);
  validate(definition);
  if (Validator.isNull(fileName)) {
    throw new DefinitionFileException();
  }
  definition.setReportName(StringUtil.extractFirst(fileName,StringPool.PERIOD));
  try {
    try {
      DLServiceUtil.addDirectory(companyId,CompanyConstants.SYSTEM,definition.getAttachmentsDir());
    }
 catch (    DuplicateDirectoryException dde) {
    }
    DLServiceUtil.addFile(companyId,CompanyConstants.SYSTEM_STRING,groupId,CompanyConstants.SYSTEM,definition.getAttachmentsDir() + StringPool.SLASH + fileName,0,StringPool.BLANK,new Date(),new String[0],new String[0],file);
  }
 catch (  PortalException e) {
    DLServiceUtil.deleteDirectory(companyId,CompanyConstants.SYSTEM_STRING,CompanyConstants.SYSTEM,definition.getAttachmentsDir());
    throw new DefinitionFileException();
  }
  return addReportDefinition(definition);
}
