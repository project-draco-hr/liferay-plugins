{
  UploadPortletRequest uploadRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  long definitionId=ParamUtil.getLong(uploadRequest,"definitionId");
  if (definitionId <= 0) {
    throw new NoSuchDefinitionException();
  }
  ReportDefinition definition=ReportDefinitionLocalServiceUtil.getReportDefinition(definitionId);
  String definitionName=ParamUtil.getString(uploadRequest,"definitionName");
  if (Validator.isNull(definitionName)) {
    throw new DefinitionNameException();
  }
  String fileName=uploadRequest.getFileName("msgFile");
  if (Validator.isNull(definitionName)) {
    throw new DefinitionFileException();
  }
  String[] existingAttachments=DLServiceUtil.getFileNames(definition.getCompanyId(),CompanyConstants.SYSTEM,definition.getAttachmentsDir());
  for (  String attachment : existingAttachments) {
    DLServiceUtil.deleteFile(definition.getCompanyId(),CompanyConstants.SYSTEM_STRING,CompanyConstants.SYSTEM,attachment);
  }
  File file=uploadRequest.getFile("msgFile");
  String portletId=CompanyConstants.SYSTEM_STRING;
  long repositoryId=0;
  long fileEntryId=0;
  String properties=StringPool.BLANK;
  Date modifiedDate=new Date();
  String[] tagsCategories=new String[0];
  String[] tagsEntries=new String[0];
  DLServiceUtil.addFile(definition.getCompanyId(),portletId,definition.getGroupId(),repositoryId,definition.getAttachmentsDir() + StringPool.SLASH + fileName,fileEntryId,properties,modifiedDate,tagsCategories,tagsEntries,file);
  String description=ParamUtil.getString(uploadRequest,"description");
  String datasourceName=ParamUtil.getString(uploadRequest,"dataSourceName");
  String format=ParamUtil.getString(uploadRequest,"format");
  String reportParameters=ParamUtil.getString(uploadRequest,"reportParameters");
  definition.setDefinitionName(definitionName);
  definition.setDescription(description);
  definition.setDataSourceName(datasourceName);
  definition.setReportFormat(format.toString());
  definition.setReportParameters(reportParameters);
  ReportDefinitionLocalServiceUtil.updateReportDefinition(definition);
  uploadRequest.setAttribute("fileName",fileName);
  uploadRequest.setAttribute("definition",definition);
}
