{
  if (!message.isDiscussion()) {
    return;
  }
  String[] mentionedUsersScreenNames=getMentionedUsersScreenNames(message);
  if (ArrayUtil.isEmpty(mentionedUsersScreenNames)) {
    return;
  }
  String contentURL=(String)serviceContext.getAttribute("contentURL");
  String messageUserEmailAddress=PortalUtil.getUserEmailAddress(message.getUserId());
  String messageUserName=PortalUtil.getUserName(message.getUserId(),StringPool.BLANK);
  String fromName=PrefsPropsUtil.getString(message.getCompanyId(),PropsKeys.ADMIN_EMAIL_FROM_NAME);
  String fromAddress=PrefsPropsUtil.getString(message.getCompanyId(),PropsKeys.ADMIN_EMAIL_FROM_ADDRESS);
  String subject=ContentUtil.get(PortletPropsValues.MB_DISCUSSION_EMAIL_SUBJECT);
  String body=ContentUtil.get(PortletPropsValues.MB_DISCUSSION_EMAIL_BODY);
  SubscriptionSender subscriptionSender=new SubscriptionSender();
  subscriptionSender.setBody(body);
  subscriptionSender.setClassName(message.getModelClassName());
  subscriptionSender.setClassPK(message.getMessageId());
  subscriptionSender.setCompanyId(message.getCompanyId());
  subscriptionSender.setContextAttribute("[$COMMENTS_BODY$]",message.getBody(true),false);
  subscriptionSender.setContextAttributes("[$COMMENTS_USER_ADDRESS$]",messageUserEmailAddress,"[$COMMENTS_USER_NAME$]",messageUserName,"[$CONTENT_URL$]",contentURL);
  subscriptionSender.setEntryTitle(message.getBody());
  subscriptionSender.setEntryURL(contentURL);
  subscriptionSender.setFrom(fromAddress,fromName);
  subscriptionSender.setHtmlFormat(true);
  subscriptionSender.setMailId("mb_discussion",message.getCategoryId(),message.getMessageId());
  subscriptionSender.setNotificationType(MentionsConstants.MENTION);
  subscriptionSender.setPortletId(PortletKeys.MENTIONS);
  subscriptionSender.setScopeGroupId(message.getGroupId());
  subscriptionSender.setServiceContext(serviceContext);
  subscriptionSender.setSubject(subject);
  subscriptionSender.setUserId(message.getUserId());
  for (int i=0; i < mentionedUsersScreenNames.length; i++) {
    String mentionedUserScreenName=mentionedUsersScreenNames[i];
    User user=UserLocalServiceUtil.fetchUserByScreenName(message.getCompanyId(),mentionedUserScreenName);
    if (user == null) {
      continue;
    }
    subscriptionSender.addRuntimeSubscribers(user.getEmailAddress(),user.getFullName());
  }
  subscriptionSender.flushNotificationsAsync();
}
