{
  DynamicQuery dynamicQuery=DynamicQueryFactoryUtil.forClass(Message.class,PortletClassLoaderUtil.getClassLoader());
  dynamicQuery.add(RestrictionsFactoryUtil.eq("folderId",folderId));
  if (orderByType.equals("desc")) {
    dynamicQuery.addOrder(OrderFactoryUtil.desc(orderByField));
  }
 else {
    dynamicQuery.addOrder(OrderFactoryUtil.asc(orderByField));
  }
  if (Validator.isNotNull(keywords)) {
    String value="%" + keywords + "%";
    Conjunction conjunction=RestrictionsFactoryUtil.conjunction();
    conjunction.add(RestrictionsFactoryUtil.ilike("subject",value));
    conjunction.add(RestrictionsFactoryUtil.ilike("body",value));
    dynamicQuery.add(conjunction);
  }
  int start=messagesPerPage * (pageNumber - 1);
  int end=messagesPerPage * pageNumber;
  List<Object> results=messagePersistence.findWithDynamicQuery(dynamicQuery,start,end);
  for (  Object result : results) {
    messages.add((Message)result);
  }
  return (int)dynamicQueryCount(dynamicQuery);
}
