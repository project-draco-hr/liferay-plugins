{
  Group controlPanelGroup=GroupLocalServiceUtil.getGroup(expandoTable.getCompanyId(),GroupConstants.CONTROL_PANEL);
  long controlPanelPlid=LayoutLocalServiceUtil.getDefaultPlid(controlPanelGroup.getGroupId(),true);
  if (!hasExpandoColumn(expandoTable,"portletPrimKeys")) {
    ExpandoColumnLocalServiceUtil.addColumn(expandoTable.getTableId(),"portletPrimKeys",ExpandoColumnConstants.STRING_ARRAY);
  }
  List<ExpandoValue> expandoValues=ExpandoValueLocalServiceUtil.getColumnValues(expandoTable.getCompanyId(),Subscription.class.getName(),"KB","portletIds",QueryUtil.ALL_POS,QueryUtil.ALL_POS);
  for (  ExpandoValue expandoValue : expandoValues) {
    Subscription subscription=null;
    try {
      subscription=SubscriptionLocalServiceUtil.getSubscription(expandoValue.getClassPK());
    }
 catch (    NoSuchSubscriptionException nsse) {
      continue;
    }
    Article article=null;
    try {
      article=ArticleLocalServiceUtil.getLatestArticle(subscription.getClassPK(),WorkflowConstants.STATUS_ANY);
    }
 catch (    NoSuchArticleException nsae) {
    }
    long groupId=subscription.getClassPK();
    if (article != null) {
      groupId=article.getGroupId();
    }
    String[] portletPrimKeys=new String[0];
    String[] portletIds=expandoValue.getStringArray();
    for (int i=0; i < portletIds.length; i++) {
      String portletId=portletIds[i];
      String portletPrimKey=null;
      if (portletId.equals(PortletKeys.KNOWLEDGE_BASE_ADMIN)) {
        portletPrimKey=ArticleConstants.getPortletPrimKey(controlPanelPlid,PortletKeys.KNOWLEDGE_BASE_ADMIN);
      }
      long plid=LayoutConstants.DEFAULT_PLID;
      if (portletPrimKey == null) {
        plid=PortalUtil.getPlidFromPortletId(groupId,portletId);
      }
      if (plid != LayoutConstants.DEFAULT_PLID) {
        portletPrimKey=ArticleConstants.getPortletPrimKey(plid,portletId);
      }
      if (portletPrimKey == null) {
        continue;
      }
      portletPrimKeys=ArrayUtil.append(portletPrimKeys,portletPrimKey);
      if ((portletPrimKeys.length > 0) && (article != null)) {
        break;
      }
    }
    if (portletPrimKeys.length <= 0) {
      SubscriptionLocalServiceUtil.deleteSubscription(subscription.getSubscriptionId());
    }
 else {
      ExpandoValueLocalServiceUtil.addValue(subscription.getCompanyId(),Subscription.class.getName(),"KB","portletPrimKeys",subscription.getSubscriptionId(),portletPrimKeys);
    }
  }
  ExpandoColumnLocalServiceUtil.deleteColumn(expandoTable.getTableId(),"portletIds");
}
