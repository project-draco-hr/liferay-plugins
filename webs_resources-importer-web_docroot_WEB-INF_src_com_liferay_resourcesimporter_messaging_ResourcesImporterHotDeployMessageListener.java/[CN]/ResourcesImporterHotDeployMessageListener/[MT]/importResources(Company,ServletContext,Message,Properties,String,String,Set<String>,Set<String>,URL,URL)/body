{
  long companyId=CompanyThreadLocal.getCompanyId();
  try {
    CompanyThreadLocal.setCompanyId(company.getCompanyId());
    Importer importer=createImporter(company.getCompanyId(),resourcesDir,resourcePaths,templatePaths,privateLARURL,publicLARURL);
    boolean developerModeEnabled=configureImporter(company.getCompanyId(),importer,servletContext,pluginPackageProperties,targetClassName);
    if (!developerModeEnabled && importer.isExisting() && !importer.isCompanyGroup()) {
      if (_log.isInfoEnabled()) {
        _log.info("Group or layout set prototype already exists " + "for company " + company.getWebId());
      }
      return;
    }
    long startTime=0;
    if (_log.isInfoEnabled()) {
      startTime=System.currentTimeMillis();
    }
    importer.importResources();
    if (_log.isInfoEnabled()) {
      long endTime=System.currentTimeMillis() - startTime;
      _log.info("Importing resources from " + servletContext.getServletContextName() + " to group "+ importer.getGroupId()+ " takes "+ endTime+ " ms");
    }
    Message newMessage=new Message();
    newMessage.put("companyId",company.getCompanyId());
    newMessage.put("servletContextName",servletContext.getServletContextName());
    newMessage.put("targetClassName",targetClassName);
    newMessage.put("targetClassPK",importer.getTargetClassPK());
    if (message.getResponseId() != null) {
      Map<String,Object> responseMap=new HashMap<String,Object>();
      responseMap.put("groupId",importer.getTargetClassPK());
      newMessage.setPayload(responseMap);
      newMessage.setResponseId(message.getResponseId());
    }
    MessageBusUtil.sendMessage("liferay/resources_importer",newMessage);
  }
 catch (  ImporterException ie) {
    Message newMessage=new Message();
    newMessage.put("companyId",company.getCompanyId());
    newMessage.put("error",ie.getMessage());
    newMessage.put("servletContextName",servletContext.getServletContextName());
    newMessage.put("targetClassName",targetClassName);
    newMessage.put("targetClassPK",0);
    MessageBusUtil.sendMessage("liferay/resources_importer",newMessage);
  }
 finally {
    CompanyThreadLocal.setCompanyId(companyId);
  }
}
