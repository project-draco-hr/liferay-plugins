{
  if (!includeChildren) {
    try {
      List<WorkflowLog> workflowLogs=WorkflowLogUtil.findByWorkflowInstanceId(workflowInstanceId,start,end,orderByComparator);
      return WorkflowManagerUtil.wrapWorkflowHistory(workflowLogs);
    }
 catch (    Exception e) {
      throw new WorkflowException(e.getMessage(),e);
    }
  }
  ProcessSetup processSetup=getSetup();
  ProcessDao processDao=processSetup.getProcessDao();
  ProcessInstance processInstance=processDao.loadProcessInstance(workflowInstanceId,true);
  List<ProcessInstance> processInstances=new ArrayList<ProcessInstance>();
  WorkflowManagerUtil.getFlatProcessInstances(processInstance,processInstances);
  List<WorkflowLog> workflowLogs=new ArrayList<WorkflowLog>();
  try {
    for (    ProcessInstance curProcessInstance : processInstances) {
      List<WorkflowLog> curWorkflowLogs=WorkflowLogUtil.findByWorkflowInstanceId(curProcessInstance.getPrimaryKey());
      workflowLogs.addAll(curWorkflowLogs);
    }
    List<WorkflowInstanceHistory> workflowInstanceHistory=WorkflowManagerUtil.wrapWorkflowHistory(workflowLogs);
    if (orderByComparator != null) {
      Collections.sort(workflowInstanceHistory,orderByComparator);
    }
    if ((start != QueryUtil.ALL_POS) && (end != QueryUtil.ALL_POS)) {
      workflowInstanceHistory=ListUtil.subList(workflowInstanceHistory,start,end);
    }
    return workflowInstanceHistory;
  }
 catch (  Exception e) {
    throw new WorkflowException(e.getMessage(),e);
  }
}
