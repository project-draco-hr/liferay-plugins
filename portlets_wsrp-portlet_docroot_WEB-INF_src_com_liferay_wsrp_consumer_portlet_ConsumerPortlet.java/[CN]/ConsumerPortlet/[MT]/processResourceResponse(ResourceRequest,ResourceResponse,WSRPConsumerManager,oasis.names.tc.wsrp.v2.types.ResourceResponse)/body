{
  PortletSession portletSession=resourceRequest.getPortletSession();
  PortletContext portletContext=wsrpResourceResponse.getPortletContext();
  if (portletContext != null) {
    portletSession.setAttribute(WebKeys.PORTLET_CONTEXT,portletContext);
  }
  SessionContext sessionContext=wsrpResourceResponse.getSessionContext();
  if (sessionContext != null) {
    portletSession.setAttribute(WebKeys.SESSION_CONTEXT,sessionContext);
  }
  ResourceContext resourceContext=wsrpResourceResponse.getResourceContext();
  NamedString[] clientAttributes=resourceContext.getClientAttributes();
  if (clientAttributes != null) {
    for (    NamedString clientAttribute : clientAttributes) {
      String name=clientAttribute.getName();
      String value=clientAttribute.getValue();
      if (name.equalsIgnoreCase(HttpHeaders.CONTENT_DISPOSITION)) {
        resourceResponse.setProperty(HttpHeaders.CONTENT_DISPOSITION,value);
        break;
      }
    }
  }
  String contentType=resourceContext.getMimeType();
  if (Validator.isNotNull(contentType)) {
    resourceResponse.setContentType(contentType);
  }
  String charSet=getCharSet(contentType);
  String itemString=resourceContext.getItemString();
  byte[] itemBinary=resourceContext.getItemBinary();
  Boolean requiresRewriting=resourceContext.getRequiresRewriting();
  if (requiresRewriting == null) {
    requiresRewriting=Boolean.FALSE;
  }
  if (ParamUtil.getBoolean(resourceRequest,"wsrp-requiresRewrite") || requiresRewriting) {
    if (itemBinary != null) {
      itemString=new String(itemBinary,charSet);
    }
    itemString=rewriteURLs(resourceResponse,itemString);
  }
  if (Validator.isNotNull(itemString)) {
    resourceResponse.setContentLength(itemString.length());
    PortletResponseUtil.write(resourceResponse,itemString);
  }
 else   if (itemBinary != null) {
    resourceResponse.setContentLength(itemBinary.length);
    PortletResponseUtil.write(resourceResponse,itemBinary);
  }
}
