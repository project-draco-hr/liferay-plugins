{
  PortletSession ses=req.getPortletSession();
  MarkupContext cachedMarkup=(MarkupContext)ses.getAttribute("markupContext");
  if (cachedMarkup != null) {
    processMarkupContext(req,res,cachedMarkup);
    ses.removeAttribute("markupContext");
    return;
  }
  WSRPV2MarkupPortType markupService=null;
  try {
    markupService=getMarkupService(req);
  }
 catch (  Exception e) {
    _log.error(e.getMessage(),e);
    return;
  }
  PortletContext portletContext=new PortletContext();
  RuntimeContext runtimeContext=new RuntimeContext();
  UserContext userContext=new UserContext();
  MarkupParams markupParams=new MarkupParams();
  initGetMarkup(req,portletContext,runtimeContext,markupParams,userContext);
  GetMarkup getMarkup=new GetMarkup();
  getMarkup.setPortletContext(portletContext);
  getMarkup.setRuntimeContext(runtimeContext);
  getMarkup.setMarkupParams(markupParams);
  getMarkup.setUserContext(userContext);
  MarkupResponse markupResponse=null;
  try {
    markupResponse=markupService.getMarkup(getMarkup);
  }
 catch (  Exception e) {
    _log.error(e.getMessage(),e);
    return;
  }
  processMarkupResponse(req,res,markupResponse);
}
