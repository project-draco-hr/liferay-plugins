{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  JSONObject userPrefsJSONObject=JSONFactoryUtil.createJSONObject();
  Map<String,UserPref> userPrefs=getUserPrefs(portletConfig,actionRequest);
  for (  UserPref userPref : userPrefs.values()) {
    String name=userPref.getName();
    String value=ParamUtil.getString(actionRequest,name);
    userPrefsJSONObject.put(name,value);
  }
  String namespace=ShindigUtil.getPortletResourceNamespace(actionRequest,themeDisplay);
  String columnName=ShindigUtil.getColumnUserPrefs(namespace);
  ExpandoValueServiceUtil.addValue(themeDisplay.getCompanyId(),User.class.getName(),ShindigUtil.getTableOpenSocial(),columnName,themeDisplay.getUserId(),userPrefsJSONObject.toString());
  SessionMessages.add(actionRequest,portletConfig.getPortletName() + ".doConfigure");
  String portletResource=ParamUtil.getString(actionRequest,"portletResource");
  SessionMessages.add(actionRequest,portletConfig.getPortletName() + ".doRefresh",portletResource);
}
