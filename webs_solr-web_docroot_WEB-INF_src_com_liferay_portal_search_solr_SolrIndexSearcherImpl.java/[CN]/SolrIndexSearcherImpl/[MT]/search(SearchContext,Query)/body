{
  try {
    SolrQuery solrQuery=translateQuery(searchContext.getCompanyId(),query,searchContext.getSorts(),searchContext.getStart(),searchContext.getEnd());
    Map<String,Facet> facets=searchContext.getFacets();
    for (    Facet facet : facets.values()) {
      if (facet.isStatic()) {
        continue;
      }
      FacetConfiguration facetConfiguration=facet.getFacetConfiguration();
      if (facet instanceof RangeFacet) {
        solrQuery.addFacetField(facetConfiguration.getFieldName());
        JSONObject dataJSONObject=facetConfiguration.getData();
        JSONArray rangesJSONArray=dataJSONObject.getJSONArray("ranges");
        if (rangesJSONArray != null) {
          for (int i=0; i < rangesJSONArray.length(); i++) {
            JSONObject rangeJSONObject=rangesJSONArray.getJSONObject(i);
            String range=rangeJSONObject.getString("range");
            String facetQuery=facetConfiguration.getFieldName() + StringPool.COLON + range;
            solrQuery.addFacetQuery(facetQuery);
          }
        }
      }
 else {
        solrQuery.addFacetField(facetConfiguration.getFieldName());
      }
    }
    solrQuery.setFacetLimit(-1);
    QueryResponse queryResponse=_solrServer.query(solrQuery);
    boolean allResults=false;
    if (solrQuery.getRows() == 0) {
      allResults=true;
    }
    for (    FacetField facetField : queryResponse.getFacetFields()) {
      Facet facet=facets.get(facetField.getName());
      FacetCollector facetCollector=null;
      if (facet instanceof RangeFacet) {
        facetCollector=new SolrFacetQueryCollector(facetField.getName(),queryResponse.getFacetQuery());
      }
 else {
        facetCollector=new SolrFacetFieldCollector(facetField.getName(),facetField);
      }
      facet.setFacetCollector(facetCollector);
    }
    return subset(solrQuery,query,query.getQueryConfig(),queryResponse,allResults);
  }
 catch (  Exception e) {
    _log.error(e,e);
    throw new SearchException(e.getMessage());
  }
}
