{
  long companyId=searchContext.getCompanyId();
  Sort[] sorts=searchContext.getSorts();
  int start=searchContext.getStart();
  int end=searchContext.getEnd();
  Map<String,Facet> facets=null;
  try {
    SolrQuery solrQuery=translateQuery(companyId,query,sorts,start,end);
    facets=searchContext.getFacets();
    for (    Facet facet : facets.values()) {
      if (facet.isStatic()) {
        continue;
      }
      FacetConfiguration facetConfiguration=facet.getFacetConfiguration();
      if (facet instanceof RangeFacet) {
        JSONArray rangesJSONArray=facetConfiguration.getData().getJSONArray("ranges");
        solrQuery.addFacetField(facetConfiguration.getFieldName());
        if (rangesJSONArray != null) {
          for (int i=0; i < rangesJSONArray.length(); i++) {
            JSONObject rangeJSONObject=rangesJSONArray.getJSONObject(i);
            String facetQuery=facetConfiguration.getFieldName().concat(StringPool.COLON).concat(rangeJSONObject.getString("range"));
            solrQuery.addFacetQuery(facetQuery);
          }
        }
      }
 else {
        solrQuery.addFacetField(facetConfiguration.getFieldName());
      }
    }
    solrQuery.setFacetLimit(-1);
    QueryResponse queryResponse=_solrServer.query(solrQuery);
    boolean allResults=false;
    if (solrQuery.getRows() == 0) {
      allResults=true;
    }
    for (    FacetField facetField : queryResponse.getFacetFields()) {
      Facet facet=facets.get(facetField.getName());
      if (facet instanceof RangeFacet) {
        facet.setFacetCollector(new SolrFacetQueryCollector(facetField.getName(),queryResponse.getFacetQuery()));
      }
 else {
        facet.setFacetCollector(new SolrFacetFieldCollector(facetField.getName(),facetField));
      }
    }
    return subset(solrQuery,query,query.getQueryConfig(),queryResponse,allResults);
  }
 catch (  Exception e) {
    _log.error(e,e);
    throw new SearchException(e.getMessage());
  }
}
