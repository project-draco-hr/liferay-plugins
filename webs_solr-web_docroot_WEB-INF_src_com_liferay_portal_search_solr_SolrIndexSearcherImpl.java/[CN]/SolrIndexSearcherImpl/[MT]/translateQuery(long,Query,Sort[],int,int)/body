{
  try {
    String queryString=query.toString().replaceAll(":\\*",":");
    queryString=queryString.replaceAll(":\\w+:",":");
    StringBundler sb=new StringBundler(queryString);
    sb.append(StringPool.SPACE);
    sb.append(StringPool.PLUS);
    sb.append(Field.COMPANY_ID);
    sb.append(StringPool.COLON);
    sb.append(companyId);
    SolrQuery solrQuery=new SolrQuery();
    solrQuery.setHighlight(true);
    solrQuery.setHighlightFragsize(80);
    solrQuery.setHighlightSnippets(3);
    solrQuery.setIncludeScore(true);
    solrQuery.setQuery(sb.toString());
    if ((start == QueryUtil.ALL_POS) && (end == QueryUtil.ALL_POS)) {
      solrQuery.setRows(0);
    }
 else {
      solrQuery.setRows(end - start);
      solrQuery.setStart(start);
    }
    if ((sorts != null) && (sorts.length > 0)) {
      for (int i=0; i < sorts.length; i++) {
        Sort sortField=sorts[i];
        if (sortField == null) {
          continue;
        }
        String sortFieldName=sortField.getFieldName();
        ORDER order=ORDER.asc;
        if (sortFieldName == null) {
          sortFieldName="score";
          order=ORDER.desc;
        }
 else         if (sortField.isReverse()) {
          order=ORDER.desc;
        }
        solrQuery.addSortField(sortFieldName,order);
      }
    }
    return solrQuery;
  }
 catch (  Exception e) {
    _log.error(e,e);
    throw new SearchException(e.getMessage());
  }
}
