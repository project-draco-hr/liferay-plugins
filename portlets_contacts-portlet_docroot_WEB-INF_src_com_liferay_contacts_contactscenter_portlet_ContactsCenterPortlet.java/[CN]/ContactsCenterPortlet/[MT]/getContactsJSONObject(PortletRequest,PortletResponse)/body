{
  ThemeDisplay themeDisplay=(ThemeDisplay)portletRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String redirect=ParamUtil.getString(portletRequest,"redirect");
  String filterBy=ParamUtil.getString(portletRequest,"filterBy");
  String keywords=ParamUtil.getString(portletRequest,"keywords");
  int start=ParamUtil.getInteger(portletRequest,"start");
  int end=ParamUtil.getInteger(portletRequest,"end");
  JSONObject jsonObject=JSONFactoryUtil.createJSONObject();
  JSONObject optionsJSONObject=JSONFactoryUtil.createJSONObject();
  optionsJSONObject.put("end",end);
  optionsJSONObject.put("filterBy",filterBy);
  optionsJSONObject.put("keywords",keywords);
  optionsJSONObject.put("start",start);
  jsonObject.put("options",optionsJSONObject);
  PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
  String portletId=portletDisplay.getId();
  JSONArray jsonArray=JSONFactoryUtil.createJSONArray();
  if (filterBy.equals(ContactsConstants.FILTER_BY_DEFAULT) && !portletId.equals(PortletKeys.MEMBERS)) {
    List<BaseModel<?>> contacts=EntryLocalServiceUtil.searchUsersAndContacts(themeDisplay.getCompanyId(),themeDisplay.getUserId(),keywords,start,end);
    int contactsCount=EntryLocalServiceUtil.searchUsersAndContactsCount(themeDisplay.getCompanyId(),themeDisplay.getUserId(),keywords);
    jsonObject.put("count",contactsCount);
    for (    BaseModel<?> contact : contacts) {
      JSONObject contactJSONObject=null;
      if (contact instanceof User) {
        contactJSONObject=getUserJSONObject(portletResponse,themeDisplay,(User)contact);
      }
 else {
        contactJSONObject=getEntryJSONObject(portletResponse,themeDisplay,(Entry)contact,redirect);
      }
      jsonArray.put(contactJSONObject);
    }
  }
 else   if (filterBy.equals(ContactsConstants.FILTER_BY_TYPE_MY_CONTACTS) && !portletId.equals(PortletKeys.MEMBERS)) {
    List<Entry> entries=EntryLocalServiceUtil.search(themeDisplay.getUserId(),keywords,start,end);
    int entriesCount=EntryLocalServiceUtil.searchCount(themeDisplay.getUserId(),keywords);
    jsonObject.put("count",entriesCount);
    for (    Entry entry : entries) {
      JSONObject contactJSONObject=getEntryJSONObject(portletResponse,themeDisplay,entry,redirect);
      jsonArray.put(contactJSONObject);
    }
  }
 else {
    LinkedHashMap<String,Object> params=new LinkedHashMap<String,Object>();
    Group group=themeDisplay.getScopeGroup();
    Layout layout=themeDisplay.getLayout();
    if (group.isUser() && layout.isPublicLayout()) {
      params.put("socialRelation",new Long[]{group.getClassPK()});
    }
 else     if (filterBy.startsWith(ContactsConstants.FILTER_BY_TYPE)) {
      params.put("socialRelationType",new Long[]{themeDisplay.getUserId(),ContactsUtil.getSocialRelationType(filterBy)});
    }
    if (portletId.equals(PortletKeys.MEMBERS)) {
      params.put("usersGroups",group.getGroupId());
    }
 else     if (filterBy.startsWith(ContactsConstants.FILTER_BY_GROUP)) {
      params.put("usersGroups",ContactsUtil.getGroupId(filterBy));
    }
    int usersCount=UserLocalServiceUtil.searchCount(themeDisplay.getCompanyId(),keywords,WorkflowConstants.STATUS_APPROVED,params);
    jsonObject.put("count",usersCount);
    List<User> users=UserLocalServiceUtil.search(themeDisplay.getCompanyId(),keywords,WorkflowConstants.STATUS_APPROVED,params,start,end,new UserLastNameComparator(true));
    for (    User user : users) {
      JSONObject userJSONObject=getUserJSONObject(portletResponse,themeDisplay,user);
      jsonArray.put(userJSONObject);
    }
  }
  jsonObject.put("users",jsonArray);
  return jsonObject;
}
