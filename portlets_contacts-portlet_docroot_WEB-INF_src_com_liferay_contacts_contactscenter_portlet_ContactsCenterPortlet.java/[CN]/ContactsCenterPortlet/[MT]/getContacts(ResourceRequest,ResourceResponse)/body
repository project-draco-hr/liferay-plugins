{
  ThemeDisplay themeDisplay=(ThemeDisplay)resourceRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String keywords=ParamUtil.getString(resourceRequest,"keywords");
  int socialRelationType=ParamUtil.getInteger(resourceRequest,"socialRelationType");
  int start=ParamUtil.getInteger(resourceRequest,"start");
  int end=ParamUtil.getInteger(resourceRequest,"end");
  JSONObject jsonObject=JSONFactoryUtil.createJSONObject();
  JSONObject optionsJSONObject=JSONFactoryUtil.createJSONObject();
  optionsJSONObject.put("end",end);
  optionsJSONObject.put("keywords",keywords);
  optionsJSONObject.put("socialRelationType",socialRelationType);
  optionsJSONObject.put("start",start);
  jsonObject.put("options",optionsJSONObject);
  Group group=themeDisplay.getScopeGroup();
  Layout layout=themeDisplay.getLayout();
  LinkedHashMap<String,Object> params=new LinkedHashMap<String,Object>();
  if (group.isUser() && layout.isPublicLayout()) {
    params.put("socialRelation",new Long[]{group.getClassPK()});
  }
 else   if (socialRelationType != 0) {
    params.put("socialRelationType",new Long[]{themeDisplay.getUserId(),new Long(socialRelationType)});
  }
  if (_showOnlySiteMembers) {
    params.put("usersGroups",new Long(group.getGroupId()));
  }
  List<User> users=UserLocalServiceUtil.search(themeDisplay.getCompanyId(),keywords,WorkflowConstants.STATUS_APPROVED,params,start,end,new UserLastNameComparator(true));
  int usersCount=UserLocalServiceUtil.searchCount(themeDisplay.getCompanyId(),keywords,WorkflowConstants.STATUS_APPROVED,params);
  jsonObject.put("count",usersCount);
  JSONArray jsonArray=JSONFactoryUtil.createJSONArray();
  for (  User user : users) {
    JSONObject userJSONObject=JSONFactoryUtil.createJSONObject();
    userJSONObject.put("emailAddress",user.getEmailAddress());
    userJSONObject.put("firstName",user.getFirstName());
    userJSONObject.put("fullName",user.getFullName());
    userJSONObject.put("jobTitle",user.getJobTitle());
    userJSONObject.put("lastName",user.getLastName());
    userJSONObject.put("portraitURL",user.getPortraitURL(themeDisplay));
    userJSONObject.put("userId",String.valueOf(user.getUserId()));
    LiferayPortletResponse liferayPortletResponse=(LiferayPortletResponse)resourceResponse;
    PortletURL viewSummaryURL=liferayPortletResponse.createRenderURL();
    viewSummaryURL.setWindowState(LiferayWindowState.EXCLUSIVE);
    viewSummaryURL.setParameter("mvcPath","/contacts_center/view_resources.jsp");
    viewSummaryURL.setParameter("userId",String.valueOf(user.getUserId()));
    userJSONObject.put("viewSummaryURL",viewSummaryURL.toString());
    jsonArray.put(userJSONObject);
  }
  jsonObject.put("users",jsonArray);
  writeJSON(resourceRequest,resourceResponse,jsonObject);
}
