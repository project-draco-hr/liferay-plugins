{
  ThemeDisplay themeDisplay=(ThemeDisplay)renderRequest.getAttribute(WebKeys.THEME_DISPLAY);
  PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
  Gadget gadget=getGadget();
  GadgetSpec gadgetSpec=ShindigUtil.getGadgetSpec(gadget);
  Map<String,UserPref> userPrefs=gadgetSpec.getUserPrefs();
  String portletId=PortalUtil.getPortletId(renderRequest);
  Portlet portlet=PortletLocalServiceUtil.getPortletById(themeDisplay.getCompanyId(),portletId);
  String urlConfiguration=portletDisplay.getURLConfiguration();
  if ((userPrefs != null) && !userPrefs.isEmpty()) {
    urlConfiguration=urlConfiguration.replaceAll("edit_permissions","edit_configuration");
    portlet.setConfigurationActionClass(_CONFIGURATION_ACTION_CLASS);
  }
 else {
    urlConfiguration=urlConfiguration.replaceAll("edit_configuration","edit_permissions");
    portlet.setConfigurationActionClass(null);
  }
  portletDisplay.setURLConfiguration(urlConfiguration);
  renderRequest.setAttribute(WebKeys.GADGET,gadget);
}
