{
  User user=getUser();
  SyncDevice syncDevice=syncDeviceLocalService.fetchSyncDeviceByUuidAndCompanyId(uuid,user.getCompanyId());
  if (syncDevice == null) {
    syncDevice=syncDeviceLocalService.addSyncDevice(user.getUserId(),type,buildNumber,featureSet);
    return syncDevice.getUuid();
  }
  if (syncDevice.getUserId() != user.getUserId()) {
    throw new PrincipalException();
  }
  syncDeviceLocalService.updateSyncDevice(syncDevice.getSyncDeviceId(),type,buildNumber,featureSet,syncDevice.getStatus());
  return syncDevice.getUuid();
}
