{
  GoogleDriveSession googleDriveSession=null;
  HttpSession httpSession=PortalSessionThreadLocal.getHttpSession();
  if (httpSession != null) {
    TransientValue<GoogleDriveSession> transientValue=(TransientValue<GoogleDriveSession>)httpSession.getAttribute(GoogleDriveSession.class.getName());
    if (transientValue != null) {
      googleDriveSession=transientValue.getValue();
    }
  }
 else {
    googleDriveSession=_googleDriveSessionThreadLocal.get();
  }
  if (googleDriveSession != null) {
    return googleDriveSession;
  }
  try {
    googleDriveSession=buildGoogleDriveSession();
  }
 catch (  Exception e) {
    throw new PrincipalException(e);
  }
  if (httpSession != null) {
    httpSession.setAttribute(GoogleDriveSession.class.getName(),new TransientValue<GoogleDriveSession>(googleDriveSession));
  }
 else {
    _googleDriveSessionThreadLocal.set(googleDriveSession);
  }
  return googleDriveSession;
}
