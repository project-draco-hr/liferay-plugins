{
  ThemeDisplay themeDisplay=(ThemeDisplay)request.getAttribute(WebKeys.THEME_DISPLAY);
  String cmd=ParamUtil.getString(request,Constants.CMD);
  String redirectUri=PortalUtil.getPortalURL(request) + _REDIRECT_URI;
  if (cmd.equals("login")) {
    GoogleAuthorizationCodeFlow googleAuthorizationCodeFlow=getGoogleAuthorizationCodeFlow(themeDisplay.getCompanyId());
    GoogleAuthorizationCodeRequestUrl googleAuthorizationCodeRequestUrl=googleAuthorizationCodeFlow.newAuthorizationUrl();
    googleAuthorizationCodeRequestUrl.setRedirectUri(redirectUri);
    String url=googleAuthorizationCodeRequestUrl.build();
    response.sendRedirect(url);
  }
 else   if (cmd.equals("token")) {
    HttpSession session=request.getSession();
    String code=ParamUtil.getString(request,"code");
    if (Validator.isNotNull(code)) {
      Credential credential=exchangeCode(themeDisplay.getCompanyId(),code,redirectUri);
      User user=setGoogleCredentials(session,themeDisplay.getCompanyId(),credential);
      if ((user != null) && (user.getStatus() == WorkflowConstants.STATUS_INCOMPLETE)) {
        redirectUpdateAccount(request,response,user);
        return null;
      }
      sendLoginRedirect(request,response);
      return null;
    }
    String error=ParamUtil.getString(request,"error");
    if (error.equals("access_denied")) {
      sendLoginRedirect(request,response);
      return null;
    }
  }
  return null;
}
