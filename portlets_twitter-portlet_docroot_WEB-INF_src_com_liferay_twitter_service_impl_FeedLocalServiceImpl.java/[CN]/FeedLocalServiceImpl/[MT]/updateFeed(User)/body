{
  Contact contact=user.getContact();
  String twitterScreenName=contact.getTwitterSn();
  if (Validator.isNull(twitterScreenName)) {
    throw new FeedTwitterScreenNameException();
  }
  Feed feed=feedPersistence.fetchByU_TSN(user.getUserId(),twitterScreenName);
  JSONArray jsonArray=null;
  Date now=new Date();
  if (feed == null) {
    jsonArray=TimelineProcessorUtil.getUserTimelineJSONArray(twitterScreenName,0);
    long feedId=counterLocalService.increment();
    feed=feedPersistence.create(feedId);
    feed.setCompanyId(user.getCompanyId());
    feed.setUserId(user.getUserId());
    feed.setUserName(user.getFullName());
    feed.setCreateDate(now);
    feed.setModifiedDate(now);
    feed.setTwitterScreenName(twitterScreenName);
    feedPersistence.update(feed);
    if (jsonArray == null) {
      return;
    }
  }
  if (jsonArray == null) {
    jsonArray=TimelineProcessorUtil.getUserTimelineJSONArray(twitterScreenName,feed.getLastStatusId());
  }
  if ((jsonArray == null) || (jsonArray.length() == 0)) {
    return;
  }
  try {
    for (int i=0; i < jsonArray.length(); i++) {
      JSONObject statusJSONObject=jsonArray.getJSONObject(i);
      SimpleDateFormat sdf=new SimpleDateFormat("EEE MMM d hh:mm:ss Z yyyy");
      Date createDate=null;
      try {
        createDate=sdf.parse(statusJSONObject.getString("created_at"));
      }
 catch (      ParseException pe) {
        throw new SystemException(pe);
      }
      long statusId=statusJSONObject.getLong("id");
      String text=statusJSONObject.getString("text");
      if (feed.getTwitterUserId() <= 0) {
        JSONObject userJSONObject=statusJSONObject.getJSONObject("user");
        feed.setTwitterUserId(userJSONObject.getLong("id"));
      }
      if (feed.getLastStatusId() < statusId) {
        feed.setLastStatusId(statusId);
      }
      JSONObject extraDataJSONObject=JSONFactoryUtil.createJSONObject();
      extraDataJSONObject.put("text",text);
      SocialActivityLocalServiceUtil.addActivity(user.getUserId(),0,createDate,Feed.class.getName(),statusId,TwitterActivityKeys.ADD_STATUS,extraDataJSONObject.toString(),0);
    }
  }
  finally {
    feed.setModifiedDate(now);
    feedPersistence.update(feed);
  }
}
