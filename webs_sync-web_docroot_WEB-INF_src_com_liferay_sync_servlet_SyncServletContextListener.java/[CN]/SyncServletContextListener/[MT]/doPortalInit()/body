{
  _messageListener=new SyncMessageListener();
  SerialDestination serialDestination=new SerialDestination();
  serialDestination.setName(DestinationNames.DOCUMENT_LIBRARY_SYNC_EVENT_PROCESSOR);
  serialDestination.afterPropertiesSet();
  MessageBusUtil.addDestination(serialDestination);
  MessageBusUtil.registerMessageListener(DestinationNames.DOCUMENT_LIBRARY_SYNC_EVENT_PROCESSOR,_messageListener);
  try {
    long latestModifiedTime=SyncDLObjectLocalServiceUtil.getLatestModifiedTime();
    List<DLSyncEvent> dlSyncEvents=null;
    if (latestModifiedTime == 0) {
      dlSyncEvents=DLSyncEventLocalServiceUtil.getLatestDLSyncEvents();
    }
 else {
      dlSyncEvents=DLSyncEventLocalServiceUtil.getDLSyncEvents(latestModifiedTime);
    }
    for (    DLSyncEvent dlSyncEvent : dlSyncEvents) {
      Message message=new Message();
      Map<String,Object> values=new HashMap<String,Object>(4);
      values.put("event",dlSyncEvent.getEvent());
      values.put("modifiedTime",dlSyncEvent.getModifiedTime());
      values.put("type",dlSyncEvent.getType());
      values.put("typePK",dlSyncEvent.getTypePK());
      message.setValues(values);
      MessageBusUtil.sendMessage(DestinationNames.DOCUMENT_LIBRARY_SYNC_EVENT_PROCESSOR,message);
    }
    DLSyncEventLocalServiceUtil.deleteDLSyncEvents();
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
}
