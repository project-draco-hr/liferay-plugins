{
  try {
    List<Company> companies=CompanyLocalServiceUtil.getCompanies();
    for (    Company company : companies) {
      boolean oAuthEnabled=PrefsPropsUtil.getBoolean(company.getCompanyId(),PortletPropsKeys.SYNC_OAUTH_ENABLED,PortletPropsValues.SYNC_OAUTH_ENABLED);
      if (!oAuthEnabled) {
        continue;
      }
      User user=UserLocalServiceUtil.getDefaultUser(company.getCompanyId());
      ServiceContext serviceContext=new ServiceContext();
      serviceContext.setUserId(user.getUserId());
      OAuthApplication oAuthApplication=SyncPreferencesLocalServiceUtil.enableOAuth(company.getCompanyId(),serviceContext);
      PortletPreferences portletPreferences=PrefsPropsUtil.getPreferences(company.getCompanyId());
      portletPreferences.setValue(PortletPropsKeys.SYNC_OAUTH_APPLICATION_ID,String.valueOf(oAuthApplication.getOAuthApplicationId()));
      portletPreferences.setValue(PortletPropsKeys.SYNC_OAUTH_CONSUMER_KEY,oAuthApplication.getConsumerKey());
      portletPreferences.setValue(PortletPropsKeys.SYNC_OAUTH_CONSUMER_SECRET,oAuthApplication.getConsumerSecret());
      portletPreferences.store();
    }
  }
 catch (  Exception e) {
    _log.error(e,e);
  }
  _syncDLObjectMessageListener=new SyncDLObjectMessageListener();
  registerMessageListener(_syncDLObjectMessageListener,DestinationNames.DOCUMENT_LIBRARY_SYNC_EVENT_PROCESSOR);
  if (PortletPropsValues.SYNC_FILE_DIFF_CACHE_ENABLED) {
    _syncDLFileVersionDiffMessageListener=new SyncDLFileVersionDiffMessageListener();
    registerMessageListener(_syncDLFileVersionDiffMessageListener,SyncDLFileVersionDiffMessageListener.DESTINATION_NAME);
    scheduleDLFileVersionDiffMessageListener();
  }
  consumeDLSyncEvents();
}
