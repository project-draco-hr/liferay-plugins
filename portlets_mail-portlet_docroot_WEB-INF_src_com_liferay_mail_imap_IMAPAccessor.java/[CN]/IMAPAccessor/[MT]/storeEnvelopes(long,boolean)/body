{
  IMAPFolder imapFolder=null;
  try {
    if (!FolderLocalServiceUtil.exists(folderId)) {
      return;
    }
    imapFolder=openFolder(folderId);
    com.liferay.mail.model.Folder folder=FolderLocalServiceUtil.getFolder(folderId);
    int messageCount=imapFolder.getMessageCount();
    FolderLocalServiceUtil.updateFolder(folderId,folder.getFullName(),folder.getDisplayName(),messageCount);
    if (messageCount == 0) {
      return;
    }
    Message oldestJxMessage=getMessage(folderId,imapFolder,true);
    Message newestJxMessage=getMessage(folderId,imapFolder,false);
    Message[] jxMessages=new Message[0];
    if (allMessages) {
      if (_log.isDebugEnabled()) {
        _log.debug("Downloading all messages from folder " + imapFolder.getFullName());
      }
      jxMessages=imapFolder.getMessages();
    }
 else     if ((oldestJxMessage == null) && (newestJxMessage == null)) {
      if (_log.isDebugEnabled()) {
        _log.debug("Downloading messages from folder " + imapFolder.getFullName() + " for the first time");
      }
      int startingMessageNumber=messageCount - PortletPropsValues.MESSAGES_SYNC_COUNT;
      if (startingMessageNumber < 1) {
        startingMessageNumber=1;
      }
      jxMessages=imapFolder.getMessages(startingMessageNumber,messageCount);
    }
 else {
      int oldestMessageNumber=oldestJxMessage.getMessageNumber();
      int newestMessageNumber=newestJxMessage.getMessageNumber();
      if (newestMessageNumber != messageCount) {
        if (_log.isDebugEnabled()) {
          _log.debug("Downloading new messages from folder " + imapFolder.getFullName());
        }
        jxMessages=imapFolder.getMessages(newestMessageNumber + 1,messageCount);
      }
 else       if (oldestMessageNumber != 1) {
        if (_log.isDebugEnabled()) {
          _log.debug("Downloading old messages from folder " + imapFolder.getFullName());
        }
        int startingMessageNumber=oldestMessageNumber - PortletPropsValues.MESSAGES_SYNC_COUNT;
        if (startingMessageNumber < 1) {
          startingMessageNumber=1;
        }
        jxMessages=imapFolder.getMessages(startingMessageNumber,oldestMessageNumber - 1);
      }
    }
    storeEnvelopes(folderId,imapFolder,jxMessages);
  }
 catch (  MessagingException me) {
    throw new MailException(me);
  }
 finally {
    closeFolder(imapFolder,false);
  }
}
