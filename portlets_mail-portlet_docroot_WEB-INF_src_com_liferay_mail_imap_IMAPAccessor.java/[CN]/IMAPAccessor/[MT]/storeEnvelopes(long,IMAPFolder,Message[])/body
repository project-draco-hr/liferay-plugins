{
  StopWatch stopWatch=null;
  if (_log.isDebugEnabled()) {
    stopWatch=new StopWatch();
    stopWatch.start();
  }
  try {
    FetchProfile fetchProfile=new FetchProfile();
    fetchProfile.add(UIDFolder.FetchProfileItem.UID);
    fetchProfile.add(UIDFolder.FetchProfileItem.ENVELOPE);
    imapFolder.fetch(jxMessages,fetchProfile);
    for (    Message jxMessage : jxMessages) {
      String sender=InternetAddressUtil.toString(jxMessage.getFrom());
      String to=InternetAddressUtil.toString(jxMessage.getRecipients(RecipientType.TO));
      String cc=InternetAddressUtil.toString(jxMessage.getRecipients(RecipientType.CC));
      String bcc=InternetAddressUtil.toString(jxMessage.getRecipients(RecipientType.BCC));
      Date sentDate=jxMessage.getSentDate();
      String subject=jxMessage.getSubject();
      long remoteMessageId=imapFolder.getUID(jxMessage);
      MessageLocalServiceUtil.addMessage(_user.getUserId(),folderId,sender,to,cc,bcc,sentDate,subject,StringPool.BLANK,StringPool.BLANK,remoteMessageId);
    }
    com.liferay.mail.model.Folder folder=FolderLocalServiceUtil.getFolder(folderId);
    FolderLocalServiceUtil.updateFolder(folderId,folder.getFullName(),folder.getDisplayName(),imapFolder.getMessageCount());
  }
 catch (  MessagingException me) {
    throw new MailException(me);
  }
  if (_log.isDebugEnabled()) {
    stopWatch.stop();
    _log.debug("Downloaded " + jxMessages.length + " messages from folder "+ imapFolder.getFullName()+ " completed in "+ stopWatch.getTime()+ " ms");
  }
}
