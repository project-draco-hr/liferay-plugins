{
  IMAPFolder imapFolder=null;
  try {
    imapFolder=openFolder(folderId);
    List<Message> jxMessages=getMessages(imapFolder,messageIds,deleteMissingMessages);
    for (    Message jxMessage : jxMessages) {
      if (flag == MailConstants.FLAG_FLAGGED) {
        jxMessage.setFlag(Flags.Flag.FLAGGED,value);
      }
 else       if (flag == MailConstants.FLAG_SEEN) {
        jxMessage.setFlag(Flags.Flag.SEEN,value);
      }
 else {
        throw new MailException(MailException.MESSAGE_INVALID_FLAG);
      }
    }
  }
 catch (  MessagingException me) {
    throw new MailException(me);
  }
 finally {
    closeFolder(imapFolder,true);
  }
}
