{
  String uri=(String)servletRequest.getAttribute(WebKeys.INVOKER_FILTER_URI);
  HttpServletRequest httpServletRequest=(HttpServletRequest)servletRequest;
  if (uri.equals("/api/jsonws/invoke")) {
    SyncJSONHttpServletRequestWrapper syncJSONhttpServletRequestWrapper=new SyncJSONHttpServletRequestWrapper(httpServletRequest);
    servletRequest=syncJSONhttpServletRequestWrapper;
    if (!syncJSONhttpServletRequestWrapper.isSyncJSONRequest()) {
      filterChain.doFilter(servletRequest,servletResponse);
      return;
    }
  }
 else   if (!uri.startsWith("/api/jsonws/sync-web.")) {
    filterChain.doFilter(servletRequest,servletResponse);
    return;
  }
  if (ParamUtil.get(httpServletRequest,"debug",false)) {
    filterChain.doFilter(servletRequest,servletResponse);
    return;
  }
  Throwable throwable=null;
  if (PrefsPropsUtil.getBoolean(PortalUtil.getCompanyId(httpServletRequest),PortletPropsKeys.SYNC_SERVICES_ENABLED,PortletPropsValues.SYNC_SERVICES_ENABLED)) {
    String syncDevice=httpServletRequest.getHeader("Sync-Device");
    if (syncDevice == null) {
      throwable=new SyncDeviceHeaderException();
    }
 else     if (syncDevice.startsWith("desktop")) {
      int syncBuild=httpServletRequest.getIntHeader("Sync-Build");
      int syncClientDesktopMinBuild=PrefsPropsUtil.getInteger(PortalUtil.getCompanyId(httpServletRequest),PortletPropsKeys.SYNC_CLIENT_DESKTOP_MIN_BUILD,PortletPropsValues.SYNC_CLIENT_DESKTOP_MIN_BUILD);
      if (syncClientDesktopMinBuild < _ABSOLUTE_SYNC_CLIENT_DESKTOP_MIN_BUILD) {
        syncClientDesktopMinBuild=_ABSOLUTE_SYNC_CLIENT_DESKTOP_MIN_BUILD;
      }
      if (syncBuild >= syncClientDesktopMinBuild) {
        filterChain.doFilter(servletRequest,servletResponse);
        return;
      }
 else {
        throwable=new SyncClientMinBuildException("Sync client does not meet minimum build " + syncClientDesktopMinBuild);
      }
    }
 else     if (syncDevice.startsWith("mobile")) {
      filterChain.doFilter(servletRequest,servletResponse);
      return;
    }
 else {
      throwable=new SyncDeviceHeaderException();
    }
  }
 else {
    throwable=new SyncServicesUnavailableException();
  }
  servletResponse.setCharacterEncoding(StringPool.UTF8);
  servletResponse.setContentType(ContentTypes.APPLICATION_JSON);
  OutputStream outputStream=servletResponse.getOutputStream();
  String json=SyncUtil.buildExceptionMessage(throwable);
  json="{\"exception\": \"" + json + "\"}";
  outputStream.write(json.getBytes(StringPool.UTF8));
  outputStream.close();
}
