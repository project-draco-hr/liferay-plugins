{
  SolrQuery solrQuery=translateQuery(searchContext.getCompanyId(),query,searchContext.getSorts(),searchContext.getStart(),searchContext.getEnd());
  QueryConfig queryConfig=query.getQueryConfig();
  addFacets(solrQuery,searchContext);
  addHighlights(solrQuery,queryConfig);
  addPagination(solrQuery,searchContext.getStart(),searchContext.getEnd());
  addSelectedFields(solrQuery,queryConfig);
  QueryResponse queryResponse=_solrServer.query(solrQuery,METHOD.POST);
  boolean allResults=false;
  if (solrQuery.getRows() == 0) {
    allResults=true;
  }
  List<FacetField> facetFields=queryResponse.getFacetFields();
  if (facetFields != null) {
    Map<String,Facet> facets=searchContext.getFacets();
    for (    FacetField facetField : facetFields) {
      Facet facet=facets.get(facetField.getName());
      FacetCollector facetCollector=null;
      if (facet instanceof RangeFacet) {
        facetCollector=new SolrFacetQueryCollector(facetField.getName(),queryResponse.getFacetQuery());
      }
 else {
        facetCollector=new SolrFacetFieldCollector(facetField.getName(),facetField);
      }
      facet.setFacetCollector(facetCollector);
    }
  }
  return subset(solrQuery,query,query.getQueryConfig(),queryResponse,allResults);
}
