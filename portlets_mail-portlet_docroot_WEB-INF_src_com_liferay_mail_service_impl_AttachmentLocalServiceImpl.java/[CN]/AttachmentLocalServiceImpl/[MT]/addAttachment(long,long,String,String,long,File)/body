{
  User user=userPersistence.findByPrimaryKey(userId);
  Message message=messagePersistence.findByPrimaryKey(messageId);
  long attachmentId=counterLocalService.increment();
  Attachment attachment=attachmentPersistence.create(attachmentId);
  attachment.setCompanyId(user.getCompanyId());
  attachment.setUserId(user.getUserId());
  attachment.setAccountId(message.getAccountId());
  attachment.setFolderId(message.getFolderId());
  attachment.setMessageId(messageId);
  attachment.setContentPath(contentPath);
  attachment.setFileName(fileName);
  attachment.setSize(size);
  attachmentPersistence.update(attachment,false);
  if (file != null) {
    String directoryPath=getDirectoryPath(attachment.getMessageId());
    try {
      DLServiceUtil.addDirectory(attachment.getCompanyId(),_REPOSITORY_ID,directoryPath);
    }
 catch (    DuplicateDirectoryException dde) {
    }
    String filePath=getFilePath(attachment.getMessageId(),fileName);
    try {
      DLServiceUtil.addFile(attachment.getCompanyId(),_PORTLET_ID,_GROUP_ID,_REPOSITORY_ID,filePath,0,StringPool.BLANK,new Date(),new ServiceContext(),file);
    }
 catch (    DuplicateFileException dfe) {
      if (_log.isDebugEnabled()) {
        _log.debug(dfe,dfe);
      }
    }
  }
  return attachment;
}
