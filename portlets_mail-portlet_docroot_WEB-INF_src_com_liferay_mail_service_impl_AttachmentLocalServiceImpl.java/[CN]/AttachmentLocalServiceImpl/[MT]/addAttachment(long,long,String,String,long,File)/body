{
  User user=userPersistence.findByPrimaryKey(userId);
  Message message=messagePersistence.findByPrimaryKey(messageId);
  long attachmentId=counterLocalService.increment();
  Attachment attachment=attachmentPersistence.create(attachmentId);
  attachment.setCompanyId(user.getCompanyId());
  attachment.setUserId(user.getUserId());
  attachment.setAccountId(message.getAccountId());
  attachment.setFolderId(message.getFolderId());
  attachment.setMessageId(messageId);
  attachment.setContentPath(contentPath);
  attachment.setFileName(fileName);
  attachment.setSize(size);
  attachmentPersistence.update(attachment,false);
  if (file != null) {
    String directoryPath=getDirectoryPath(attachment.getMessageId());
    try {
      DLStoreUtil.addDirectory(attachment.getCompanyId(),_REPOSITORY_ID,directoryPath);
    }
 catch (    DuplicateDirectoryException dde) {
    }
    String filePath=getFilePath(attachment.getMessageId(),fileName);
    if (file.exists()) {
      try {
        DLStoreUtil.addFile(attachment.getCompanyId(),_REPOSITORY_ID,filePath,file);
      }
 catch (      DuplicateFileException dfe) {
        if (_log.isDebugEnabled()) {
          _log.debug(dfe,dfe);
        }
      }
    }
 else {
      throw new PortalException(new FileNotFoundException());
    }
  }
  return attachment;
}
