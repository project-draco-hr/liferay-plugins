{
  WSRPProducer wsrpProducer=getWSRPProducer();
  Http.Options httpOptions=new Http.Options();
  addHeaders(performBlockingInteraction.getMarkupParams(),httpOptions);
  httpOptions.setLocation(getURL(performBlockingInteraction,wsrpProducer));
  RuntimeContext runtimeContext=performBlockingInteraction.getRuntimeContext();
  PortletContext portletContext=performBlockingInteraction.getPortletContext();
  InteractionParams interactionParams=performBlockingInteraction.getInteractionParams();
  UploadContext[] uploadContexts=interactionParams.getUploadContexts();
  if (uploadContexts != null) {
    for (    UploadContext uploadContext : uploadContexts) {
      NamedString mimeAttribute=uploadContext.getMimeAttributes(0);
      String[] mimeAttributeValues=StringUtil.split(mimeAttribute.getValue(),StringPool.SEMICOLON);
      String name=StringUtil.replace(mimeAttributeValues[1],"name=",StringPool.BLANK);
      name=StringUtil.trim(name);
      String fileName=StringUtil.replace(mimeAttributeValues[2],"filename=",StringPool.BLANK);
      fileName=StringUtil.trim(fileName);
      String contentType=uploadContext.getMimeType();
      String charSet=null;
      if (contentType.contains(StringPool.SEMICOLON)) {
        int pos=contentType.indexOf(StringPool.SEMICOLON);
        charSet=contentType.substring(pos + 1);
        charSet=StringUtil.trim(charSet);
        contentType=contentType.substring(0,pos);
      }
      httpOptions.addFilePart(name,fileName,uploadContext.getUploadData(),contentType,charSet);
    }
  }
  MarkupParams markupParams=performBlockingInteraction.getMarkupParams();
  NavigationalContext navigationalContext=markupParams.getNavigationalContext();
  String namespace=PortalUtil.getPortletNamespace(getPortletId(portletContext,navigationalContext));
  NamedString[] formParameters=interactionParams.getFormParameters();
  if (formParameters != null) {
    for (    NamedString formParameter : formParameters) {
      String name=StringUtil.replace(formParameter.getName(),runtimeContext.getNamespacePrefix(),StringPool.BLANK);
      httpOptions.addPart(namespace + name,formParameter.getValue());
    }
  }
  httpOptions.setFollowRedirects(false);
  httpOptions.setPost(true);
  String rawContent=getRawContent(httpOptions);
  Http.Response response=httpOptions.getResponse();
  String redirect=response.getRedirect();
  String widgetPath=getWidgetPath();
  BlockingInteractionResponse blockingInteractionResponse=new BlockingInteractionResponse();
  if (Validator.isNotNull(redirect) && !redirect.startsWith(widgetPath)) {
    int pos=redirect.indexOf("wsrp_rewrite?");
    if (pos >= 0) {
      redirect=redirect.substring(pos);
    }
    blockingInteractionResponse.setRedirectURL(redirect);
  }
 else {
    if (Validator.isNotNull(redirect) && redirect.startsWith(widgetPath)) {
      httpOptions.setLocation(redirect);
      rawContent=getRawContent(httpOptions);
    }
    String windowState=getWindowState(performBlockingInteraction.getMarkupParams());
    String content=getContent(rawContent,windowState);
    MarkupContext markupContext=new MarkupContext();
    markupContext.setItemString(content);
    markupContext.setMimeType(ContentTypes.TEXT_HTML_UTF8);
    markupContext.setRequiresRewriting(true);
    UpdateResponse updateResponse=new UpdateResponse();
    updateResponse.setMarkupContext(markupContext);
    blockingInteractionResponse.setUpdateResponse(updateResponse);
  }
  return blockingInteractionResponse;
}
