{
  WSRPProducer wsrpProducer=getWSRPProducer();
  Http.Options httpOptions=new Http.Options();
  addHeaders(getResource.getResourceParams(),httpOptions);
  httpOptions.setLocation(getURL(getResource,wsrpProducer));
  ResourceParams resourceParams=getResource.getResourceParams();
  UploadContext[] uploadContexts=resourceParams.getUploadContexts();
  if (uploadContexts != null) {
    for (    UploadContext uploadContext : uploadContexts) {
      NamedString mimeAttribute=uploadContext.getMimeAttributes(0);
      String[] mimeAttributeValues=StringUtil.split(mimeAttribute.getValue(),StringPool.SEMICOLON);
      String name=StringUtil.replace(mimeAttributeValues[1],"name=",StringPool.BLANK);
      name=StringUtil.trim(name);
      String fileName=StringUtil.replace(mimeAttributeValues[2],"filename=",StringPool.BLANK);
      fileName=StringUtil.trim(fileName);
      String contentType=uploadContext.getMimeType();
      String charSet=null;
      if (contentType.contains(StringPool.SEMICOLON)) {
        int pos=contentType.indexOf(StringPool.SEMICOLON);
        charSet=contentType.substring(pos + 1);
        charSet=StringUtil.trim(charSet);
        contentType=contentType.substring(0,pos);
      }
      httpOptions.addFilePart(name,fileName,uploadContext.getUploadData(),contentType,charSet);
    }
  }
  NamedString[] formParameters=resourceParams.getFormParameters();
  if (formParameters != null) {
    NavigationalContext navigationalContext=resourceParams.getNavigationalContext();
    PortletContext portletContext=getResource.getPortletContext();
    String namespace=PortalUtil.getPortletNamespace(getPortletId(portletContext,navigationalContext));
    for (    NamedString formParameter : formParameters) {
      httpOptions.addPart(namespace + formParameter.getName(),formParameter.getValue());
    }
    if (formParameters.length > 0) {
      httpOptions.setPost(true);
    }
  }
  httpOptions.setFollowRedirects(false);
  byte[] itemBinary=getBinaryContent(httpOptions);
  ResourceContext resourceContext=new ResourceContext();
  Http.Response response=httpOptions.getResponse();
  String contentType=response.getContentType();
  if (itemBinary != null) {
    if (Validator.isNotNull(contentType) && contentType.toLowerCase().startsWith("text")) {
      String content=new String(itemBinary);
      resourceContext.setItemString(content);
      resourceContext.setRequiresRewriting(true);
    }
 else {
      resourceContext.setItemBinary(itemBinary);
    }
  }
  List<NamedString> clientAttributes=new ArrayList<NamedString>();
  String contentDisposition=response.getHeader(HttpHeaders.CONTENT_DISPOSITION);
  if (Validator.isNotNull(contentDisposition)) {
    NamedString clientAttribute=new NamedString();
    clientAttribute.setName(HttpHeaders.CONTENT_DISPOSITION);
    clientAttribute.setValue(contentDisposition);
    clientAttributes.add(clientAttribute);
  }
  if (Validator.isNotNull(contentType)) {
    resourceContext.setMimeType(contentType);
    NamedString clientAttribute=new NamedString();
    clientAttribute.setName(HttpHeaders.CONTENT_TYPE);
    clientAttribute.setValue(contentType);
    clientAttributes.add(clientAttribute);
  }
  int contentLength=response.getContentLength();
  if (contentLength >= 0) {
    NamedString clientAttribute=new NamedString();
    clientAttribute.setName(HttpHeaders.CONTENT_LENGTH);
    clientAttribute.setValue(Integer.toString(contentLength));
    clientAttributes.add(clientAttribute);
  }
  resourceContext.setClientAttributes(clientAttributes.toArray(new NamedString[clientAttributes.size()]));
  ResourceResponse resourceResponse=new ResourceResponse();
  resourceResponse.setResourceContext(resourceContext);
  return resourceResponse;
}
