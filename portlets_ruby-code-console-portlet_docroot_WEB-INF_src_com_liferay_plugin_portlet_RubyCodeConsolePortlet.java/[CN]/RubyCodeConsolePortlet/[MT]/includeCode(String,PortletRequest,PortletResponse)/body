{
  try {
    declareBeans(code,req,res);
  }
 catch (  BSFException bsfe) {
    if (res instanceof MimeResponse) {
      MimeResponse mimeRes=(MimeResponse)res;
      mimeRes.setContentType(ContentTypes.TEXT_HTML_UTF8);
      OutputStream out=mimeRes.getPortletOutputStream();
      Throwable te=bsfe.getTargetException();
      te.printStackTrace(new PrintStream(out,true,StringPool.UTF8));
      out.close();
    }
 else {
      String message="The script included or one of the global files has " + "errors: ";
      Throwable te=bsfe.getTargetException();
      if (te instanceof RaiseException) {
        RubyException re=((RaiseException)te).getException();
        message+=re.message + " (" + re.getMetaClass().toString()+ ")";
        _log.error(message);
        if (_log.isDebugEnabled()) {
          _log.debug("Ruby exception:",te);
        }
      }
 else {
        _log.error(message,te);
      }
    }
  }
}
