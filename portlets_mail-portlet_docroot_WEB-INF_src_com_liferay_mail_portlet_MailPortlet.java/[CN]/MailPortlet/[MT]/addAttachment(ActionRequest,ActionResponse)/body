{
  UploadPortletRequest uploadRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  long userId=ParamUtil.getLong(actionRequest,"userId");
  long messageId=ParamUtil.getLong(actionRequest,"messageId");
  int numOfFiles=ParamUtil.getInteger(actionRequest,"numOfFiles");
  List<ObjectValuePair<String,byte[]>> files=new ArrayList<ObjectValuePair<String,byte[]>>();
  if (numOfFiles == 0) {
    File file=uploadRequest.getFile("file");
    String fileName=uploadRequest.getFileName("file");
    if (file != null) {
      byte[] bytes=FileUtil.getBytes(file);
      AttachmentLocalServiceUtil.addAttachment(userId,messageId,StringPool.BLANK,fileName,bytes.length,file);
    }
  }
 else {
    for (int i=1; i <= numOfFiles; i++) {
      File file=uploadRequest.getFile("file" + i);
      String fileName=uploadRequest.getFileName("file" + i);
      if (file != null) {
        byte[] bytes=FileUtil.getBytes(file);
        AttachmentLocalServiceUtil.addAttachment(userId,messageId,StringPool.BLANK,fileName,bytes.length,file);
      }
    }
  }
}
