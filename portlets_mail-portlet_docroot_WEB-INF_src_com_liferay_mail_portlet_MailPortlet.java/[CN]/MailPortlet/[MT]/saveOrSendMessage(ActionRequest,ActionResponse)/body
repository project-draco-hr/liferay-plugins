{
  UploadPortletRequest uploadReq=PortalUtil.getUploadPortletRequest(req);
  String emailAddress=ParamUtil.getString(uploadReq,"sendEmailAddress");
  MailBoxManager mailBoxManager=new MailBoxManager(PortalUtil.getUser(uploadReq),emailAddress);
  String oldDraftMessageUid=ParamUtil.getString(uploadReq,"sendDraftMessageUid");
  String from=ParamUtil.getString(uploadReq,"sendFrom");
  String to=ParamUtil.getString(uploadReq,"sendTo");
  String cc=ParamUtil.getString(uploadReq,"sendCc");
  String bcc=ParamUtil.getString(uploadReq,"sendBcc");
  String subject=ParamUtil.getString(uploadReq,"sendSubject");
  File attachments=uploadReq.getFile("sendAttachments");
  String body=ParamUtil.getString(uploadReq,"sendBody");
  boolean sendMessage=ParamUtil.getBoolean(uploadReq,"sendMessage");
  Message message=mailBoxManager.createMessage(from,to,cc,bcc,subject,body,new File[]{attachments});
  JSONObject jsonObj=JSONFactoryUtil.createJSONObject();
  if (sendMessage) {
    MailAccount fromMailAccount=new MailAccount(PortalUtil.getUser(uploadReq),from);
    jsonObj=mailBoxManager.sendMessage(fromMailAccount,message);
  }
 else {
    jsonObj=mailBoxManager.saveMessage(message,oldDraftMessageUid);
  }
  ThemeDisplay themeDisplay=(ThemeDisplay)req.getAttribute(WebKeys.THEME_DISPLAY);
  String url=PortalUtil.getLayoutURL(themeDisplay) + "/-/mail/message_result?" + jsonObj.toString();
  String redirect=ParamUtil.getString(uploadReq,"redirect");
  res.sendRedirect(redirect);
}
