{
  UploadPortletRequest uploadReq=PortalUtil.getUploadPortletRequest(req);
  String emailAddress=ParamUtil.getString(uploadReq,"sendEmailAddress");
  MailBoxManager mailBoxManager=new MailBoxManager(PortalUtil.getUser(uploadReq),emailAddress);
  String oldDraftMessageUid=ParamUtil.getString(uploadReq,"sendDraftMessageUid");
  String from=ParamUtil.getString(uploadReq,"sendFrom");
  String to=ParamUtil.getString(uploadReq,"sendTo");
  String cc=ParamUtil.getString(uploadReq,"sendCc");
  String bcc=ParamUtil.getString(uploadReq,"sendBcc");
  String subject=ParamUtil.getString(uploadReq,"sendSubject");
  File attachments=uploadReq.getFile("sendAttachments");
  String body=ParamUtil.getString(uploadReq,"sendBody");
  boolean sendMessage=ParamUtil.getBoolean(uploadReq,"sendMessage");
  long newDraftMessageUid=mailBoxManager.createDraftMessage(oldDraftMessageUid,from,to,cc,bcc,subject,body,null);
  if (sendMessage) {
    MailAccount fromMailAccount=new MailAccount(PortalUtil.getUser(uploadReq),from);
    mailBoxManager.sendMessage(fromMailAccount,newDraftMessageUid);
  }
}
