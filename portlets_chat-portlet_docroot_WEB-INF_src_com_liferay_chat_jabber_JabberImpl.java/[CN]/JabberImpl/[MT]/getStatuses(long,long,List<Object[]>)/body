{
  try {
    Connection connection=getConnection(userId);
    if (connection == null) {
      if (_log.isWarnEnabled()) {
        _log.warn("User " + userId + " is not connected to Jabber");
      }
      return buddies;
    }
    List<Object[]> jabberBuddies=new ArrayList<Object[]>();
    jabberBuddies.addAll(buddies);
    Roster roster=connection.getRoster();
    Collection<RosterEntry> rosterEntries=roster.getEntries();
    if (PortletPropsValues.JABBER_IMPORT_USER_ENABLED) {
      for (      Object[] buddy : buddies) {
        String screenName=(String)buddy[1];
        String firstName=(String)buddy[2];
        String middleName=(String)buddy[3];
        String lastName=(String)buddy[4];
        String fullName=ContactConstants.getFullName(firstName,middleName,lastName);
        String jabberId=getFullJabberId(screenName);
        if (!roster.contains(jabberId)) {
          roster.createEntry(jabberId,fullName,null);
        }
      }
    }
    BuddyComparator buddyComparator=new BuddyComparator(true);
    for (    RosterEntry rosterEntry : rosterEntries) {
      Presence presence=roster.getPresence(rosterEntry.getUser());
      if (!presence.isAvailable()) {
        continue;
      }
      User user=UserLocalServiceUtil.getUserByScreenName(companyId,getScreenName(rosterEntry.getUser()));
      Object[] jabberBuddy=new Object[7];
      jabberBuddy[0]=user.getUserId();
      jabberBuddy[1]=user.getScreenName();
      jabberBuddy[2]=user.getFirstName();
      jabberBuddy[3]=user.getMiddleName();
      jabberBuddy[4]=user.getLastName();
      jabberBuddy[5]=user.getPortraitId();
      jabberBuddy[6]=true;
      if (Collections.binarySearch(jabberBuddies,jabberBuddy,buddyComparator) < 0) {
        jabberBuddies.add(jabberBuddy);
      }
    }
    Collections.sort(jabberBuddies,buddyComparator);
    return jabberBuddies;
  }
 catch (  Exception e) {
    _log.error("Unable to get Jabber buddies",e);
    return buddies;
  }
}
