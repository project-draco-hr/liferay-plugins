{
  User user=userPersistence.fetchByPrimaryKey(userId);
  Date now=new Date();
  validate(remoteAppId,version);
  long appId=counterLocalService.increment();
  App app=appPersistence.create(appId);
  if (user != null) {
    app.setCompanyId(user.getCompanyId());
    app.setUserId(user.getUserId());
    app.setUserName(user.getFullName());
  }
  app.setCreateDate(now);
  app.setModifiedDate(now);
  app.setRemoteAppId(remoteAppId);
  app.setVersion(version);
  appPersistence.update(app,false);
  if (inputStream != null) {
    DLStoreUtil.addFile(app.getCompanyId(),CompanyConstants.SYSTEM,app.getFilePath(),false,inputStream);
  }
  return app;
}
