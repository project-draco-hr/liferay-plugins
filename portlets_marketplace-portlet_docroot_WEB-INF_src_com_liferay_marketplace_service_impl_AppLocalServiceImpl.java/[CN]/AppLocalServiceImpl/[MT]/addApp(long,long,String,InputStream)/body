{
  User user=userPersistence.findByPrimaryKey(userId);
  validate(version,marketplaceAppId);
  Date now=new Date();
  long appId=counterLocalService.increment();
  App app=appPersistence.create(appId);
  app.setAppId(appId);
  app.setCompanyId(user.getCompanyId());
  app.setUserId(user.getUserId());
  app.setUserName(user.getFullName());
  app.setCreateDate(now);
  app.setModifiedDate(now);
  app.setMarketplaceAppId(marketplaceAppId);
  app.setVersion(version);
  appPersistence.update(app,false);
  DLStoreUtil.addFile(app.getCompanyId(),CompanyConstants.SYSTEM,app.getFilePath(),false,is);
  return app;
}
