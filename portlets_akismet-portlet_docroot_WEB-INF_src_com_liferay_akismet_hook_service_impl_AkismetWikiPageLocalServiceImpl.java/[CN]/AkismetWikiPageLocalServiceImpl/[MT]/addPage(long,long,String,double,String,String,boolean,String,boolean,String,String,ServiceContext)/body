{
  int workflowAction=serviceContext.getWorkflowAction();
  if (workflowAction == WorkflowConstants.ACTION_SAVE_DRAFT) {
    return super.addPage(userId,nodeId,redirectTitle,content,summary,minorEdit,serviceContext);
  }
  boolean enabled=isWikiEnabled(userId,nodeId,serviceContext);
  if (enabled) {
    serviceContext.setWorkflowAction(WorkflowConstants.ACTION_SAVE_DRAFT);
  }
  WikiPage page=super.addPage(userId,nodeId,title,version,content,summary,minorEdit,format,head,parentTitle,redirectTitle,serviceContext);
  AkismetData akismetData=updateAkismetData(page,serviceContext);
  if (!enabled) {
    return page;
  }
  String akismetContent=page.getTitle() + "\n\n" + page.getContent();
  if (!AkismetUtil.isSpam(userId,akismetContent,akismetData)) {
    return super.updateStatus(userId,page.getResourcePrimKey(),WorkflowConstants.STATUS_APPROVED,serviceContext);
  }
  boolean notificationEnabled=false;
  try {
    notificationEnabled=NotificationThreadLocal.isEnabled();
    NotificationThreadLocal.setEnabled(false);
    page.setStatus(WorkflowConstants.STATUS_APPROVED);
    page.setSummary(AkismetConstants.WIKI_PAGE_PENDING_APPROVAL);
    page=super.updateWikiPage(page);
    ServiceContext newServiceContext=new ServiceContext();
    newServiceContext.setFormDate(page.getModifiedDate());
    return super.updatePage(userId,nodeId,title,page.getVersion(),null,StringPool.BLANK,true,format,parentTitle,redirectTitle,newServiceContext);
  }
  finally {
    NotificationThreadLocal.setEnabled(notificationEnabled);
  }
}
