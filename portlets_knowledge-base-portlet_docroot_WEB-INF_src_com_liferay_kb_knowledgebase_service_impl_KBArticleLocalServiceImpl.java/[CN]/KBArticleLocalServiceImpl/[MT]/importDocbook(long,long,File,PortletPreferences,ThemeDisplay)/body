{
  ZipReader zipReader=new ZipReader(file);
  Map folderEntries=zipReader.getFolderEntries();
  Set<Entry<String,byte[]>> entries=zipReader.getEntries().entrySet();
  String indexPath=getIndexPath(folderEntries,entries);
  if (indexPath == null) {
    _log.debug("No index file found.");
    return;
  }
  SAXReader reader=new SAXReader(false);
  String rootPath=new File(indexPath).getParent();
  reader.setEntityResolver(new DocBookEntityResolver(rootPath,zipReader));
  String indexContents=zipReader.getEntryAsString(indexPath);
  org.dom4j.Document doc=reader.read(new StringReader(indexContents));
  Element bookEl=doc.getRootElement();
  String htmlTitle=bookEl.element("bookinfo").elementText("title");
  String title=bookEl.attributeValue("id");
  KBArticle bookArticle=addArticle(userId,groupId,title,htmlTitle,StringPool.BLANK,StringPool.BLANK,true,false,false,KBArticleImpl.DEFAULT_PARENT,null,prefs,themeDisplay);
  List<Element> glossaries=bookEl.elements("glossary");
  for (  Element glossaryEl : glossaries) {
    Section section=getSection(glossaryEl,true);
    title=validateTitle(groupId,section.getId());
    htmlTitle=section.getTitle();
    addArticle(userId,groupId,title,htmlTitle,section.getContent(),section.getSubTitle(),true,false,false,bookArticle.getResourcePrimKey(),null,prefs,themeDisplay);
  }
  List<Element> chaptersEl=bookEl.elements("chapter");
  for (  Element chapterEl : chaptersEl) {
    Section section=getSection(chapterEl,false);
    title=validateTitle(groupId,section.getId());
    htmlTitle=section.getTitle();
    KBArticle chapterArticle=addArticle(userId,groupId,title,htmlTitle,section.getContent(),section.getDescription(),true,false,false,bookArticle.getResourcePrimKey(),null,prefs,themeDisplay);
    List<Element> sections=chapterEl.elements("section");
    for (    Element sectionEl : sections) {
      section=getSection(sectionEl,false);
      title=validateTitle(groupId,section.getId());
      htmlTitle=section.getTitle();
      KBArticle sectionArticle=addArticle(userId,groupId,title,htmlTitle,section.getContent(),StringPool.BLANK,true,false,false,chapterArticle.getResourcePrimKey(),null,prefs,themeDisplay);
      List<Element> subSections=sectionEl.elements("section");
      for (      Element subSectionEl : subSections) {
        section=getSection(subSectionEl,true);
        title=validateTitle(groupId,section.getId());
        htmlTitle=section.getTitle();
        addArticle(userId,groupId,title,htmlTitle,section.getContent(),section.getDescription(),true,false,false,sectionArticle.getResourcePrimKey(),null,prefs,themeDisplay);
      }
    }
  }
}
