{
  if (prefs == null) {
    long ownerId=article.getGroupId();
    int ownerType=PortletKeys.PREFS_OWNER_TYPE_GROUP;
    long plid=PortletKeys.PREFS_PLID_SHARED;
    String portletId=KnowledgeBaseKeys.PORTLET_ID;
    String defaultPreferences=null;
    prefs=portletPreferencesLocalService.getPreferences(article.getCompanyId(),ownerId,ownerType,plid,portletId,defaultPreferences);
  }
  Company company=companyPersistence.findByPrimaryKey(article.getCompanyId());
  User user=userPersistence.findByPrimaryKey(article.getUserId());
  Group group=groupPersistence.findByPrimaryKey(article.getGroupId());
  String groupName=group.getName();
  if (group.isUser()) {
    User user2=UserLocalServiceUtil.getUserById(group.getClassPK());
    groupName=user2.getFullName();
  }
 else   if (group.isOrganization()) {
    Organization organization=OrganizationLocalServiceUtil.getOrganization(group.getClassPK());
    groupName=organization.getName();
  }
  String articleURL=StringPool.BLANK;
  if (themeDisplay != null) {
    String portalURL=PortalUtil.getPortalURL(themeDisplay);
    String layoutURL=PortalUtil.getLayoutURL(themeDisplay);
    articleURL=portalURL + layoutURL + StringPool.SLASH+ StringPool.DASH+ StringPool.SLASH+ KnowledgeBaseFriendlyURLMapper.MAPPING+ StringPool.SLASH+ article.getTitle();
  }
  String portletName=LanguageUtil.get(themeDisplay.getLocale(),"knowledge-base");
  String fromName=PrefsPropsUtil.getString(company.getCompanyId(),PortletPropsKeys.ADMIN_EMAIL_FROM_NAME);
  String fromAddress=PrefsPropsUtil.getString(company.getCompanyId(),PortletPropsKeys.ADMIN_EMAIL_FROM_ADDRESS);
  String toName=user.getFullName();
  String toAddress=user.getEmailAddress();
  String subject=StringPool.BLANK;
  String body=StringPool.BLANK;
  String signature=StringPool.BLANK;
  if (update) {
    subject=PortletPrefsPropsUtil.getContent(company.getCompanyId(),PortletPropsKeys.ADMIN_EMAIL_ARTICLE_UPDATED_SUBJECT,getClass().getClassLoader());
    body=PortletPrefsPropsUtil.getContent(company.getCompanyId(),PortletPropsKeys.ADMIN_EMAIL_ARTICLE_UPDATED_BODY,getClass().getClassLoader());
    signature=PortletPrefsPropsUtil.getContent(company.getCompanyId(),PortletPropsKeys.ADMIN_EMAIL_ARTICLE_UPDATED_SIGNATURE,getClass().getClassLoader());
  }
 else {
    subject=PortletPrefsPropsUtil.getContent(company.getCompanyId(),PortletPropsKeys.ADMIN_EMAIL_ARTICLE_ADDED_SUBJECT,getClass().getClassLoader());
    body=PortletPrefsPropsUtil.getContent(company.getCompanyId(),PortletPropsKeys.ADMIN_EMAIL_ARTICLE_ADDED_BODY,getClass().getClassLoader());
    signature=PortletPrefsPropsUtil.getContent(company.getCompanyId(),PortletPropsKeys.ADMIN_EMAIL_ARTICLE_ADDED_SIGNATURE,getClass().getClassLoader());
  }
  subject=StringUtil.replace(subject,new String[]{"[$ARTICLE_CONTENT$]","[$ARTICLE_DESCRIPTION$]","[$ARTICLE_TITLE$]","[$ARTICLE_URL$]","[$COMMUNITY_NAME$]","[$COMPANY_NAME$]","[$FROM_ADDRESS$]","[$FROM_NAME$]","[$PORTAL_URL$]","[$PORTLET_NAME$]","[$TO_NAME$]","[$TO_ADDRESS$]"},new String[]{article.getContent(),article.getDescription(),article.getTitle(),articleURL,groupName,company.getName(),fromAddress,fromName,company.getVirtualHost(),portletName,user.getFullName(),user.getEmailAddress()});
  body=StringUtil.replace(body,new String[]{"[$ARTICLE_CONTENT$]","[$ARTICLE_DESCRIPTION$]","[$ARTICLE_TITLE$]","[$ARTICLE_URL$]","[$COMMUNITY_NAME$]","[$COMPANY_NAME$]","[$FROM_ADDRESS$]","[$FROM_NAME$]","[$PORTAL_URL$]","[$PORTLET_NAME$]","[$TO_NAME$]","[$TO_ADDRESS$]"},new String[]{article.getContent(),article.getDescription(),article.getTitle(),articleURL,groupName,company.getName(),fromAddress,fromName,company.getVirtualHost(),portletName,user.getFullName(),user.getEmailAddress()});
  signature=StringUtil.replace(signature,new String[]{"[$COMPANY_NAME$]"},new String[]{company.getName()});
  body=body + signature;
  InternetAddress from=new InternetAddress(fromAddress,fromName);
  InternetAddress to=new InternetAddress(toAddress,toName);
  MailMessage mailMessage=new MailMessage(from,to,subject,body,true);
  MailServiceUtil.sendEmail(mailMessage);
}
