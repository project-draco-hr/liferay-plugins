{
  User user=userPersistence.findByPrimaryKey(userId);
  int version=ArticleConstants.DEFAULT_VERSION;
  int status=WorkflowConstants.STATUS_DRAFT;
  validate(title,content);
  Article oldArticle=getLatestArticle(resourcePrimKey,WorkflowConstants.STATUS_ANY);
  long oldResourcePrimKey=oldArticle.getResourcePrimKey();
  long oldGroupId=oldArticle.getGroupId();
  Date oldCreateDate=oldArticle.getCreateDate();
  long oldRootResourcePrimKey=oldArticle.getRootResourcePrimKey();
  long oldParentResourcePrimKey=oldArticle.getParentResourcePrimKey();
  int oldVersion=oldArticle.getVersion();
  double oldPriority=oldArticle.getPriority();
  int oldStatus=oldArticle.getStatus();
  Article article=null;
  if (oldStatus == WorkflowConstants.STATUS_APPROVED) {
    long articleId=counterLocalService.increment();
    article=articlePersistence.create(articleId);
    version=oldVersion + 1;
  }
 else {
    article=oldArticle;
    version=oldVersion;
  }
  if (oldStatus == WorkflowConstants.STATUS_PENDING) {
    status=WorkflowConstants.STATUS_PENDING;
  }
  article.setResourcePrimKey(oldResourcePrimKey);
  article.setGroupId(oldGroupId);
  article.setCompanyId(user.getCompanyId());
  article.setUserId(user.getUserId());
  article.setUserName(user.getFullName());
  article.setCreateDate(oldCreateDate);
  article.setModifiedDate(serviceContext.getModifiedDate(null));
  article.setRootResourcePrimKey(oldRootResourcePrimKey);
  article.setParentResourcePrimKey(oldParentResourcePrimKey);
  article.setVersion(version);
  article.setTitle(title);
  article.setContent(content);
  article.setDescription(description);
  article.setPriority(oldPriority);
  article.setLatest(ArticleConstants.LATEST_VERSION);
  article.setStatus(status);
  articlePersistence.update(article,false);
  if (oldStatus == WorkflowConstants.STATUS_APPROVED) {
    oldArticle.setLatest(ArticleConstants.LATEST_APPROVED);
    articlePersistence.update(oldArticle,false);
  }
  if ((serviceContext.getCommunityPermissions() != null) || (serviceContext.getGuestPermissions() != null)) {
    updateArticleResources(article,serviceContext.getCommunityPermissions(),serviceContext.getGuestPermissions());
  }
  updateAsset(userId,article,serviceContext.getAssetCategoryIds(),serviceContext.getAssetTagNames());
  updateAttachments(article,oldStatus,dirName);
  WorkflowHandlerRegistryUtil.startWorkflowInstance(user.getCompanyId(),article.getGroupId(),userId,Article.class.getName(),resourcePrimKey,article,serviceContext);
  return article;
}
