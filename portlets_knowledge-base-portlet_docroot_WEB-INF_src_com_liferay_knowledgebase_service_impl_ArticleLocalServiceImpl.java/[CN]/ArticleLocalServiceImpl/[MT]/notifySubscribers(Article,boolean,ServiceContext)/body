{
  if (Validator.isNull(serviceContext.getLayoutFullURL())) {
    return;
  }
  PortletPreferences preferences=ServiceContextUtil.getPortletPreferences(serviceContext);
  if (preferences == null) {
    long ownerId=article.getGroupId();
    int ownerType=PortletKeys.PREFS_OWNER_TYPE_GROUP;
    long plid=PortletKeys.PREFS_PLID_SHARED;
    String portletId=PortletKeys.KNOWLEDGE_BASE_ADMIN;
    String defaultPreferences=null;
    preferences=portletPreferencesLocalService.getPreferences(article.getCompanyId(),ownerId,ownerType,plid,portletId,defaultPreferences);
  }
  String emailArticleAddedEnabled=preferences.getValue("email-article-added-enabled",PortletProps.get("admin.email.article.added.enabled"));
  if (!update && !GetterUtil.getBoolean(emailArticleAddedEnabled)) {
    return;
  }
  String emailArticleUpdatedEnabled=preferences.getValue("email-article-updated-enabled",PortletProps.get("admin.email.article.updated.enabled"));
  if (update && !GetterUtil.getBoolean(emailArticleUpdatedEnabled)) {
    return;
  }
  Company company=companyPersistence.findByPrimaryKey(article.getCompanyId());
  Group group=groupPersistence.findByPrimaryKey(serviceContext.getScopeGroupId());
  User user=userPersistence.fetchByPrimaryKey(article.getUserId());
  String fullName=article.getUserName();
  String emailAddress=StringPool.BLANK;
  if (user != null) {
    fullName=user.getFullName();
    emailAddress=user.getEmailAddress();
  }
  String portletName=PortalUtil.getPortletTitle(PortletKeys.KNOWLEDGE_BASE_ADMIN,LocaleUtil.getDefault());
  String fromName=preferences.getValue("email-from-name",PortletProps.get("admin.email.from.name"));
  String fromAddress=preferences.getValue("email-from-address",PortletProps.get("admin.email.from.address"));
  fromName=StringUtil.replace(fromName,new String[]{"[$ARTICLE_USER_ADDRESS$]","[$ARTICLE_USER_NAME$]","[$COMPANY_ID$]","[$COMPANY_MX$]","[$COMPANY_NAME$]","[$COMMUNITY_NAME$]","[$PORTLET_NAME$]"},new String[]{emailAddress,fullName,String.valueOf(company.getCompanyId()),company.getMx(),company.getName(),group.getName(),portletName});
  fromAddress=StringUtil.replace(fromAddress,new String[]{"[$ARTICLE_USER_ADDRESS$]","[$ARTICLE_USER_NAME$]","[$COMPANY_ID$]","[$COMPANY_MX$]","[$COMPANY_NAME$]","[$COMMUNITY_NAME$]","[$PORTLET_NAME$]"},new String[]{emailAddress,fullName,String.valueOf(company.getCompanyId()),company.getMx(),company.getName(),group.getName(),portletName});
  String articleContent=StringUtil.replace(article.getContent(),new String[]{"href=\"/","src=\"/"},new String[]{"href=\"" + serviceContext.getPortalURL() + "/","src=\"" + serviceContext.getPortalURL() + "/"});
  String articleContentDiffs=StringPool.BLANK;
  String source=StringPool.BLANK;
  String target=article.getContent();
  if (article.getVersion() > ArticleConstants.DEFAULT_VERSION) {
    Article previousArticle=articlePersistence.findByR_V(article.getResourcePrimKey(),article.getVersion() - 1);
    source=previousArticle.getContent();
  }
  try {
    articleContentDiffs=DiffHtmlUtil.diff(new UnsyncStringReader(source),new UnsyncStringReader(target));
  }
 catch (  Exception e) {
    long resourcePrimKey=article.getResourcePrimKey();
    int version=article.getVersion();
    _log.error("Unable to process diff for {resourcePrimKey=" + resourcePrimKey + ", version="+ version+ "}");
  }
  articleContentDiffs=StringUtil.replace(articleContentDiffs,new String[]{"changeType=\"diff-added-image\"","changeType=\"diff-changed-image\"","changeType=\"diff-removed-image\"","class=\"diff-html-added\"","class=\"diff-html-changed\"","class=\"diff-html-removed\"","href=\"/","src=\"/"},new String[]{"style=\"border: 10px solid #CFC;\"","style=\"border: 10px solid #C6C6FD;\"","style=\"border: 10px solid #FDC6C6;\"","style=\"background-color: #CFC;\"","style=\"background-color: #C6C6FD\"","style=\"background-color: #FDC6C6; " + "text-decoration: line-through;\"","href=\"" + serviceContext.getPortalURL() + "/","src=\"" + serviceContext.getPortalURL() + "/"});
  int i=articleContentDiffs.indexOf("<img ");
  while (i != -1) {
    String oldImg=articleContentDiffs.substring(i,articleContentDiffs.indexOf("/>",i) + 2);
    int x=oldImg.indexOf("style=\"");
    int y=oldImg.indexOf("style=\"",x + 7);
    int z=oldImg.indexOf(StringPool.QUOTE,y + 7);
    if (y != -1) {
      String style=oldImg.substring(y,z + 1);
      String newImg=StringUtil.replace(oldImg,new String[]{style,"style=\""},new String[]{StringPool.BLANK,style.substring(0,style.length() - 1)});
      articleContentDiffs=StringUtil.replace(articleContentDiffs,oldImg,newImg);
    }
    i=articleContentDiffs.indexOf("<img ",i + 4);
  }
  String articleURL=null;
  Layout layout=layoutLocalService.getLayout(serviceContext.getPlid());
  LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
  if (layoutTypePortlet.hasDefaultScopePortletId(article.getGroupId(),PortletKeys.KNOWLEDGE_BASE_ADMIN)) {
    String namespace=PortalUtil.getPortletNamespace(PortletKeys.KNOWLEDGE_BASE_ADMIN);
    articleURL=HttpUtil.setParameter(serviceContext.getLayoutFullURL(),"p_p_id",PortletKeys.KNOWLEDGE_BASE_ADMIN);
    articleURL=HttpUtil.setParameter(articleURL,namespace + "jspPage","/admin/view_article.jsp");
    articleURL=HttpUtil.setParameter(articleURL,namespace + "resourcePrimKey",article.getResourcePrimKey());
  }
  if (articleURL == null) {
    articleURL=serviceContext.getLayoutFullURL();
  }
  String subject=null;
  String body=null;
  if (!update) {
    subject=preferences.getValue("email-article-added-subject",null);
    if (subject == null) {
      String name=PortletProps.get("admin.email.article.added.subject");
      try {
        subject=StringUtil.read(getClass().getClassLoader(),name);
      }
 catch (      IOException ioe) {
        _log.error(ioe,ioe);
      }
    }
    body=preferences.getValue("email-article-added-body",null);
    if (body == null) {
      String name=PortletProps.get("admin.email.article.added.body");
      try {
        body=StringUtil.read(getClass().getClassLoader(),name);
      }
 catch (      IOException ioe) {
        _log.error(ioe,ioe);
      }
    }
  }
 else {
    subject=preferences.getValue("email-article-updated-subject",null);
    if (subject == null) {
      String name=PortletProps.get("admin.email.article.updated.subject");
      try {
        subject=StringUtil.read(getClass().getClassLoader(),name);
      }
 catch (      IOException ioe) {
        _log.error(ioe,ioe);
      }
    }
    body=preferences.getValue("email-article-updated-body",null);
    if (body == null) {
      String name=PortletProps.get("admin.email.article.updated.body");
      try {
        body=StringUtil.read(getClass().getClassLoader(),name);
      }
 catch (      IOException ioe) {
        _log.error(ioe,ioe);
      }
    }
  }
  subject=StringUtil.replace(subject,new String[]{"[$ARTICLE_CONTENT$]","[$ARTICLE_CONTENT_DIFFS$]","[$ARTICLE_TITLE$]","[$ARTICLE_URL$]","[$ARTICLE_USER_ADDRESS$]","[$ARTICLE_USER_NAME$]","[$COMPANY_ID$]","[$COMPANY_MX$]","[$COMPANY_NAME$]","[$COMMUNITY_NAME$]","[$FROM_ADDRESS$]","[$FROM_NAME$]","[$PORTAL_URL$]","[$PORTLET_NAME$]"},new String[]{articleContent,articleContentDiffs,article.getTitle(),articleURL,emailAddress,fullName,String.valueOf(company.getCompanyId()),company.getMx(),company.getName(),group.getName(),fromAddress,fromName,serviceContext.getPortalURL(),portletName});
  body=StringUtil.replace(body,new String[]{"[$ARTICLE_CONTENT$]","[$ARTICLE_CONTENT_DIFFS$]","[$ARTICLE_TITLE$]","[$ARTICLE_URL$]","[$ARTICLE_USER_ADDRESS$]","[$ARTICLE_USER_NAME$]","[$COMPANY_ID$]","[$COMPANY_MX$]","[$COMPANY_NAME$]","[$COMMUNITY_NAME$]","[$FROM_ADDRESS$]","[$FROM_NAME$]","[$PORTAL_URL$]","[$PORTLET_NAME$]"},new String[]{articleContent,articleContentDiffs,article.getTitle(),articleURL,emailAddress,fullName,String.valueOf(company.getCompanyId()),company.getMx(),company.getName(),group.getName(),fromAddress,fromName,serviceContext.getPortalURL(),portletName});
  String mailId=StringPool.LESS_THAN + "knowledge_base.article." + article.getResourcePrimKey()+ StringPool.AT+ company.getMx()+ StringPool.GREATER_THAN;
  Message message=new Message();
  message.put("companyId",article.getCompanyId());
  message.put("groupId",article.getGroupId());
  message.put("userId",article.getUserId());
  message.put("resourcePrimKey",article.getResourcePrimKey());
  message.put("fromName",fromName);
  message.put("fromAddress",fromAddress);
  message.put("subject",subject);
  message.put("body",body);
  message.put("replyToAddress",fromAddress);
  message.put("mailId",mailId);
  message.put("htmlFormat",Boolean.TRUE);
  MessageBusUtil.sendMessage("liferay/knowledge_base_admin",message);
}
