{
  if (Validator.isNull(className) || !className.equals(MBMessage.class.getName())) {
    return s;
  }
  if (options == null) {
    return s;
  }
  Object emailPartToMBMessageBody=options.get("emailPartToMBMessageBody");
  if ((emailPartToMBMessageBody == null) || (emailPartToMBMessageBody != Boolean.TRUE)) {
    return s;
  }
  if (!contentType.startsWith(ContentTypes.TEXT_PLAIN)) {
    return s;
  }
  Matcher matcher=_pattern.matcher(s);
  if (!matcher.find()) {
    return s;
  }
  if (_log.isDebugEnabled()) {
    _log.debug("Sanitizing " + className + "#"+ classPK);
  }
  StringBuilder sb=new StringBuilder();
  sb.append(s.substring(0,matcher.start()));
  String quotedText=s.substring(matcher.end(),s.length());
  String[] lines=quotedText.split(StringPool.RETURN_NEW_LINE + StringPool.PIPE + StringPool.NEW_LINE+ StringPool.PIPE+ StringPool.RETURN);
  int lastLineNumOfText=0;
  int lastLineNumOfQuotedText=0;
  for (int i=0; i < lines.length; i++) {
    if (Validator.isNotNull(lines[i])) {
      if (lines[i].startsWith(StringPool.GREATER_THAN)) {
        lastLineNumOfQuotedText=i;
        if ((lastLineNumOfText > 0) && (lastLineNumOfText < lastLineNumOfQuotedText)) {
          return s;
        }
      }
 else {
        lastLineNumOfText=i;
        sb.append(lines[i]);
        sb.append(StringPool.RETURN_NEW_LINE);
      }
    }
  }
  return sb.toString();
}
