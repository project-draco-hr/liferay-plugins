{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  UploadPortletRequest uploadPortletRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  long accountId=ParamUtil.getLong(uploadPortletRequest,"accountId");
  long messageId=ParamUtil.getLong(uploadPortletRequest,"messageId");
  String to=ParamUtil.getString(uploadPortletRequest,"to");
  String cc=ParamUtil.getString(uploadPortletRequest,"cc");
  String bcc=ParamUtil.getString(uploadPortletRequest,"bcc");
  String subject=ParamUtil.getString(uploadPortletRequest,"subject");
  String body=ParamUtil.getString(uploadPortletRequest,"body");
  int attachmentCount=ParamUtil.getInteger(uploadPortletRequest,"attachmentCount");
  List<MailFile> mailFiles=new ArrayList<MailFile>();
  for (int i=1; i <= attachmentCount; i++) {
    File file=uploadPortletRequest.getFile("attachment" + i);
    String filename=uploadPortletRequest.getFileName("attachment" + i);
    if (FileUtil.getBytes(file) != null) {
      mailFiles.add(new MailFile(file,filename,file.length()));
    }
  }
  HttpServletRequest request=PortalUtil.getHttpServletRequest(actionRequest);
  MailManager mailManager=MailManager.getInstance(request);
  JSONObject responseData=mailManager.sendMessage(accountId,messageId,to,cc,bcc,subject,body,mailFiles);
  actionResponse.sendRedirect(PortalUtil.getLayoutURL(themeDisplay) + "/-/mail/send_message?responseData=" + responseData);
}
