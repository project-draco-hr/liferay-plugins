{
  String format=ParamUtil.getString(portletRequest,"format");
  if (format.equals("json")) {
    JSONObject jsonData=null;
    String controller=ParamUtil.getString(portletRequest,"controller");
    BaseAlloyControllerImpl baseAlloyController=_alloyControllers.get(controller);
    try {
      HttpServletRequest request=PortalUtil.getHttpServletRequest(portletRequest);
      baseAlloyController.setRequest(request);
      baseAlloyController.initPortletVariables();
      String action=ParamUtil.getString(portletRequest,"action");
      Method actionMethod=baseAlloyController.getMethod(action);
      actionMethod.invoke(baseAlloyController);
      jsonData=JSONFactoryUtil.createJSONObject(String.valueOf(request.getAttribute("jsonData")));
    }
 catch (    Exception e) {
      jsonData=JSONFactoryUtil.createJSONObject();
      String message="an-unexpected-system-error-occurred";
      Throwable rootCause=getRootCause(e);
      if (rootCause instanceof AlloyException) {
        message=rootCause.getMessage();
      }
      jsonData.put("error",message);
      HttpServletResponse response=PortalUtil.getHttpServletResponse(portletResponse);
      response.setStatus(HttpServletResponse.SC_BAD_REQUEST);
    }
    writeJSON(portletRequest,portletResponse,jsonData);
    return;
  }
  String path=getPath(portletRequest);
  include(path,portletRequest,portletResponse);
}
