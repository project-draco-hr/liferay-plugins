{
  UploadPortletRequest uploadRequest=PortalUtil.getUploadPortletRequest(actionRequest);
  String definitionName=ParamUtil.getString(uploadRequest,"definitionName");
  String format=ParamUtil.getString(uploadRequest,"format");
  String fileName=uploadRequest.getFileName("msgFile");
  File file=uploadRequest.getFile("msgFile");
  String description=ParamUtil.getString(uploadRequest,"description");
  String datasourceName=ParamUtil.getString(uploadRequest,"dataSourceName");
  String reportParameters=ParamUtil.getString(uploadRequest,"reportParameters");
  ThemeDisplay themeDisplay=(ThemeDisplay)uploadRequest.getAttribute(WebKeys.THEME_DISPLAY);
  ReportDefinition definition=null;
  try {
    definition=ReportDefinitionLocalServiceUtil.addReportDefinition(themeDisplay.getCompanyId(),themeDisplay.getScopeGroupId(),themeDisplay.getUserId(),definitionName,description,datasourceName,format,fileName,file,reportParameters);
    uploadRequest.setAttribute("fileName",fileName);
    SessionMessages.add(uploadRequest,"request_processed");
  }
 catch (  PortalException e) {
    definition=new ReportDefinitionImpl();
    definition.setNew(true);
    definition.setDefinitionName(definitionName);
    definition.setDescription(description);
    definition.setDataSourceName(datasourceName);
    definition.setReportFormat(format);
    definition.setReportParameters(reportParameters);
    SessionErrors.add(actionRequest,e.getClass().getName());
  }
catch (  SystemException e) {
    _log.error(e);
    throw new PortletException("Unable to create new definition ",e);
  }
  uploadRequest.setAttribute("definition",definition);
  actionResponse.setRenderParameter("jspPage",ParamUtil.getString(uploadRequest,"jspPage"));
  return false;
}
