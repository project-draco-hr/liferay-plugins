{
  String protocol=url.getProtocol();
  if ("reference".equals(protocol)) {
    String file=url.getFile();
    url=new URL(file);
    protocol=url.getProtocol();
  }
  if ("file".equals(protocol)) {
    return url.toURI();
  }
 else   if ("jar".equals(protocol)) {
    String file=url.getFile();
    return new URI(StringUtil.extractFirst(file,"!/"));
  }
  throw new URISyntaxException(url.toString(),"Unable to handle this URI");
}
