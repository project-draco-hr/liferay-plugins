{
  if (msg == null) {
    messageLabel.setVisible(false);
    headersAndAttachmentLayout.setVisible(false);
    return;
  }
 else {
    messageLabel.setVisible(true);
    headersAndAttachmentLayout.setVisible(true);
  }
  String text="";
  if (msg != null) {
    text=msg.getBody();
  }
  messageLabel.setValue(text);
  headersLayout=new FormLayout();
  headersLayout.setSpacing(false);
  headersLayout.setMargin(false);
  if (msg != null) {
    String to=msg.getTo();
    String cc=msg.getCc();
    Label subject=new Label(msg.getSubject());
    subject.setCaption(Lang.get("subject"));
    headersLayout.addComponent(subject);
    Label from=new Label(msg.getSender());
    from.setCaption(Lang.get("from"));
    headersLayout.addComponent(from);
    if (to != null && !to.equals("")) {
      Label toLabel=new Label(to);
      toLabel.setCaption(Lang.get("to"));
      headersLayout.addComponent(toLabel);
    }
    if (cc != null && !cc.equals("")) {
      Label ccLabel=new Label(cc);
      ccLabel.setCaption(Lang.get("cc"));
      headersLayout.addComponent(ccLabel);
    }
    Label date=new Label(formatDate(msg.getSentDate()));
    date.setCaption(Lang.get("date"));
    headersLayout.addComponent(date);
    if (MessageUtil.isImportant(msg)) {
      Label flag=new Label(Lang.get("important"));
      flag.setStyleName(MessageList.STYLE_IMPORTANT);
      flag.setCaption(Lang.get("flag"));
      headersLayout.addComponent(flag);
    }
  }
  try {
    headersAndAttachmentLayout.removeAllComponents();
    headersAndAttachmentLayout.addComponent(headersLayout);
    Controller controller=Controller.get();
    List<Attachment> attachments=AttachmentLocalServiceUtil.getAttachments(msg.getMessageId());
    if (attachments != null && !attachments.isEmpty()) {
      for (      Attachment attachment : attachments) {
        Button attachmentDownload=new Button();
        attachmentDownload.setStyleName(BaseTheme.BUTTON_LINK);
        attachmentDownload.setCaption(attachment.getFileName() + " " + MessageUtil.formatSize(attachment.getSize(),controller.getUserLocale()));
        attachmentDownload.setData(attachment);
        attachmentDownload.addListener(this);
        headersAndAttachmentLayout.addComponent(attachmentDownload);
      }
    }
  }
 catch (  SystemException e) {
    _log.debug(e);
  }
}
