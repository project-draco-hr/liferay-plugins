{
  User user=userPersistence.findByPrimaryKey(userId);
  int version=KBArticleConstants.DEFAULT_VERSION;
  int status=WorkflowConstants.STATUS_DRAFT;
  validate(title,content);
  KBArticle oldKBArticle=getLatestKBArticle(resourcePrimKey,WorkflowConstants.STATUS_ANY);
  long oldResourcePrimKey=oldKBArticle.getResourcePrimKey();
  long oldGroupId=oldKBArticle.getGroupId();
  Date oldCreateDate=oldKBArticle.getCreateDate();
  long oldRootResourcePrimKey=oldKBArticle.getRootResourcePrimKey();
  long oldParentResourcePrimKey=oldKBArticle.getParentResourcePrimKey();
  int oldVersion=oldKBArticle.getVersion();
  double oldPriority=oldKBArticle.getPriority();
  int oldViewCount=oldKBArticle.getViewCount();
  int oldStatus=oldKBArticle.getStatus();
  KBArticle kbArticle=null;
  if (oldStatus == WorkflowConstants.STATUS_APPROVED) {
    long kbArticleId=counterLocalService.increment();
    kbArticle=kbArticlePersistence.create(kbArticleId);
    version=oldVersion + 1;
  }
 else {
    kbArticle=oldKBArticle;
    version=oldVersion;
  }
  if (oldStatus == WorkflowConstants.STATUS_PENDING) {
    status=WorkflowConstants.STATUS_PENDING;
  }
  kbArticle.setResourcePrimKey(oldResourcePrimKey);
  kbArticle.setGroupId(oldGroupId);
  kbArticle.setCompanyId(user.getCompanyId());
  kbArticle.setUserId(user.getUserId());
  kbArticle.setUserName(user.getFullName());
  kbArticle.setCreateDate(oldCreateDate);
  kbArticle.setModifiedDate(serviceContext.getModifiedDate(null));
  kbArticle.setRootResourcePrimKey(oldRootResourcePrimKey);
  kbArticle.setParentResourcePrimKey(oldParentResourcePrimKey);
  kbArticle.setVersion(version);
  kbArticle.setTitle(title);
  kbArticle.setContent(content);
  kbArticle.setDescription(description);
  kbArticle.setKbTemplateId(kbTemplateId);
  kbArticle.setPriority(oldPriority);
  kbArticle.setViewCount(oldViewCount);
  kbArticle.setLatest(true);
  kbArticle.setMain(false);
  kbArticle.setStatus(status);
  kbArticlePersistence.update(kbArticle,false);
  if (oldVersion < version) {
    oldKBArticle.setLatest(false);
    kbArticlePersistence.update(oldKBArticle,false);
  }
  if ((serviceContext.getCommunityPermissions() != null) || (serviceContext.getGuestPermissions() != null)) {
    updateKBArticleResources(kbArticle,serviceContext.getCommunityPermissions(),serviceContext.getGuestPermissions());
  }
  updateKBArticleAsset(userId,kbArticle,serviceContext.getAssetCategoryIds(),serviceContext.getAssetTagNames());
  updateKBArticleAttachments(kbArticle,oldVersion,dirName,serviceContext);
  WorkflowHandlerRegistryUtil.startWorkflowInstance(user.getCompanyId(),kbArticle.getGroupId(),userId,KBArticle.class.getName(),resourcePrimKey,kbArticle,serviceContext);
  return kbArticle;
}
