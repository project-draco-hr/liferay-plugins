{
  if (isValidDirName(dirName)) {
    return dirName;
  }
  Ticket ticket=ticketLocalService.addTicket(serviceContext.getCompanyId(),User.class.getName(),serviceContext.getUserId(),0,null,getTicketExpirationDate(),serviceContext);
  StringBundler sb=new StringBundler(5);
  sb.append(_TEMP_DIR_NAME_PREFIX);
  sb.append(StringPool.SLASH);
  sb.append(counterLocalService.increment());
  sb.append(StringPool.SLASH);
  sb.append(ticket.getKey());
  dirName=sb.toString();
  ticket.setExtraInfo(dirName);
  ticketLocalService.updateTicket(ticket);
  DLStoreUtil.addDirectory(serviceContext.getCompanyId(),CompanyConstants.SYSTEM,dirName);
  if (resourcePrimKey <= 0) {
    return dirName;
  }
  KBArticle kbArticle=getLatestKBArticle(resourcePrimKey,WorkflowConstants.STATUS_ANY);
  for (  String fileName : kbArticle.getAttachmentsFileNames()) {
    String shortFileName=FileUtil.getShortFileName(fileName);
    InputStream inputStream=null;
    try {
      inputStream=DLStoreUtil.getFileAsStream(kbArticle.getCompanyId(),CompanyConstants.SYSTEM,fileName);
      addAttachment(dirName,shortFileName,inputStream,serviceContext);
    }
  finally {
      StreamUtil.cleanUp(inputStream);
    }
  }
  return dirName;
}
