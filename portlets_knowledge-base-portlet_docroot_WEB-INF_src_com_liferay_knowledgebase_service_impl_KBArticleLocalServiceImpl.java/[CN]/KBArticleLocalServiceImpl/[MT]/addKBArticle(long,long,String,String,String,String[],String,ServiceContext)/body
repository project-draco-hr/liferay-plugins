{
  User user=userPersistence.findByPrimaryKey(userId);
  long groupId=serviceContext.getScopeGroupId();
  double priority=getPriority(groupId,parentResourcePrimKey);
  Date now=new Date();
  validate(title,content);
  long kbArticleId=counterLocalService.increment();
  long resourcePrimKey=counterLocalService.increment();
  long rootResourcePrimKey=getRootResourcePrimKey(resourcePrimKey,parentResourcePrimKey);
  KBArticle kbArticle=kbArticlePersistence.create(kbArticleId);
  kbArticle.setUuid(serviceContext.getUuid());
  kbArticle.setResourcePrimKey(resourcePrimKey);
  kbArticle.setGroupId(groupId);
  kbArticle.setCompanyId(user.getCompanyId());
  kbArticle.setUserId(user.getUserId());
  kbArticle.setUserName(user.getFullName());
  kbArticle.setCreateDate(serviceContext.getCreateDate(now));
  kbArticle.setModifiedDate(serviceContext.getModifiedDate(now));
  kbArticle.setRootResourcePrimKey(rootResourcePrimKey);
  kbArticle.setParentResourcePrimKey(parentResourcePrimKey);
  kbArticle.setVersion(KBArticleConstants.DEFAULT_VERSION);
  kbArticle.setTitle(title);
  kbArticle.setContent(content);
  kbArticle.setDescription(description);
  kbArticle.setPriority(priority);
  kbArticle.setSections(StringUtil.merge(AdminUtil.escapeSections(sections)));
  kbArticle.setViewCount(0);
  kbArticle.setLatest(true);
  kbArticle.setMain(false);
  kbArticle.setStatus(WorkflowConstants.STATUS_DRAFT);
  kbArticlePersistence.update(kbArticle,false);
  if (serviceContext.isAddGroupPermissions() || serviceContext.isAddGuestPermissions()) {
    addKBArticleResources(kbArticle,serviceContext.isAddGroupPermissions(),serviceContext.isAddGuestPermissions());
  }
 else {
    addKBArticleResources(kbArticle,serviceContext.getGroupPermissions(),serviceContext.getGuestPermissions());
  }
  updateKBArticleAsset(userId,kbArticle,serviceContext.getAssetCategoryIds(),serviceContext.getAssetTagNames());
  addKBArticleAttachments(kbArticle,dirName,serviceContext);
  WorkflowHandlerRegistryUtil.startWorkflowInstance(user.getCompanyId(),groupId,userId,KBArticle.class.getName(),resourcePrimKey,kbArticle,serviceContext);
  return kbArticle;
}
