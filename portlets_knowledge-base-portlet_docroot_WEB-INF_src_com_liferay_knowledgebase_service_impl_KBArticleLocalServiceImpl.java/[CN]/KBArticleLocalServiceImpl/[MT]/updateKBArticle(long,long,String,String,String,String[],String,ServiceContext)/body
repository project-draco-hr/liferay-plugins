{
  User user=userPersistence.findByPrimaryKey(userId);
  int version=KBArticleConstants.DEFAULT_VERSION;
  int status=WorkflowConstants.STATUS_DRAFT;
  validate(title,content);
  KBArticle oldKBArticle=getLatestKBArticle(resourcePrimKey,WorkflowConstants.STATUS_ANY);
  int oldVersion=oldKBArticle.getVersion();
  int oldStatus=oldKBArticle.getStatus();
  KBArticle kbArticle=null;
  if (oldStatus == WorkflowConstants.STATUS_APPROVED) {
    long kbArticleId=counterLocalService.increment();
    kbArticle=kbArticlePersistence.create(kbArticleId);
    kbArticle.setResourcePrimKey(oldKBArticle.getResourcePrimKey());
    kbArticle.setGroupId(oldKBArticle.getGroupId());
    kbArticle.setCompanyId(user.getCompanyId());
    kbArticle.setUserId(user.getUserId());
    kbArticle.setUserName(user.getFullName());
    kbArticle.setCreateDate(oldKBArticle.getCreateDate());
    kbArticle.setRootResourcePrimKey(oldKBArticle.getRootResourcePrimKey());
    kbArticle.setParentResourcePrimKey(oldKBArticle.getParentResourcePrimKey());
    kbArticle.setVersion(oldVersion + 1);
    kbArticle.setPriority(oldKBArticle.getPriority());
    kbArticle.setViewCount(oldKBArticle.getViewCount());
    oldKBArticle.setLatest(false);
    kbArticlePersistence.update(oldKBArticle);
  }
 else {
    kbArticle=oldKBArticle;
  }
  if (oldStatus == WorkflowConstants.STATUS_PENDING) {
    status=WorkflowConstants.STATUS_PENDING;
  }
  kbArticle.setModifiedDate(serviceContext.getModifiedDate(null));
  kbArticle.setTitle(title);
  kbArticle.setContent(content);
  kbArticle.setDescription(description);
  kbArticle.setSections(StringUtil.merge(AdminUtil.escapeSections(sections)));
  kbArticle.setLatest(true);
  kbArticle.setMain(false);
  kbArticle.setStatus(status);
  kbArticlePersistence.update(kbArticle);
  if ((serviceContext.getGroupPermissions() != null) || (serviceContext.getGuestPermissions() != null)) {
    updateKBArticleResources(kbArticle,serviceContext.getGroupPermissions(),serviceContext.getGuestPermissions());
  }
  updateKBArticleAsset(userId,kbArticle,serviceContext.getAssetCategoryIds(),serviceContext.getAssetTagNames());
  updateKBArticleAttachments(userId,kbArticle,oldVersion,dirName,serviceContext);
  WorkflowHandlerRegistryUtil.startWorkflowInstance(user.getCompanyId(),kbArticle.getGroupId(),userId,KBArticle.class.getName(),resourcePrimKey,kbArticle,serviceContext);
  return kbArticle;
}
