{
  Layout selLayout=LayoutLocalServiceUtil.getLayout(selPlid);
  String selLayoutActualURL=PortalUtil.getLayoutActualURL(selLayout);
  String articleURL=themeDisplay.getPortalURL() + selLayoutActualURL;
  String namespace=PortalUtil.getPortletNamespace(selPortletId);
  articleURL=HttpUtil.setParameter(articleURL,"p_p_id",selPortletId);
  articleURL=HttpUtil.setParameter(articleURL,namespace + "resourcePrimKey",resourcePrimKey);
  PortletPreferences preferences=PortletPreferencesFactoryUtil.getPortletSetup(selLayout,selPortletId,StringPool.BLANK);
  Map<String,String> preferencesMap=KnowledgeBaseUtil.initPortletPreferencesMap(selPortletId,preferences);
  String p_p_state=null;
  String jspPage=null;
  String rootPortletId=PortletConstants.getRootPortletId(selPortletId);
  if (rootPortletId.equals(PortletKeys.KNOWLEDGE_BASE_AGGREGATOR)) {
    p_p_state=preferencesMap.get("articleWindowState");
    jspPage="/aggregator/view_article.jsp";
  }
 else   if (rootPortletId.equals(PortletKeys.KNOWLEDGE_BASE_DISPLAY)) {
    p_p_state=WindowState.NORMAL.toString();
    jspPage="/display/view_article.jsp";
  }
 else   if (rootPortletId.equals(PortletKeys.KNOWLEDGE_BASE_LIST)) {
    p_p_state=preferencesMap.get("articleWindowState");
    jspPage="/list/view_article.jsp";
  }
 else   if (rootPortletId.equals(PortletKeys.KNOWLEDGE_BASE_SEARCH)) {
    p_p_state=WindowState.MAXIMIZED.toString();
    jspPage="/search/view_article.jsp";
  }
  articleURL=HttpUtil.setParameter(articleURL,"p_p_state",p_p_state);
  articleURL=HttpUtil.setParameter(articleURL,namespace + "jspPage",jspPage);
  return articleURL;
}
