{
  User user=userPersistence.findByPrimaryKey(userId);
  Calendar calendar=calendarPersistence.findByPrimaryKey(calendarId);
  Date now=new Date();
  if (allDay) {
    startDateHour=0;
    startDateMinute=0;
    endDateHour=23;
    endDateMinute=59;
  }
  java.util.Calendar startDateJCalendar=getJCalendar(startDateMonth,startDateDay,startDateYear,startDateHour,startDateMinute);
  java.util.Calendar endDateJCalendar=getJCalendar(endDateMonth,endDateDay,endDateYear,endDateHour,endDateMinute);
  validate(titleMap,startDateMonth,startDateDay,startDateYear,startDateHour,startDateMinute,startDateJCalendar,endDateMonth,endDateDay,endDateYear,endDateHour,endDateMinute,endDateJCalendar,recurrence);
  if (firstReminder < secondReminder) {
    int originalSecondReminder=secondReminder;
    secondReminder=firstReminder;
    firstReminder=originalSecondReminder;
  }
  long calendarBookingId=counterLocalService.increment();
  CalendarBooking calendarBooking=calendarBookingPersistence.create(calendarBookingId);
  calendarBooking.setUuid(serviceContext.getUuid());
  calendarBooking.setGroupId(calendar.getGroupId());
  calendarBooking.setCompanyId(user.getCompanyId());
  calendarBooking.setUserId(user.getUserId());
  calendarBooking.setUserName(user.getFullName());
  calendarBooking.setCreateDate(serviceContext.getCreateDate(now));
  calendarBooking.setModifiedDate(serviceContext.getModifiedDate(now));
  calendarBooking.setCalendarId(calendarId);
  calendarBooking.setCalendarResourceId(calendar.getCalendarResourceId());
  calendarBooking.setParentCalendarBookingId(parentCalendarBookingId);
  calendarBooking.setTitleMap(titleMap);
  calendarBooking.setDescriptionMap(descriptionMap);
  calendarBooking.setLocationMap(locationMap);
  calendarBooking.setType(type);
  calendarBooking.setStartDate(startDateJCalendar.getTime());
  calendarBooking.setEndDate(endDateJCalendar.getTime());
  calendarBooking.setAllDay(allDay);
  calendarBooking.setRecurrence(recurrence);
  calendarBooking.setPriority(priority);
  calendarBooking.setOutOfOffice(outOfOffice);
  calendarBooking.setFirstReminder(firstReminder);
  calendarBooking.setSecondReminder(secondReminder);
  calendarBooking.setRequired(required);
  calendarBooking.setRequestMessage(requestMessage);
  calendarBooking.setResponseMessage(responseMessage);
  calendarBooking.setStatus(WorkflowConstants.STATUS_DRAFT);
  calendarBooking.setStatusDate(serviceContext.getModifiedDate(now));
  calendarBookingPersistence.update(calendarBooking,false);
  resourceLocalService.addModelResources(calendarBooking,serviceContext);
  calendarBookingApprovalWorkflow.startWorkflow(userId,calendarBookingId,serviceContext);
  return calendarBooking;
}
