{
  ThemeDisplay themeDisplay=(ThemeDisplay)renderRequest.getAttribute(WebKeys.THEME_DISPLAY);
  PortletDisplay portletDisplay=themeDisplay.getPortletDisplay();
  Portlet portlet=PortletLocalServiceUtil.getPortletById(themeDisplay.getCompanyId(),portletDisplay.getId());
  Gadget gadget=getGadget();
  GadgetSpec gadgetSpec=ShindigUtil.getGadgetSpec(gadget.getUrl());
  String urlConfiguration=portletDisplay.getURLConfiguration();
  if (hasUserPrefs(gadgetSpec)) {
    portlet.setConfigurationActionClass(ConfigurationActionImpl.class.getName());
    urlConfiguration=urlConfiguration.replaceAll("edit_permissions","edit_configuration");
  }
 else {
    portlet.setConfigurationActionClass(null);
    urlConfiguration=urlConfiguration.replaceAll("edit_configuration","edit_permissions");
  }
  portletDisplay.setURLConfiguration(urlConfiguration);
  renderRequest.setAttribute(WebKeys.GADGET,gadget);
  String view=getView(renderRequest,gadgetSpec);
  renderRequest.setAttribute(WebKeys.VIEW,view);
}
