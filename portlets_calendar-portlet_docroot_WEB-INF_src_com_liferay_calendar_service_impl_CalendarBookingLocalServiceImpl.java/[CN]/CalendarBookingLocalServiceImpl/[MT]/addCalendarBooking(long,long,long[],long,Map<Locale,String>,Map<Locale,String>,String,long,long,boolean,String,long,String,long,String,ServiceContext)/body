{
  User user=userPersistence.findByPrimaryKey(userId);
  Calendar calendar=calendarPersistence.findByPrimaryKey(calendarId);
  java.util.Calendar startTimeJCalendar=JCalendarUtil.getJCalendar(startTime);
  java.util.Calendar endTimeJCalendar=JCalendarUtil.getJCalendar(endTime);
  if (allDay) {
    startTimeJCalendar=JCalendarUtil.toMidnightJCalendar(startTimeJCalendar);
    endTimeJCalendar=JCalendarUtil.toLastHourJCalendar(endTimeJCalendar);
  }
  if (firstReminder < secondReminder) {
    long originalSecondReminder=secondReminder;
    secondReminder=firstReminder;
    firstReminder=originalSecondReminder;
  }
  Date now=new Date();
  validate(titleMap,startTimeJCalendar,endTimeJCalendar);
  long calendarBookingId=counterLocalService.increment();
  CalendarBooking calendarBooking=calendarBookingPersistence.create(calendarBookingId);
  calendarBooking.setUuid(serviceContext.getUuid());
  calendarBooking.setGroupId(calendar.getGroupId());
  calendarBooking.setCompanyId(user.getCompanyId());
  calendarBooking.setUserId(user.getUserId());
  calendarBooking.setUserName(user.getFullName());
  calendarBooking.setCreateDate(serviceContext.getCreateDate(now));
  calendarBooking.setModifiedDate(serviceContext.getModifiedDate(now));
  calendarBooking.setCalendarId(calendarId);
  calendarBooking.setCalendarResourceId(calendar.getCalendarResourceId());
  if (parentCalendarBookingId > 0) {
    calendarBooking.setParentCalendarBookingId(parentCalendarBookingId);
  }
 else {
    calendarBooking.setParentCalendarBookingId(calendarBookingId);
  }
  calendarBooking.setTitleMap(titleMap);
  calendarBooking.setDescriptionMap(descriptionMap);
  calendarBooking.setLocation(location);
  calendarBooking.setStartTime(startTimeJCalendar.getTimeInMillis());
  calendarBooking.setEndTime(endTimeJCalendar.getTimeInMillis());
  calendarBooking.setAllDay(allDay);
  calendarBooking.setRecurrence(recurrence);
  calendarBooking.setFirstReminder(firstReminder);
  calendarBooking.setFirstReminderType(firstReminderType);
  calendarBooking.setSecondReminder(secondReminder);
  calendarBooking.setSecondReminderType(secondReminderType);
  calendarBooking.setExpandoBridgeAttributes(serviceContext);
  int status=CalendarBookingWorkflowConstants.STATUS_PENDING;
  if (parentCalendarBookingId == 0) {
    status=CalendarBookingWorkflowConstants.STATUS_APPROVED;
  }
  calendarBooking.setStatus(status);
  calendarBooking.setStatusDate(serviceContext.getModifiedDate(now));
  calendarBookingPersistence.update(calendarBooking);
  addChildCalendarBookings(calendarBooking,childCalendarIds,serviceContext);
  resourceLocalService.addModelResources(calendarBooking,serviceContext);
  updateAsset(userId,calendarBooking,serviceContext.getAssetCategoryIds(),serviceContext.getAssetTagNames(),serviceContext.getAssetLinkEntryIds());
  socialActivityLocalService.addActivity(userId,calendar.getResourceGroupId(),CalendarBooking.class.getName(),calendarBookingId,CalendarActivityKeys.ADD_CALENDAR_BOOKING,getExtraDataJSON(calendarBooking,serviceContext),0);
  calendarBookingApprovalWorkflow.startWorkflow(userId,calendarBookingId,serviceContext);
  return calendarBooking;
}
