{
  Calendar calendar=calendarPersistence.findByPrimaryKey(calendarId);
  CalendarResource calendarResource=calendarResourcePersistence.findByPrimaryKey(calendar.getCalendarResourceId());
  if (calendarResource.getClassNameId() != PortalUtil.getClassNameId(User.class)) {
    return;
  }
  User user=userPersistence.findByPrimaryKey(calendarResource.getClassPK());
  java.util.Calendar startDate=JCalendarUtil.getJCalendar(calendarBooking.getStartDate(),user.getTimeZone());
  long ownerId=calendarBooking.getGroupId();
  int ownerType=PortletKeys.PREFS_OWNER_TYPE_GROUP;
  long plid=PortletKeys.PREFS_PLID_SHARED;
  String portletId=PortletKeys.CALENDAR;
  PortletPreferences preferences=PortletPreferencesLocalServiceUtil.getPreferences(calendarBooking.getCompanyId(),ownerId,ownerType,plid,portletId);
  Company company=CompanyLocalServiceUtil.getCompany(user.getCompanyId());
  String portletName=LanguageUtil.get(user.getLocale(),PortalUtil.getPortletTitle(PortletKeys.CALENDAR,user));
  String fromName=CalendarUtil.getEmailFromName(preferences,calendarBooking.getCompanyId());
  String fromAddress=CalendarUtil.getEmailFromAddress(preferences,calendarBooking.getCompanyId());
  String toName=user.getFullName();
  String toAddress=user.getEmailAddress();
  String subject=CalendarUtil.getEmailBookingReminderSubject(preferences);
  String body=CalendarUtil.getEmailBookingReminderBody(preferences);
  Format dateFormatDateTime=FastDateFormatFactoryUtil.getDateTime(user.getLocale(),user.getTimeZone());
  SubscriptionSender subscriptionSender=new SubscriptionSender();
  subscriptionSender.setBody(body);
  subscriptionSender.setCompanyId(calendarBooking.getCompanyId());
  subscriptionSender.setContextAttributes("[$BOOKING_LOCATION$]",calendarBooking.getLocation(),"[$BOOKING_START_DATE$]",dateFormatDateTime.format(startDate.getTime()),"[$BOOKING_TITLE$]",calendarBooking.getTitle(user.getLocale()),"[$FROM_ADDRESS$]",fromAddress,"[$FROM_NAME$]",fromName,"[$PORTAL_URL$]",company.getPortalURL(calendarBooking.getGroupId()),"[$PORTLET_NAME$]",portletName,"[$TO_ADDRESS$]",toAddress,"[$TO_NAME$]",toName);
  subscriptionSender.setFrom(fromAddress,fromName);
  subscriptionSender.setHtmlFormat(true);
  subscriptionSender.setMailId("calendar_booking",calendarBooking.getCalendarBookingId());
  subscriptionSender.setPortletId(PortletKeys.CALENDAR);
  subscriptionSender.setScopeGroupId(calendarBooking.getGroupId());
  subscriptionSender.setServiceContext(serviceContext);
  subscriptionSender.setSubject(subject);
  subscriptionSender.setUserId(user.getUserId());
  subscriptionSender.addRuntimeSubscribers(toAddress,toName);
  subscriptionSender.flushNotificationsAsync();
}
