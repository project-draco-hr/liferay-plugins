{
  String messageBody=null;
  long userId=0;
  JSONObject jsonObject=JSONFactoryUtil.createJSONObject(userNotificationEvent.getPayload());
  long classPK=jsonObject.getLong("classPK");
  MBMessage mbMessage=MBMessageLocalServiceUtil.fetchMBMessage(classPK);
  if (mbMessage == null) {
    messageBody=jsonObject.getString("body");
    if (Validator.isNull(messageBody)) {
      UserNotificationEventLocalServiceUtil.deleteUserNotificationEvent(userNotificationEvent.getUserNotificationEventId());
      return null;
    }
    userId=jsonObject.getLong("userId");
  }
 else {
    UserThread userThread=UserThreadLocalServiceUtil.fetchUserThread(serviceContext.getUserId(),mbMessage.getThreadId());
    if ((userThread == null) || userThread.isDeleted()) {
      UserNotificationEventLocalServiceUtil.deleteUserNotificationEvent(userNotificationEvent.getUserNotificationEventId());
      return null;
    }
    messageBody=mbMessage.getBody();
    userId=mbMessage.getUserId();
  }
  String body=getNotificationTemplate();
  String title=serviceContext.translate("x-sent-you-a-message",HtmlUtil.escape(PortalUtil.getUserName(userId,StringPool.BLANK)));
  body=StringUtil.replace(body,new String[]{"[$BODY$]","[$TITLE$]"},new String[]{HtmlUtil.escape(StringUtil.shorten(messageBody,50)),title});
  return body;
}
