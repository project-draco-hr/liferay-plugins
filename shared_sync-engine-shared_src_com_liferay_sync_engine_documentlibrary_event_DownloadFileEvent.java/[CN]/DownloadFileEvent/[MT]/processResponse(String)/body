{
  OutputStream outputStream=null;
  try {
    SyncFile syncFile=(SyncFile)getParameterValue("syncFile");
    Path filePath=Paths.get(syncFile.getFilePathName());
    if ((Boolean)getParameterValue("patch")) {
      InputStream inputStream=new ByteArrayInputStream(response.getBytes());
      IODeltaUtil.patch(filePath,inputStream);
    }
 else {
      outputStream=Files.newOutputStream(filePath);
      outputStream.write(response.getBytes());
    }
    syncFile.setFileKey(FileUtil.getFileKey(filePath));
    syncFile.setState(SyncFile.STATE_SYNCED);
    syncFile.setUiEvent(SyncFile.UI_EVENT_DOWNLOADED);
    SyncFileService.update(syncFile);
  }
  finally {
    StreamUtil.cleanUp(outputStream);
  }
}
