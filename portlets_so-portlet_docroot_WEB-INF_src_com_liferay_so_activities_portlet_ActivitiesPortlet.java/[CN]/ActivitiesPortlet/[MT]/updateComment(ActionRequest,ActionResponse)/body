{
  ThemeDisplay themeDisplay=(ThemeDisplay)actionRequest.getAttribute(WebKeys.THEME_DISPLAY);
  String cmd=ParamUtil.getString(actionRequest,Constants.CMD);
  String className=ParamUtil.getString(actionRequest,"className");
  long classPK=ParamUtil.getLong(actionRequest,"classPK");
  long mbMessageId=ParamUtil.getLong(actionRequest,"mbMessageId");
  long mbThreadId=ParamUtil.getLong(actionRequest,"mbThreadId");
  long parentMBMessageId=ParamUtil.getLong(actionRequest,"parentMBMessageId");
  String body=ParamUtil.getString(actionRequest,"body");
  JSONObject jsonObject=JSONFactoryUtil.createJSONObject();
  try {
    MBMessage mbMessage=null;
    long groupId=themeDisplay.getScopeGroupId();
    ServiceContext serviceContext=ServiceContextFactory.getInstance(MBMessage.class.getName(),actionRequest);
    if (cmd.equals(Constants.DELETE)) {
      MBMessageServiceUtil.deleteDiscussionMessage(groupId,className,classPK,className,classPK,themeDisplay.getUserId(),mbMessageId);
    }
 else     if (cmd.equals(Constants.EDIT) && (mbMessageId > 0)) {
      mbMessage=MBMessageServiceUtil.updateDiscussionMessage(className,classPK,className,classPK,themeDisplay.getUserId(),mbMessageId,StringPool.BLANK,body,serviceContext);
    }
 else {
      mbMessage=MBMessageServiceUtil.addDiscussionMessage(groupId,className,classPK,className,classPK,themeDisplay.getUserId(),mbThreadId,parentMBMessageId,StringPool.BLANK,body,serviceContext);
    }
    if (mbMessage != null) {
      jsonObject.put("body",HtmlUtil.escape(mbMessage.getBody()));
      jsonObject.put("mbMessageId",mbMessage.getMessageId());
      jsonObject.put("modifiedDate",Time.getRelativeTimeDescription(mbMessage.getModifiedDate(),themeDisplay.getLocale(),themeDisplay.getTimeZone()));
      User user=UserLocalServiceUtil.fetchUser(mbMessage.getUserId());
      if (user != null) {
        jsonObject.put("userDisplayURL",user.getDisplayURL(themeDisplay));
        jsonObject.put("userPortraitURL",HtmlUtil.escape(user.getPortraitURL(themeDisplay)));
      }
      jsonObject.put("userName",HtmlUtil.escape(mbMessage.getUserName()));
    }
    jsonObject.put("success",Boolean.TRUE);
  }
 catch (  Exception e) {
    jsonObject.put("success",Boolean.FALSE);
  }
  writeJSON(actionRequest,actionResponse,jsonObject);
}
