{
  long userIdLong=GetterUtil.getLong(userId.getUserId(securityToken));
  User user=UserLocalServiceUtil.getUserById(userIdLong);
  Group group=user.getGroup();
  long groupIdLong=group.getGroupId();
  Http.Options options=new Http.Options();
  options.setLocation(mediaItem.getUrl());
  byte[] byteArray=HttpUtil.URLtoByteArray(options);
  String fileName=getFileName(mediaItem,options);
  ServiceContext serviceContext=new ServiceContext();
  serviceContext.setAddCommunityPermissions(true);
  serviceContext.setAddGuestPermissions(true);
  serviceContext.setScopeGroupId(groupIdLong);
  Map<String,Serializable> expandoBridgeAttributes=new LinkedHashMap<String,Serializable>();
  SerializerUtil.copyProperties(mediaItem,expandoBridgeAttributes,_MEDIA_ITEM_FIELDS);
  serviceContext.setExpandoBridgeAttributes(expandoBridgeAttributes);
  ExpandoBridge expandoBridge=ExpandoBridgeFactoryUtil.getExpandoBridge(user.getCompanyId(),DLFileEntry.class.getName());
  addAttributes(mediaItem,expandoBridge);
  if (mediaItemId == null) {
    long albumIdLong=GetterUtil.getLong(albumId);
    DLAppServiceUtil.addFileEntry(groupIdLong,albumIdLong,fileName,mediaItem.getDescription(),StringPool.BLANK,byteArray,serviceContext);
  }
 else {
    long mediaItemIdLong=GetterUtil.getLong(mediaItemId);
    FileEntry fileEntry=DLAppLocalServiceUtil.getFileEntry(mediaItemIdLong);
    serviceContext.setCreateDate(fileEntry.getCreateDate());
    serviceContext.setModifiedDate(fileEntry.getModifiedDate());
    DLAppServiceUtil.updateFileEntry(fileEntry.getFileEntryId(),fileName,mediaItem.getTitle(),mediaItem.getDescription(),StringPool.BLANK,false,byteArray,serviceContext);
  }
}
