{
  long albumIdLong=GetterUtil.getLong(albumId);
  long userIdLong=GetterUtil.getLong(userId.getUserId(securityToken));
  User owner=UserLocalServiceUtil.getUserById(userIdLong);
  long groupIdLong=owner.getGroup().getGroupId();
  String fileName;
  Http.Options options=new Http.Options();
  options.setLocation(mediaItem.getUrl());
  byte[] byteArray=HttpUtil.URLtoByteArray(options);
  String contentDisposition=options.getResponse().getHeader("Content-Disposition");
  if (contentDisposition != null) {
    Matcher filenameMatcher=_filenamePattern.matcher(contentDisposition);
    if (filenameMatcher.find()) {
      fileName=filenameMatcher.group(1);
    }
 else {
      fileName=mediaItem.getTitle();
    }
  }
 else {
    fileName=FileUtil.getShortFileName(mediaItem.getUrl());
  }
  JSONObject extraDataJSON=JSONFactoryUtil.createJSONObject();
  extraDataJSON.put("DURATION",mediaItem.getDuration());
  extraDataJSON.put("fileSize",mediaItem.getFileSize());
  extraDataJSON.put("language",mediaItem.getLanguage());
  extraDataJSON.put("location",getLocation(mediaItem.getLocation()));
  extraDataJSON.put("numCommments",mediaItem.getNumComments());
  extraDataJSON.put("numVotes",mediaItem.getNumVotes());
  extraDataJSON.put("rating",mediaItem.getRating());
  extraDataJSON.put("startTime",mediaItem.getStartTime());
  extraDataJSON.put("taggedPeople",mediaItem.getTaggedPeople());
  extraDataJSON.put("tags",mediaItem.getTags());
  extraDataJSON.put("thumbnailUrl",mediaItem.getThumbnailUrl());
  if (mediaItemId == null) {
    ServiceContext serviceContext=new ServiceContext();
    serviceContext.setAddCommunityPermissions(true);
    serviceContext.setAddGuestPermissions(true);
    serviceContext.setScopeGroupId(groupIdLong);
    DLAppLocalServiceUtil.addFileEntry(userIdLong,groupIdLong,albumIdLong,fileName,mediaItem.getDescription(),StringPool.BLANK,extraDataJSON.toString(),byteArray,serviceContext);
  }
 else {
    long mediaItemIdLong=GetterUtil.getLong(mediaItemId);
    DLFileEntry dlFileEntry=DLAppLocalServiceUtil.getFileEntry(mediaItemIdLong);
    ServiceContext serviceContext=new ServiceContext();
    serviceContext.setAddCommunityPermissions(true);
    serviceContext.setAddGuestPermissions(true);
    serviceContext.setCreateDate(dlFileEntry.getCreateDate());
    serviceContext.setModifiedDate(dlFileEntry.getModifiedDate());
    serviceContext.setScopeGroupId(groupIdLong);
    DLAppLocalServiceUtil.updateFileEntry(userIdLong,dlFileEntry.getFileEntryId(),fileName,mediaItem.getTitle(),mediaItem.getDescription(),"",false,extraDataJSON.toString(),byteArray,serviceContext);
  }
}
