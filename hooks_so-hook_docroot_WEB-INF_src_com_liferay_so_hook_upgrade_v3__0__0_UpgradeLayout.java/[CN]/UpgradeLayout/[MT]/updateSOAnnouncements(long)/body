{
  ActionableDynamicQuery actionableDynamicQuery=new LayoutActionableDynamicQuery(){
    @Override protected void performAction(    Object object) throws PortalException, SystemException {
      Layout layout=(Layout)object;
      if (!SocialOfficeServiceUtil.isSocialOfficeGroup(layout.getGroupId())) {
        return;
      }
      Group group=GroupLocalServiceUtil.fetchGroup(layout.getGroupId());
      if (layout.isPublicLayout() && group.isUser()) {
        return;
      }
      LayoutTypePortlet layoutTypePortlet=(LayoutTypePortlet)layout.getLayoutType();
      if (layoutTypePortlet.hasPortletId(PortletKeys.SO_ANNOUNCEMENTS)) {
        return;
      }
      UnicodeProperties typeSettingsProperties=layout.getTypeSettingsProperties();
      if (layoutTypePortlet.hasPortletId(PortletKeys.ANNOUNCEMENTS)) {
        LayoutTemplate layoutTemplate=layoutTypePortlet.getLayoutTemplate();
        for (        String columnName : layoutTemplate.getColumns()) {
          String columnValue=typeSettingsProperties.getProperty(columnName);
          columnValue=StringUtil.replace(columnValue,PortletKeys.ANNOUNCEMENTS,PortletKeys.SO_ANNOUNCEMENTS);
          typeSettingsProperties.setProperty(columnName,columnValue);
        }
        layout.setTypeSettingsProperties(typeSettingsProperties);
      }
 else {
        if (layout.getPriority() != 0) {
          return;
        }
        if (layout.getGroupId() == _userPublicLayoutSetPrototypeGroupId) {
          return;
        }
        String columnValue=typeSettingsProperties.getProperty("column-1");
        if (Validator.isNull(columnValue)) {
          return;
        }
        int columnPos=0;
        if (StringUtil.contains(columnValue,PortletKeys.MICROBLOGS_STATUS_UPDATE)) {
          columnPos=1;
        }
        layoutTypePortlet.addPortletId(0,PortletKeys.SO_ANNOUNCEMENTS,"column-1",columnPos,false);
        layout=layoutTypePortlet.getLayout();
      }
      LayoutLocalServiceUtil.updateLayout(layout);
    }
    protected long getLayoutSetPrototypeGroupId(    long companyId,    String layoutSetPrototypeKey) throws Exception {
      LayoutSetPrototype layoutSetPrototype=LayoutSetPrototypeUtil.fetchLayoutSetPrototype(companyId,layoutSetPrototypeKey);
      if (layoutSetPrototype != null) {
        return layoutSetPrototype.getGroupId();
      }
      return 0;
    }
    private long _userPublicLayoutSetPrototypeGroupId=getLayoutSetPrototypeGroupId(companyId,SocialOfficeConstants.LAYOUT_SET_PROTOTYPE_KEY_USER_PUBLIC);
  }
;
  actionableDynamicQuery.setCompanyId(companyId);
  actionableDynamicQuery.performActions();
}
