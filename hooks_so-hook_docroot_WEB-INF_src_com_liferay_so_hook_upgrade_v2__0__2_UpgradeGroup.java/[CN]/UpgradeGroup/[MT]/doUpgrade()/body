{
  List<Group> groups=GroupLocalServiceUtil.getGroups(QueryUtil.ALL_POS,QueryUtil.ALL_POS);
  for (  Group group : groups) {
    if (!group.isRegularSite() || group.isGuest()) {
      continue;
    }
    boolean privateLayout=group.hasPrivateLayouts();
    LayoutSet layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(group.getGroupId(),privateLayout);
    String themeId=layoutSet.getThemeId();
    if (!themeId.equals("so_WAR_sotheme")) {
      continue;
    }
    Layout oldHomeLayout=LayoutLocalServiceUtil.fetchFirstLayout(group.getGroupId(),privateLayout,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
    Map<String,PortletPreferences> oldPortletsPrefs=_getPrefsOfAllPortlets(oldHomeLayout);
    LayoutLocalServiceUtil.deleteLayouts(group.getGroupId(),privateLayout,new ServiceContext());
    LayoutSetPrototypeUtil.updateLayoutSetPrototype(group,privateLayout,SocialOfficeConstants.LAYOUT_SET_PROTOTYPE_KEY_SITE);
    layoutSet=LayoutSetLocalServiceUtil.getLayoutSet(group.getGroupId(),privateLayout);
    PortalClassInvoker.invoke(true,_mergeLayoutSetProtypeLayoutsMethodKey,group,layoutSet);
    Layout newHomeLayout=LayoutLocalServiceUtil.fetchFirstLayout(group.getGroupId(),privateLayout,LayoutConstants.DEFAULT_PARENT_LAYOUT_ID);
    if (oldPortletsPrefs.containsKey(_OLD_WELCOME_PORTLET_ID)) {
      _copyPortletSetup(newHomeLayout,_NEW_WELCOME_PORTLET_ID,oldPortletsPrefs.get(_OLD_WELCOME_PORTLET_ID),new String[]{"message"});
    }
    SocialOfficeUtil.enableSocialOffice(group);
  }
}
