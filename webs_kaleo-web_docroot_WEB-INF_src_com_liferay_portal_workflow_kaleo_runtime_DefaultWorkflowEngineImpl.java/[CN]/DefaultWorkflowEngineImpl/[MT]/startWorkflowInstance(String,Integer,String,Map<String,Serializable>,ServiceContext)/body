{
  try {
    KaleoDefinition kaleoDefinition=kaleoDefinitionLocalService.getKaleoDefinition(workflowDefinitionName,workflowDefinitionVersion,serviceContext);
    if (!kaleoDefinition.isActive()) {
      throw new WorkflowException("Inactive workflow definition with name " + workflowDefinitionName + " and version "+ workflowDefinitionVersion);
    }
    long scopeGroupId=serviceContext.getScopeGroupId();
    if (scopeGroupId != WorkflowConstants.DEFAULT_GROUP_ID) {
      Group group=GroupLocalServiceUtil.getGroup(scopeGroupId);
      if (group.isLayout()) {
        group=GroupLocalServiceUtil.getGroup(group.getParentGroupId());
        serviceContext.setScopeGroupId(group.getGroupId());
      }
    }
    KaleoInstance kaleoInstance=kaleoInstanceLocalService.addKaleoInstance(kaleoDefinition.getKaleoDefinitionId(),kaleoDefinition.getName(),kaleoDefinition.getVersion(),workflowContext,serviceContext);
    KaleoInstanceToken rootKaleoInstanceToken=kaleoInstance.getRootKaleoInstanceToken(workflowContext,serviceContext);
    KaleoNode kaleoStartNode=kaleoDefinition.getKaleoStartNode();
    rootKaleoInstanceToken.setCurrentKaleoNode(kaleoStartNode);
    kaleoLogLocalService.addWorkflowInstanceStartKaleoLog(rootKaleoInstanceToken,serviceContext);
    return new WorkflowInstanceAdapter(kaleoInstance,rootKaleoInstanceToken,workflowContext);
  }
 catch (  Exception e) {
    throw new WorkflowException(e);
  }
}
