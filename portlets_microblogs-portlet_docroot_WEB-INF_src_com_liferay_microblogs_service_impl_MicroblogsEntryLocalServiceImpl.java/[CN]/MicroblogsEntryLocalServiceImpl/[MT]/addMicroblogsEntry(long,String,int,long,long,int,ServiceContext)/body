{
  User user=userPersistence.findByPrimaryKey(userId);
  if (receiverUserId == 0) {
    receiverUserId=userId;
  }
  Date now=new Date();
  validate(type,receiverMicroblogsEntryId);
  long microblogsEntryId=counterLocalService.increment();
  if (receiverMicroblogsEntryId == 0) {
    receiverMicroblogsEntryId=microblogsEntryId;
  }
  MicroblogsEntry microblogsEntry=microblogsEntryPersistence.create(microblogsEntryId);
  microblogsEntry.setCompanyId(user.getCompanyId());
  microblogsEntry.setUserId(user.getUserId());
  microblogsEntry.setUserName(user.getFullName());
  microblogsEntry.setCreateDate(now);
  microblogsEntry.setModifiedDate(now);
  microblogsEntry.setContent(content);
  microblogsEntry.setType(type);
  microblogsEntry.setReceiverUserId(receiverUserId);
  microblogsEntry.setReceiverMicroblogsEntryId(receiverMicroblogsEntryId);
  microblogsEntry.setSocialRelationType(socialRelationType);
  microblogsEntryPersistence.update(microblogsEntry);
  resourceLocalService.addModelResources(microblogsEntry,serviceContext);
  updateAsset(microblogsEntry,serviceContext.getAssetCategoryIds(),serviceContext.getAssetTagNames());
  int activityKey=MicroblogsActivityKeys.ADD_ENTRY;
  if (type == MicroblogsEntryConstants.TYPE_REPLY) {
    activityKey=MicroblogsActivityKeys.REPLY_ENTRY;
  }
 else   if (type == MicroblogsEntryConstants.TYPE_REPOST) {
    activityKey=MicroblogsActivityKeys.REPOST_ENTRY;
  }
  JSONObject extraDataJSONObject=JSONFactoryUtil.createJSONObject();
  extraDataJSONObject.put("content",microblogsEntry.getContent());
  extraDataJSONObject.put("receiverMicroblogsEntryId",receiverMicroblogsEntryId);
  SocialActivityLocalServiceUtil.addActivity(userId,0,MicroblogsEntry.class.getName(),microblogsEntryId,activityKey,extraDataJSONObject.toString(),receiverUserId);
  subscribeUsers(microblogsEntry,serviceContext);
  if (type == MicroblogsEntryConstants.TYPE_REPLY) {
    sendNotificationEvent(microblogsEntry,serviceContext);
  }
  return microblogsEntry;
}
