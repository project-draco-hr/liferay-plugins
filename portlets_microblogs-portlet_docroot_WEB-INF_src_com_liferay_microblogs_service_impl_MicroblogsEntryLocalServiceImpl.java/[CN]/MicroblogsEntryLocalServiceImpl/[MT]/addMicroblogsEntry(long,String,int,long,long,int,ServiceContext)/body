{
  User user=userPersistence.findByPrimaryKey(userId);
  if (receiverUserId == 0) {
    receiverUserId=userId;
  }
  Date now=new Date();
  long microblogsEntryId=counterLocalService.increment();
  MicroblogsEntry microblogsEntry=microblogsEntryPersistence.create(microblogsEntryId);
  microblogsEntry.setCompanyId(user.getCompanyId());
  microblogsEntry.setUserId(user.getUserId());
  microblogsEntry.setUserName(user.getFullName());
  microblogsEntry.setCreateDate(now);
  microblogsEntry.setModifiedDate(now);
  microblogsEntry.setContent(content);
  microblogsEntry.setType(type);
  microblogsEntry.setReceiverUserId(receiverUserId);
  microblogsEntry.setReceiverMicroblogsEntryId(receiverMicroblogsEntryId);
  microblogsEntry.setSocialRelationType(socialRelationType);
  microblogsEntryPersistence.update(microblogsEntry,false);
  addMicroblogsEntryResources(microblogsEntry);
  AssetEntryLocalServiceUtil.updateEntry(userId,0,MicroblogsEntry.class.getName(),microblogsEntryId,serviceContext.getAssetCategoryIds(),serviceContext.getAssetTagNames());
  int actitivtyKey=MicroblogsActivityKeys.ADD_ENTRY;
  if (type == MicroblogsEntryConstants.TYPE_REPLY) {
    actitivtyKey=MicroblogsActivityKeys.REPLY_ENTRY;
  }
 else   if (type == MicroblogsEntryConstants.TYPE_REPOST) {
    actitivtyKey=MicroblogsActivityKeys.REPOST_ENTRY;
  }
  SocialActivityLocalServiceUtil.addActivity(userId,0,MicroblogsEntry.class.getName(),microblogsEntryId,actitivtyKey,StringPool.BLANK,receiverUserId);
  return microblogsEntry;
}
