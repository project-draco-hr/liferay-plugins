{
  KaleoDefinition kaleoDefinition=null;
  try {
    kaleoDefinition=KaleoDefinitionLocalServiceUtil.incrementKaleoDefinition(definition.getName(),serviceContext);
  }
 catch (  NoSuchDefinitionException nsde) {
    kaleoDefinition=KaleoDefinitionLocalServiceUtil.addKaleoDefinition(definition.getName(),definition.getDescription(),definition.getVersion(),serviceContext);
  }
  long kaleoDefinitionId=kaleoDefinition.getKaleoDefinitionId();
  Collection<Node> nodes=definition.getNodes();
  Map<String,KaleoNode> kaleoNodesMap=new HashMap<String,KaleoNode>();
  for (  Node node : nodes) {
    KaleoNode kaleoNode=KaleoNodeLocalServiceUtil.addKaleoNode(kaleoDefinitionId,node,serviceContext);
    kaleoNodesMap.put(node.getName(),kaleoNode);
    NodeType nodeType=node.getNodeType();
    if (nodeType.equals(NodeType.TASK)) {
      Task task=(Task)node;
      KaleoTaskLocalServiceUtil.addKaleoTask(kaleoDefinitionId,kaleoNode.getKaleoNodeId(),task,serviceContext);
    }
  }
  for (  Node node : nodes) {
    Collection<Transition> transitions=node.getTransitionsEntries();
    KaleoNode kaleoNode=kaleoNodesMap.get(node.getName());
    for (    Transition transition : transitions) {
      KaleoNode sourceKaleoNode=kaleoNodesMap.get(transition.getSourceNode().getName());
      if (sourceKaleoNode == null) {
        throw new WorkflowException("Unable to find source node " + transition.getSourceNode());
      }
      KaleoNode targetKaleoNode=kaleoNodesMap.get(transition.getTargetNode().getName());
      if (targetKaleoNode == null) {
        throw new WorkflowException("Unable to find target node " + transition.getTargetNode());
      }
      KaleoTransitionLocalServiceUtil.addKaleoTransition(kaleoNode.getKaleoDefinitionId(),kaleoNode.getKaleoNodeId(),transition,sourceKaleoNode,targetKaleoNode,serviceContext);
    }
  }
  String startKaleoNodeName=definition.getInitialState().getName();
  KaleoNode kaleoNode=kaleoNodesMap.get(startKaleoNodeName);
  KaleoDefinitionLocalServiceUtil.activateKaleoDefinition(kaleoDefinitionId,kaleoNode.getKaleoNodeId(),serviceContext);
  return new WorkflowDefinitionAdapter(kaleoDefinition);
}
