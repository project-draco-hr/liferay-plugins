{
  User user=userPersistence.findByPrimaryKey(userId);
  long groupId=serviceContext.getScopeGroupId();
  Date now=new Date();
  validate(title,content);
  long kbTemplateId=counterLocalService.increment();
  KBTemplate kbTemplate=kbTemplatePersistence.create(kbTemplateId);
  kbTemplate.setUuid(serviceContext.getUuid());
  kbTemplate.setGroupId(groupId);
  kbTemplate.setCompanyId(user.getCompanyId());
  kbTemplate.setUserId(user.getUserId());
  kbTemplate.setUserName(user.getFullName());
  kbTemplate.setCreateDate(serviceContext.getCreateDate(now));
  kbTemplate.setModifiedDate(serviceContext.getModifiedDate(now));
  kbTemplate.setTitle(title);
  kbTemplate.setContent(content);
  kbTemplate.setDescription(description);
  kbTemplatePersistence.update(kbTemplate,false);
  if (serviceContext.getAddCommunityPermissions() || serviceContext.getAddGuestPermissions()) {
    addKBTemplateResources(kbTemplate,serviceContext.getAddCommunityPermissions(),serviceContext.getAddGuestPermissions());
  }
 else {
    addKBTemplateResources(kbTemplate,serviceContext.getCommunityPermissions(),serviceContext.getGuestPermissions());
  }
  socialActivityLocalService.addActivity(userId,groupId,KBTemplate.class.getName(),kbTemplateId,AdminActivityKeys.ADD_KB_TEMPLATE,StringPool.BLANK,0);
  return kbTemplate;
}
