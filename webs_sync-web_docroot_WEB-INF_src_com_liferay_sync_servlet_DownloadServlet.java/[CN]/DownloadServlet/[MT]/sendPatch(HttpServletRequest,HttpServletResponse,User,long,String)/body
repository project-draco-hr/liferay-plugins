{
  FileEntry fileEntry=DLAppServiceUtil.getFileEntryByUuidAndGroupId(uuid,groupId);
  String sourceVersion=ParamUtil.getString(request,"sourceVersion");
  if (Validator.isNull(sourceVersion)) {
    throw new IllegalArgumentException("Missing source version");
  }
  String destinationVersion=ParamUtil.getString(request,"destinationVersion");
  if (Validator.isNull(destinationVersion)) {
    throw new IllegalArgumentException("Missing destination version");
  }
  DLFileVersion sourceFileVersion=DLFileVersionLocalServiceUtil.getFileVersion(fileEntry.getFileEntryId(),sourceVersion);
  DLFileVersion destinationFileVersion=DLFileVersionLocalServiceUtil.getFileVersion(fileEntry.getFileEntryId(),destinationVersion);
  if (!PortletPropsValues.SYNC_FILE_DIFF_CACHE_ENABLED) {
    File deltaFile=getDeltaFile(user.getUserId(),fileEntry.getFileEntryId(),sourceVersion,destinationVersion);
    ServletResponseUtil.write(response,new FileInputStream(deltaFile),deltaFile.length());
    return;
  }
  SyncDLFileVersionDiff syncDLFileVersionDiff=SyncDLFileVersionDiffLocalServiceUtil.fetchSyncDLFileVersionDiff(fileEntry.getFileEntryId(),sourceFileVersion.getFileVersionId(),destinationFileVersion.getFileVersionId());
  if (syncDLFileVersionDiff != null) {
    SyncDLFileVersionDiffLocalServiceUtil.refreshExpirationDate(syncDLFileVersionDiff.getSyncDLFileVersionDiffId());
  }
 else {
    File deltaFile=getDeltaFile(user.getUserId(),fileEntry.getFileEntryId(),sourceVersion,destinationVersion);
    syncDLFileVersionDiff=SyncDLFileVersionDiffLocalServiceUtil.addSyncDLFileVersionDiff(fileEntry.getFileEntryId(),sourceFileVersion.getFileVersionId(),destinationFileVersion.getFileVersionId(),deltaFile);
  }
  FileEntry dataFileEntry=PortletFileRepositoryUtil.getPortletFileEntry(syncDLFileVersionDiff.getDataFileEntryId());
  ServletResponseUtil.write(response,dataFileEntry.getContentStream(),dataFileEntry.getSize());
}
