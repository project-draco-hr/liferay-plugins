{
  User user=userPersistence.findByPrimaryKey(serviceContext.getUserId());
  Date now=new Date();
  long kaleoInstanceId=counterLocalService.increment();
  KaleoInstance kaleoInstance=kaleoInstancePersistence.create(kaleoInstanceId);
  kaleoInstance.setGroupId(serviceContext.getScopeGroupId());
  kaleoInstance.setCompanyId(user.getCompanyId());
  kaleoInstance.setUserId(user.getUserId());
  kaleoInstance.setUserName(user.getFullName());
  kaleoInstance.setCreateDate(now);
  kaleoInstance.setModifiedDate(now);
  kaleoInstance.setClassName((String)workflowContext.get(WorkflowConstants.CONTEXT_ENTRY_CLASS_NAME));
  if (workflowContext.containsKey(WorkflowConstants.CONTEXT_ENTRY_CLASS_PK)) {
    kaleoInstance.setClassPK(Long.parseLong((String)workflowContext.get(WorkflowConstants.CONTEXT_ENTRY_CLASS_PK)));
  }
  kaleoInstance.setKaleoDefinitionId(kaleoDefinitionId);
  kaleoInstance.setKaleoDefinitionName(kaleoDefinitionName);
  kaleoInstance.setKaleoDefinitionVersion(kaleoDefinitionVersion);
  kaleoInstance.setCompleted(false);
  kaleoInstance.setWorkflowContext(WorkflowContextUtil.convert(workflowContext));
  kaleoInstancePersistence.update(kaleoInstance,false);
  return kaleoInstance;
}
